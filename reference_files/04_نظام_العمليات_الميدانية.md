# ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ (Field Operations System)

> **ุขุฎุฑ ุชุญุฏูุซ:** ุฏูุณูุจุฑ 2024
> **ุงูุญุงูุฉ:** ุชุตููู ููุงุฆู

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุฏูุฑ ุฌููุน ุงูุฃูุดุทุฉ ุงูููุฏุงููุฉ ูู ุชุฎุทูุท ูุชูููุฐ ููุชุงุจุนุฉุ ููุดูู:
1. **ุงููุญุฑู ุงูุฃุณุงุณู** ููุนูููุงุช ุงูููุญุฏุฉ
2. **ุฅุฏุงุฑุฉ ุงูุฎุทุท ูุงูุฌุฏุงูู** ุงูููุฏุงููุฉ
3. **ุฅุฏุงุฑุฉ ุงููุฑู ูุงูุนุงูููู** ุงูููุฏุงูููู
4. **ุฅุฏุงุฑุฉ ุงูููุงุฏ ูุงููุนุฏุงุช** ุงูููุฏุงููุฉ
5. **ุงููุญุต ูุงููุจูู** ููุนูููุงุช
6. **ุงูุฏูุน ูุงูุชุณููุฉ** ุงูููุฏุงููุฉ

**ุงูุฑุจุท ุงููุญุงุณุจู:** ูุฑุชุจุท ุจุดุฌุฑุฉ ุงูุญุณุงุจุงุช ูู ุงููุธุงู ุงูุฃู ุนุจุฑ ุญุณุงุจุงุช ุงููุตุฑููุงุช ุงูููุฏุงููุฉ ูุงูุนูุฏ.

---

## ๐๏ธ ูููู ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ

```
ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ
โ
โโโ 1๏ธโฃ ุงููุญุฑู ุงูุฃุณุงุณู (Core Engine)
โ   โโโ ุฃููุงุน ุงูุนูููุงุช
โ   โโโ ุญุงูุงุช ุงูุนูููุฉ
โ   โโโ ุณูุฑ ุงูุนูู (Workflow)
โ   โโโ ุงูููุงุนุฏ ูุงูุณูุงุณุงุช
โ
โโโ 2๏ธโฃ ุฅุฏุงุฑุฉ ุงูุฎุทุท ูุงูุฌุฏุงูู
โ   โโโ ุฅูุดุงุก ุงูุฎุทุท
โ   โโโ ุงูุฌุฏุงูู ูุงูููุงุนูุฏ
โ   โโโ ุชุนููู ุงูููุงุฑุฏ
โ   โโโ ุงููุชุงุจุนุฉ ูุงูุชุชุจุน
โ
โโโ 3๏ธโฃ ุฅุฏุงุฑุฉ ุงููุฑู ูุงูุนุงูููู
โ   โโโ ุฅุฏุงุฑุฉ ุงููุฑู
โ   โโโ ุชุชุจุน ุงููููุน ุงููุนูู
โ   โโโ ุชูููู ุงูุฃุฏุงุก
โ   โโโ ุงูุญูุงูุฒ ูุงูููุงูุขุช
โ
โโโ 4๏ธโฃ ุฅุฏุงุฑุฉ ุงูููุงุฏ ูุงููุนุฏุงุช
โ   โโโ ุชูุฒูุน ุงูููุงุฏ
โ   โโโ ุชุชุจุน ุงููุนุฏุงุช
โ   โโโ ุตูุงูุฉ ุงููุนุฏุงุช
โ   โโโ ุงูุฅุฑุฌุงุน ูุงูุงุณุชุฑุฌุงุน
โ
โโโ 5๏ธโฃ ุงููุญุต ูุงููุจูู
โ   โโโ ุงููุญุต ุงูููุฏุงูู
โ   โโโ ุงููุจูู ูุงูุฑูุถ
โ   โโโ ุงูููุงููุงุช ูุงูุชูููุนุงุช
โ   โโโ ุฅุฏุงุฑุฉ ุงูููุงุญุธุงุช
โ
โโโ 6๏ธโฃ ุงูุฏูุน ูุงูุชุณููุฉ
    โโโ ุญุณุงุจ ุงูุฃุฌูุฑ ูุงููุณุชุญูุงุช
    โโโ ุงูุฏูุน ุงูููุฏุงูู
    โโโ ุงูุฎุตููุงุช ูุงูุนููุจุงุช
    โโโ ุงูุชุณููุฉ ูุงูุชูุงุฑูุฑ
```

---

## ๐ ุงูุฑุจุท ุจุงูุฃูุธูุฉ ุงูุฃุฎุฑู

| ุงููุธุงู | ููุน ุงูุฑุจุท | ุงููุตู |
|--------|-----------|-------|
| ุงููุธุงู ุงูุฃู | ูุญุงุณุจู | ูููุฏ ุงููุตุฑููุงุช ูุงูุนูุฏ |
| ูุธุงู ุงูุฃุตูู | ุชุดุบููู | ุนูููุงุช ุงูุตูุงูุฉ ูุงูุชุฑููุจ |
| ูุธุงู ุงููุฎุฒูู | ุชุดุบููู | ุตุฑู ุงูููุงุฏ ููุทุน ุงูุบูุงุฑ |
| ูุธุงู ุงูุนููุงุก | ุชุดุบููู | ุนูููุงุช ุงูุชุฑููุจ ูุงููุตู ูุงูุตูุงูุฉ |
| ูุธุงู ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ | ุจูุงูุงุช | ุจูุงูุงุช ุงูููุธููู ูุงูููููู |

---

# 1๏ธโฃ ุงููุญุฑู ุงูุฃุณุงุณู (Core Engine)

## ๐ฏ ุงูุบุฑุถ

ุงููุญุฑู ุงูุฃุณุงุณู ูู ุงูููุงุฉ ุงูููุญุฏุฉ ุงูุชู ุชุฏูุฑ ุฌููุน ุฃููุงุน ุงูุนูููุงุช ุงูููุฏุงููุฉ ุจุณูุฑ ุนูู ููุญุฏ.

## ๐ ุฃููุงุน ุงูุนูููุงุช ุงูููุฏุงููุฉ

| ุงูููุน | ุงููุตู | ูุซุงู |
|-------|-------|------|
| `installation` | ุชุฑููุจ ุฌุฏูุฏ | ุชุฑููุจ ุนุฏุงุฏุ ุชูุตูู ูุดุชุฑู |
| `maintenance` | ุตูุงูุฉ | ุตูุงูุฉ ุฏูุฑูุฉุ ุฅุตูุงุญ ุนุทู |
| `inspection` | ูุญุต | ูุญุต ุฏูุฑูุ ูุฑุงุกุฉ ุนุฏุงุฏ |
| `disconnection` | ูุตู | ูุตู ูุคูุชุ ูุตู ููุงุฆู |
| `reconnection` | ุฅุนุงุฏุฉ ุชูุตูู | ุฅุนุงุฏุฉ ุชูุตูู ุจุนุฏ ุงูุณุฏุงุฏ |
| `meter_reading` | ูุฑุงุกุฉ ุนุฏุงุฏุงุช | ูุฑุงุกุฉ ุดูุฑูุฉ |
| `collection` | ุชุญุตูู | ุชุญุตูู ููุฏุงูู |

## ๐ ุญุงูุงุช ุงูุนูููุฉ

```
โโโโโโโโโโโ    โโโโโโโโโโโโ    โโโโโโโโโโโโโโ    โโโโโโโโโโโโโ
โ ูุณูุฏุฉ   โโโโโถโ ูุฌุฏููุฉ   โโโโโถโ ููุฏ ุงูุชูููุฐโโโโโถโ ููุชููุฉ    โ
โ Draft   โ    โ Scheduledโ    โ In Progressโ    โ Completed โ
โโโโโโโโโโโ    โโโโโโโโโโโโ    โโโโโโโโโโโโโโ    โโโโโโโโโโโโโ
                    โ                โ                 โ
                    โผ                โผ                 โผ
               โโโโโโโโโโโ    โโโโโโโโโโโโโ    โโโโโโโโโโโโโ
               โ ููุบุงุฉ   โ    โ ูุนููุฉ     โ    โ ูุฑููุถุฉ    โ
               โCancelledโ    โ On Hold   โ    โ Rejected  โ
               โโโโโโโโโโโ    โโโโโโโโโโโโโ    โโโโโโโโโโโโโ
```

## ๐ ุงูุฌุฏุงูู

### ุฌุฏูู ุงูุนูููุงุช ุงูููุฏุงููุฉ: `field_operations`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| station_id | UUID | ุงููุญุทุฉ |
| operation_number | VARCHAR(20) | ุฑูู ุงูุนูููุฉ (ุชุณูุณูู) |
| operation_type | ENUM | ููุน ุงูุนูููุฉ |
| status | ENUM | ุญุงูุฉ ุงูุนูููุฉ |
| priority | ENUM | ุงูุฃููููุฉ (low, medium, high, urgent) |
| title | VARCHAR(255) | ุนููุงู ุงูุนูููุฉ |
| description | TEXT | ูุตู ุงูุนูููุฉ |
| reference_type | VARCHAR(50) | ููุน ุงููุฑุฌุน (customer, asset, etc) |
| reference_id | UUID | ูุนุฑู ุงููุฑุฌุน |
| location_lat | DECIMAL | ุฎุท ุงูุนุฑุถ |
| location_lng | DECIMAL | ุฎุท ุงูุทูู |
| address | TEXT | ุงูุนููุงู |
| scheduled_date | DATE | ุงูุชุงุฑูุฎ ุงููุฌุฏูู |
| scheduled_time | TIME | ุงูููุช ุงููุฌุฏูู |
| started_at | TIMESTAMP | ููุช ุงูุจุฏุก ุงููุนูู |
| completed_at | TIMESTAMP | ููุช ุงูุฅููุงู |
| assigned_team_id | UUID | ุงููุฑูู ุงููุนูู |
| assigned_worker_id | UUID | ุงูุนุงูู ุงููุนูู |
| estimated_duration | INT | ุงููุฏุฉ ุงูููุฏุฑุฉ (ุฏูุงุฆู) |
| actual_duration | INT | ุงููุฏุฉ ุงููุนููุฉ (ุฏูุงุฆู) |
| notes | TEXT | ููุงุญุธุงุช |
| created_by | UUID | ุงูููุดุฆ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |
| updated_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุชุญุฏูุซ |

### ุฌุฏูู ุณุฌู ุญุงูุงุช ุงูุนูููุฉ: `operation_status_log`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| operation_id | UUID | ุงูุนูููุฉ |
| from_status | ENUM | ุงูุญุงูุฉ ุงูุณุงุจูุฉ |
| to_status | ENUM | ุงูุญุงูุฉ ุงูุฌุฏูุฏุฉ |
| changed_by | UUID | ูู ูุงู ุจุงูุชุบููุฑ |
| changed_at | TIMESTAMP | ููุช ุงูุชุบููุฑ |
| reason | TEXT | ุงูุณุจุจ |
| notes | TEXT | ููุงุญุธุงุช |

### ุฌุฏูู ุจูุงูุงุช ุงูุชุฑููุจ ุงููููุฉ: `installation_details`

> **ุงูุบุฑุถ:** ุชูุซูู ุงูุจูุงูุงุช ุงููููุฉ ูุนูููุงุช ุชุฑููุจ ุงูุนุฏุงุฏุงุช

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| operation_id | UUID | ุนูููุฉ ุงูุชุฑููุจ (FK) |
| customer_id | UUID | ุงูุนููู (FK) |
| meter_serial_number | VARCHAR(100) | ุงูุฑูู ุงูุชุณูุณูู ููุนุฏุงุฏ |
| meter_type | ENUM | ููุน ุงูุนุฏุงุฏ (smart, traditional) |
| **ุจูุงูุงุช ุงูุฎุชู** | | |
| seal_number | VARCHAR(50) | ุฑูู ุงูุฎุชู |
| seal_color | VARCHAR(30) | ููู ุงูุฎุชู |
| seal_type | VARCHAR(50) | ููุน ุงูุฎุชู |
| **ุจูุงูุงุช ุงููุงุทุน** | | |
| breaker_type | VARCHAR(50) | ููุน ุงููุงุทุน |
| breaker_capacity | VARCHAR(20) | ุณุนุฉ ุงููุงุทุน (ุฃูุจูุฑ) |
| breaker_brand | VARCHAR(50) | ูุงุฑูุฉ ุงููุงุทุน |
| **ุจูุงูุงุช ุงูุฃุณูุงู** | | |
| cable_length | DECIMAL(10,2) | ุทูู ุงูุณูู (ูุชุฑ) |
| cable_type | VARCHAR(50) | ููุน ุงูุณูู |
| cable_size | VARCHAR(20) | ููุงุณ ุงูุณูู (mmยฒ) |
| **ุงููุฑุงุกุฉ ุงูุงุจุชุฏุงุฆูุฉ** | | |
| initial_reading | DECIMAL(15,3) | ุงููุฑุงุกุฉ ุงูุงุจุชุฏุงุฆูุฉ ููุนุฏุงุฏ |
| **ุงูุชูููุช** | | |
| installation_date | DATE | ุชุงุฑูุฎ ุงูุชุฑููุจ |
| installation_time | TIME | ููุช ุงูุชุฑููุจ |
| technician_id | UUID | ุงูููู ุงููููุฐ |
| **ุงูููุงุญุธุงุช** | | |
| notes | TEXT | ููุงุญุธุงุช ุงูููู |
| customer_signature | VARCHAR(500) | ุชูููุน ุงูุนููู (ุตูุฑุฉ) |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุตูุฑ ุงูุชุฑููุจ: `installation_photos`

> **ุงูุบุฑุถ:** ุชูุซูู ุนูููุฉ ุงูุชุฑููุจ ุจุงูุตูุฑ

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| installation_id | UUID | ุจูุงูุงุช ุงูุชุฑููุจ (FK) |
| operation_id | UUID | ุงูุนูููุฉ (FK) |
| photo_type | ENUM | ููุน ุงูุตูุฑุฉ |
| photo_url | VARCHAR(500) | ุฑุงุจุท ุงูุตูุฑุฉ |
| caption | VARCHAR(200) | ูุตู ุงูุตูุฑุฉ |
| latitude | DECIMAL(10,8) | ุฎุท ุงูุนุฑุถ (ูููุน ุงูุชูุงุท ุงูุตูุฑุฉ) |
| longitude | DECIMAL(11,8) | ุฎุท ุงูุทูู |
| captured_at | TIMESTAMP | ููุช ุงูุชูุงุท ุงูุตูุฑุฉ |
| uploaded_by | UUID | ุงูููู ุงูุฐู ุฑูุน ุงูุตูุฑุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฑูุน |

**ุฃููุงุน ุตูุฑ ุงูุชุฑููุจ (photo_type):**
| ุงูููุน | ุงููุตู |
|-------|-------|
| meter_front | ุตูุฑุฉ ุงูุนุฏุงุฏ ูู ุงูุฃูุงู |
| meter_reading | ุตูุฑุฉ ุงููุฑุงุกุฉ ุงูุงุจุชุฏุงุฆูุฉ |
| seal | ุตูุฑุฉ ุงูุฎุชู |
| breaker | ุตูุฑุฉ ุงููุงุทุน |
| wiring | ุตูุฑุฉ ุงูุชูุตููุงุช |
| location | ุตูุฑุฉ ุงููููุน |
| customer_premises | ุตูุฑุฉ ูุจูู ุงูุนููู |
| before_installation | ุตูุฑุฉ ูุจู ุงูุชุฑููุจ |
| after_installation | ุตูุฑุฉ ุจุนุฏ ุงูุชุฑููุจ |

### ุญุงูุฉ "ุจุงูุชุธุงุฑ ุงูุณูู ูู ุงูุนููู"

> **ุงูุบุฑุถ:** ุญุงูุฉ ุฎุงุตุฉ ุนูุฏูุง ูุญุชุงุฌ ุงูุนููู ูุชูููุฑ ุงูุณูู

**ุญุงูุงุช ุงูุนูููุฉ ุงูููุณุนุฉ:**
| ุงูุญุงูุฉ | ุงููุตู |
|--------|-------|
| draft | ูุณูุฏุฉ |
| scheduled | ูุฌุฏููุฉ |
| assigned | ูุณูุฏุฉ ูููู |
| in_progress | ุฌุงุฑู ุงูุชูููุฐ |
| **waiting_customer_cable** | **ุจุงูุชุธุงุฑ ุชูููุฑ ุงูุณูู ูู ุงูุนููู** |
| on_hold | ูุนููุฉ |
| completed | ููุชููุฉ |
| cancelled | ููุบุงุฉ |

### Trigger: ุชูุนูู ุงูุนุฏุงุฏ ุนูุฏ ุฅููุงู ุงูุชุฑููุจ

```sql
CREATE OR REPLACE FUNCTION on_installation_completed()
RETURNS TRIGGER AS $$
DECLARE
    v_customer_id UUID;
    v_meter_serial VARCHAR(100);
BEGIN
    -- ููุท ุนูุฏ ุงูุงูุชูุงู ูุญุงูุฉ "completed" ูููุน ุงูุนูููุฉ "installation"
    IF NEW.status = 'completed' AND OLD.status != 'completed' 
       AND NEW.operation_type = 'installation' THEN
        
        -- ุฌูุจ ุจูุงูุงุช ุงูุชุฑููุจ
        SELECT customer_id, meter_serial_number 
        INTO v_customer_id, v_meter_serial
        FROM installation_details 
        WHERE operation_id = NEW.id;
        
        -- 1. ุชูุนูู ุงูุนููู ูู ูุธุงู ุงูููุชุฑุฉ
        UPDATE customers SET
            status = 'active',
            connection_date = CURRENT_DATE,
            updated_at = NOW()
        WHERE id = v_customer_id;
        
        -- 2. ุชุญุฏูุซ ุญุงูุฉ ุงูุนุฏุงุฏ ุฅูู "ูุฑูุจ"
        UPDATE meter_status_tracking SET
            current_status = 'installed',
            customer_id = v_customer_id,
            installation_date = CURRENT_DATE,
            installation_operation_id = NEW.id,
            updated_at = NOW()
        WHERE serial_number = v_meter_serial;
        
        -- 3. ุชุญุฏูุซ ุทูุจ ุงูุงุดุชุฑุงู ุฅูู "ููุชูู"
        UPDATE subscription_requests SET
            status = 'completed',
            completion_date = NOW(),
            customer_id = v_customer_id,
            updated_at = NOW()
        WHERE operation_id = NEW.id;
        
        -- 4. ุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู
        -- PERFORM send_notification(v_customer_id, 'installation_completed');
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_installation_completed
    AFTER UPDATE ON field_operations
    FOR EACH ROW
    EXECUTE FUNCTION on_installation_completed();
```

### APIs ุนูููุงุช ุงูุชุฑููุจ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | /api/v1/installations/:operation_id/details | ุญูุธ ุจูุงูุงุช ุงูุชุฑููุจ ุงููููุฉ |
| POST | /api/v1/installations/:operation_id/photos | ุฑูุน ุตูุฑ ุงูุชุฑููุจ |
| PUT | /api/v1/operations/:id/status | ุชุญุฏูุซ ุญุงูุฉ ุงูุนูููุฉ |
| GET | /api/v1/installations/:operation_id | ุฌูุจ ุชูุงุตูู ุงูุชุฑููุจ ุงููุงููุฉ |

---

## 1.6 ุณูุฑ ุนูู ุงุณุชุจุฏุงู ุงูููููุงุช (Component Replacement Workflow)

> **ุงูุบุฑุถ:** ุชูููู ุงูููู ูู ุงุณุชุจุฏุงู ุฃู ูููู (ุนุฏุงุฏุ ูุงุทุนุ ุฎุชู) ุจุณูููุฉ ูุน ุชูุซูู ูุงูู

### 1.6.1 ุนุฑุถ ุงูููููุงุช ุงูุญุงููุฉ ููุนููู

**ุนูุฏูุง ููุชุญ ุงูููู ุฃูุฑ ุนูู ุตูุงูุฉุ ูุฑู:**

| ุงููููู | ุงูุฑูู ุงูุชุณูุณูู | ุงูููุฏูู | ุชุงุฑูุฎ ุงูุชุฑููุจ | ุงูุฅุฌุฑุงุก |
|--------|------------------|---------|---------------|--------|
| ุงูุนุฏุงุฏ | ADL200-WF-001234 | ADL200-WF | 2024-01-15 | [ุงุณุชุจุฏุงู] |
| ุงููุงุทุน | CB-2024-005678 | 32A-2P | 2024-01-15 | [ุงุณุชุจุฏุงู] |
| ุงูุฎุชู | SEAL-2024-009012 | ุฃุญูุฑ | 2024-01-15 | [ุงุณุชุจุฏุงู] |

### 1.6.2 ุณูุฑ ุนูู ุงุณุชุจุฏุงู ุนุฏุงุฏ

**ุงูุฎุทูุงุช:**
1. ุงูุถุบุท ุนูู [ุงุณุชุจุฏุงู] ุจุฌุงูุจ ุงูุนุฏุงุฏ
2. ูุณุญ (Scan) ุงูุฑูู ุงูุชุณูุณูู ููุนุฏุงุฏ ุงูุฌุฏูุฏ (ุงููุงููุฑุง ุชูุชุญ ููุณุญ ุงูุจุงุฑููุฏ/QR)
3. ูุณุญ (Scan) ุงูุฑูู ุงูุชุณูุณูู ููุนุฏุงุฏ ุงููุฏูู/ุงูุชุงูู (ููุชุฃูุฏ)
4. ุงุฎุชูุงุฑ ุณุจุจ ุงูุชูู (ุนุทู ูููุ ุชูู ุจุณุจุจ ุงูุนูููุ ุชุฑููุฉุ ุตูุงูุฉ ุฏูุฑูุฉ)
5. ุฅุถุงูุฉ ููุงุญุธุงุช (ุงุฎุชูุงุฑู)
6. ุงูุชูุงุท ุตูุฑุฉ ููุนุฏุงุฏ ุงูุฌุฏูุฏ ุจุนุฏ ุงูุชุฑููุจ
7. ุชุฃููุฏ ุงูุงุณุชุจุฏุงู

### 1.6.3 ููุทู "ูุง ุชุบููุฑ"

> **ููู:** ุฅุฐุง ูู ูุชุบูุฑ ูููู ูุนููุ ูุง ูุชุฎุฐ ุงูููู ุฃู ุฅุฌุฑุงุก ุจุดุฃูู

**ูุซุงู:** ุงุณุชุจุฏุงู ุงูุนุฏุงุฏ ูุงูุฎุชู ููุทุ ุงููุงุทุน ูู ูุชุบูุฑ:
- ุงูุนุฏุงุฏ: [ุชู ุงูุงุณุชุจุฏุงู โ]
- ุงููุงุทุน: [ูุง ุชุบููุฑ โ]
- ุงูุฎุชู: [ุชู ุงูุงุณุชุจุฏุงู โ]

### 1.6.4 ุณูุฑ ุนูู ุฅุฑุฌุงุน ุงูููููุงุช ุงูุชุงููุฉ ูููุฎุฒู

1. ุจุนุฏ ุฅููุงู ุงูุงุณุชุจุฏุงู: ุงููููู ุงููุฏูู ูุธูุฑ ูู ูุงุฆูุฉ "ุจุงูุชุธุงุฑ ุงูุฅุฑุฌุงุน"
2. ุงูููู ูุนูุฏ ุงููููู ูููุฎุฒู
3. ุฃููู ุงููุฎุฒู ูุณุชูู ูููุณุญ ุงูุจุงุฑููุฏ
4. ุงููุธุงู ูุญุฏุซ ุญุงูุฉ ุงููููู ุฅูู "ุชุงูู - ูู ุงููุฎุฒู"
5. ูุธูุฑ ูู ูุงุฆูุฉ "ุงููุฎุฒูู ุงูุชุงูู" ูุงุชุฎุงุฐ ูุฑุงุฑ

### 1.6.5 APIs ุนูููุงุช ุงูุงุณุชุจุฏุงู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | /api/v1/work-orders/:id/components | ุฌูุจ ุงูููููุงุช ุงูุญุงููุฉ ููุนููู |
| POST | /api/v1/replacements/scan-new | ูุณุญ ุงูุฑูู ุงูุชุณูุณูู ูููููู ุงูุฌุฏูุฏ |
| POST | /api/v1/replacements/scan-old | ูุณุญ ุงูุฑูู ุงูุชุณูุณูู ูููููู ุงููุฏูู |
| POST | /api/v1/replacements/confirm | ุชุฃููุฏ ุนูููุฉ ุงูุงุณุชุจุฏุงู |
| POST | /api/v1/replacements/:id/photo | ุฑูุน ุตูุฑุฉ ุงููููู ุงูุฌุฏูุฏ |
| PUT | /api/v1/work-orders/:id/complete | ุฅููุงู ุฃูุฑ ุงูุนูู |

---

# 2๏ธโฃ ุฅุฏุงุฑุฉ ุงูุฎุทุท ูุงูุฌุฏุงูู

## ๐ฏ ุงูุบุฑุถ

ุชุฎุทูุท ูุฌุฏููุฉ ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุชูุฒูุนูุง ุนูู ุงููุฑู ูุงูุนุงูููู.

## ๐ ุงูุฌุฏุงูู

### ุฌุฏูู ุงูุฎุทุท ุงูููุฏุงููุฉ: `field_plans`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| station_id | UUID | ุงููุญุทุฉ (ุงุฎุชูุงุฑู) |
| plan_number | VARCHAR(20) | ุฑูู ุงูุฎุทุฉ |
| name | VARCHAR(255) | ุงุณู ุงูุฎุทุฉ |
| description | TEXT | ุงููุตู |
| plan_type | ENUM | ููุน ุงูุฎุทุฉ (daily, weekly, monthly, custom) |
| start_date | DATE | ุชุงุฑูุฎ ุงูุจุฏุงูุฉ |
| end_date | DATE | ุชุงุฑูุฎ ุงูููุงูุฉ |
| status | ENUM | ุงูุญุงูุฉ (draft, active, completed, cancelled) |
| operations_count | INT | ุนุฏุฏ ุงูุนูููุงุช |
| completed_count | INT | ุนุฏุฏ ุงูููุชููุฉ |
| created_by | UUID | ุงูููุดุฆ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุนูููุงุช ุงูุฎุทุฉ: `plan_operations`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| plan_id | UUID | ุงูุฎุทุฉ |
| operation_id | UUID | ุงูุนูููุฉ |
| sequence | INT | ุงูุชุฑุชูุจ |
| scheduled_date | DATE | ุงูุชุงุฑูุฎ ุงููุฌุฏูู |
| scheduled_time | TIME | ุงูููุช ุงููุฌุฏูู |

### ุฌุฏูู ุงูุฌุฏุงูู ุงูุฒูููุฉ: `schedules`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| team_id | UUID | ุงููุฑูู |
| worker_id | UUID | ุงูุนุงูู |
| schedule_date | DATE | ุงูุชุงุฑูุฎ |
| start_time | TIME | ููุช ุงูุจุฏุงูุฉ |
| end_time | TIME | ููุช ุงูููุงูุฉ |
| status | ENUM | ุงูุญุงูุฉ |
| notes | TEXT | ููุงุญุธุงุช |

---

# 3๏ธโฃ ุฅุฏุงุฑุฉ ุงููุฑู ูุงูุนุงูููู

## ๐ฏ ุงูุบุฑุถ

ุฅุฏุงุฑุฉ ุงููุฑู ุงูููุฏุงููุฉ ูุงูุนุงูููู ูุชุชุจุน ููุงูุนูู ูุฃุฏุงุฆูู.

## ๐ ุงูุฌุฏุงูู

### ุฌุฏูู ุงููุฑู ุงูููุฏุงููุฉ: `field_teams`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| station_id | UUID | ุงููุญุทุฉ |
| name | VARCHAR(255) | ุงุณู ุงููุฑูู |
| code | VARCHAR(20) | ููุฏ ุงููุฑูู |
| team_leader_id | UUID | ูุงุฆุฏ ุงููุฑูู |
| specialization | ENUM | ุงูุชุฎุตุต (installation, maintenance, collection, etc) |
| max_capacity | INT | ุงูุณุนุฉ ุงููุตูู (ุนูููุงุช/ููู) |
| is_active | BOOLEAN | ูุดุท |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุฃุนุถุงุก ุงููุฑูู: `team_members`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| team_id | UUID | ุงููุฑูู |
| worker_id | UUID | ุงูุนุงูู |
| role | ENUM | ุงูุฏูุฑ (leader, member, trainee) |
| joined_at | DATE | ุชุงุฑูุฎ ุงูุงูุถูุงู |
| left_at | DATE | ุชุงุฑูุฎ ุงููุบุงุฏุฑุฉ |
| is_active | BOOLEAN | ูุดุท |

### ุฌุฏูู ุงูุนุงูููู ุงูููุฏุงูููู: `field_workers`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| user_id | UUID | ุงููุณุชุฎุฏู (FK) |
| employee_id | UUID | ุงูููุธู (FK - ูุธุงู HR) |
| worker_code | VARCHAR(20) | ููุฏ ุงูุนุงูู |
| name | VARCHAR(255) | ุงูุงุณู |
| phone | VARCHAR(20) | ุฑูู ุงููุงุชู |
| specializations | JSON | ุงูุชุฎุตุตุงุช |
| skills | JSON | ุงูููุงุฑุงุช |
| rating | DECIMAL(3,2) | ุงูุชูููู (0-5) |
| total_operations | INT | ุฅุฌูุงูู ุงูุนูููุงุช |
| completed_operations | INT | ุงูุนูููุงุช ุงูููุชููุฉ |
| is_available | BOOLEAN | ูุชุงุญ |
| current_location_lat | DECIMAL | ุงููููุน ุงูุญุงูู (ุฎุท ุงูุนุฑุถ) |
| current_location_lng | DECIMAL | ุงููููุน ุงูุญุงูู (ุฎุท ุงูุทูู) |
| last_location_update | TIMESTAMP | ุขุฎุฑ ุชุญุฏูุซ ูููููุน |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุณุฌู ุงูููุงูุน: `worker_location_log`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| worker_id | UUID | ุงูุนุงูู |
| latitude | DECIMAL | ุฎุท ุงูุนุฑุถ |
| longitude | DECIMAL | ุฎุท ุงูุทูู |
| accuracy | DECIMAL | ุงูุฏูุฉ (ูุชุฑ) |
| recorded_at | TIMESTAMP | ููุช ุงูุชุณุฌูู |
| source | ENUM | ุงููุตุฏุฑ (app, device) |

### ุฌุฏูู ุชูููู ุงูุฃุฏุงุก: `worker_performance`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| worker_id | UUID | ุงูุนุงูู |
| period_start | DATE | ุจุฏุงูุฉ ุงููุชุฑุฉ |
| period_end | DATE | ููุงูุฉ ุงููุชุฑุฉ |
| total_operations | INT | ุฅุฌูุงูู ุงูุนูููุงุช |
| completed_on_time | INT | ุงูููุชููุฉ ูู ุงูููุช |
| completed_late | INT | ุงููุชุฃุฎุฑุฉ |
| rejected | INT | ุงููุฑููุถุฉ |
| average_duration | INT | ูุชูุณุท ุงููุฏุฉ (ุฏูุงุฆู) |
| customer_rating | DECIMAL(3,2) | ุชูููู ุงูุนููุงุก |
| quality_score | DECIMAL(3,2) | ุฏุฑุฌุฉ ุงูุฌูุฏุฉ |
| overall_score | DECIMAL(3,2) | ุงูุฏุฑุฌุฉ ุงูุฅุฌูุงููุฉ |
| notes | TEXT | ููุงุญุธุงุช |
| evaluated_by | UUID | ุงูููููู |
| evaluated_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุชูููู |

### ุฌุฏูู ุงูุญูุงูุฒ ูุงูููุงูุขุช: `worker_incentives`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| worker_id | UUID | ุงูุนุงูู |
| incentive_type | ENUM | ููุน ุงูุญุงูุฒ (bonus, commission, penalty) |
| amount | DECIMAL | ุงููุจูุบ |
| reason | TEXT | ุงูุณุจุจ |
| reference_type | VARCHAR(50) | ููุน ุงููุฑุฌุน |
| reference_id | UUID | ูุนุฑู ุงููุฑุฌุน |
| status | ENUM | ุงูุญุงูุฉ (pending, approved, paid, cancelled) |
| approved_by | UUID | ุงูููุงูู |
| approved_at | TIMESTAMP | ุชุงุฑูุฎ ุงูููุงููุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

---

# 4๏ธโฃ ุฅุฏุงุฑุฉ ุงูููุงุฏ ูุงููุนุฏุงุช

## ๐ฏ ุงูุบุฑุถ

ุฅุฏุงุฑุฉ ุงูููุงุฏ ูุงููุนุฏุงุช ุงููุณุชุฎุฏูุฉ ูู ุงูุนูููุงุช ุงูููุฏุงููุฉ.

## ๐ ุงูุฌุฏุงูู

### ุฌุฏูู ุทูุจุงุช ุตุฑู ุงูููุงุฏ: `material_requests`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| request_number | VARCHAR(20) | ุฑูู ุงูุทูุจ |
| operation_id | UUID | ุงูุนูููุฉ (ุงุฎุชูุงุฑู) |
| worker_id | UUID | ุงูุนุงูู ุงูุทุงูุจ |
| team_id | UUID | ุงููุฑูู |
| request_date | DATE | ุชุงุฑูุฎ ุงูุทูุจ |
| status | ENUM | ุงูุญุงูุฉ (pending, approved, issued, returned, cancelled) |
| notes | TEXT | ููุงุญุธุงุช |
| approved_by | UUID | ุงูููุงูู |
| approved_at | TIMESTAMP | ุชุงุฑูุฎ ุงูููุงููุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุจููุฏ ุทูุจ ุงูููุงุฏ: `material_request_items`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| request_id | UUID | ุงูุทูุจ |
| item_id | UUID | ุงูุตูู (FK - ูุธุงู ุงููุฎุฒูู) |
| requested_qty | DECIMAL | ุงููููุฉ ุงููุทููุจุฉ |
| approved_qty | DECIMAL | ุงููููุฉ ุงูููุงูู ุนูููุง |
| issued_qty | DECIMAL | ุงููููุฉ ุงููุตุฑููุฉ |
| returned_qty | DECIMAL | ุงููููุฉ ุงููุฑุชุฌุนุฉ |
| unit | VARCHAR(20) | ุงููุญุฏุฉ |
| notes | TEXT | ููุงุญุธุงุช |

### ุฌุฏูู ุงููุนุฏุงุช ุงูููุฏุงููุฉ: `field_equipment`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| equipment_code | VARCHAR(20) | ููุฏ ุงููุนุฏุฉ |
| name | VARCHAR(255) | ุงูุงุณู |
| type | ENUM | ุงูููุน (tool, vehicle, device) |
| serial_number | VARCHAR(100) | ุงูุฑูู ุงูุชุณูุณูู |
| status | ENUM | ุงูุญุงูุฉ (available, in_use, maintenance, retired) |
| current_holder_id | UUID | ุงูุญุงุฆุฒ ุงูุญุงูู |
| assigned_team_id | UUID | ุงููุฑูู ุงููุนูู |
| purchase_date | DATE | ุชุงุฑูุฎ ุงูุดุฑุงุก |
| warranty_end | DATE | ููุงูุฉ ุงูุถูุงู |
| last_maintenance | DATE | ุขุฎุฑ ุตูุงูุฉ |
| next_maintenance | DATE | ุงูุตูุงูุฉ ุงููุงุฏูุฉ |
| notes | TEXT | ููุงุญุธุงุช |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุญุฑูุงุช ุงููุนุฏุงุช: `equipment_movements`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| equipment_id | UUID | ุงููุนุฏุฉ |
| movement_type | ENUM | ููุน ุงูุญุฑูุฉ (checkout, return, transfer, maintenance) |
| from_holder_id | UUID | ูู |
| to_holder_id | UUID | ุฅูู |
| operation_id | UUID | ุงูุนูููุฉ (ุงุฎุชูุงุฑู) |
| movement_date | TIMESTAMP | ุชุงุฑูุฎ ุงูุญุฑูุฉ |
| condition_before | ENUM | ุงูุญุงูุฉ ูุจู |
| condition_after | ENUM | ุงูุญุงูุฉ ุจุนุฏ |
| notes | TEXT | ููุงุญุธุงุช |
| recorded_by | UUID | ุงููุณุฌู |

---

# 5๏ธโฃ ุงููุญุต ูุงููุจูู

## ๐ฏ ุงูุบุฑุถ

ูุญุต ุงูุนูููุงุช ุงููููุฐุฉ ูุงูููุงููุฉ ุนูููุง ุฃู ุฑูุถูุง.

## ๐ ุงูุฌุฏุงูู

### ุฌุฏูู ุงููุญูุตุงุช: `inspections`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| operation_id | UUID | ุงูุนูููุฉ |
| inspection_number | VARCHAR(20) | ุฑูู ุงููุญุต |
| inspection_type | ENUM | ููุน ุงููุญุต (quality, safety, completion) |
| inspector_id | UUID | ุงููุงุญุต |
| inspection_date | TIMESTAMP | ุชุงุฑูุฎ ุงููุญุต |
| status | ENUM | ุงูุญุงูุฉ (pending, passed, failed, conditional) |
| overall_score | DECIMAL(3,2) | ุงูุฏุฑุฌุฉ ุงูุฅุฌูุงููุฉ |
| notes | TEXT | ููุงุญุธุงุช |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุจููุฏ ุงููุญุต: `inspection_items`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| inspection_id | UUID | ุงููุญุต |
| checklist_item_id | UUID | ุจูุฏ ูุงุฆูุฉ ุงููุญุต |
| item_name | VARCHAR(255) | ุงุณู ุงูุจูุฏ |
| is_passed | BOOLEAN | ูุงุฌุญ/ูุงุดู |
| score | DECIMAL(3,2) | ุงูุฏุฑุฌุฉ |
| notes | TEXT | ููุงุญุธุงุช |
| photo_url | VARCHAR(500) | ุตูุฑุฉ (ุงุฎุชูุงุฑู) |

### ุฌุฏูู ููุงุฆู ุงููุญุต: `inspection_checklists`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| name | VARCHAR(255) | ุงุณู ุงููุงุฆูุฉ |
| operation_type | ENUM | ููุน ุงูุนูููุฉ |
| items | JSON | ุจููุฏ ุงููุญุต |
| is_active | BOOLEAN | ูุดุทุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุงูููุงููุงุช: `operation_approvals`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| operation_id | UUID | ุงูุนูููุฉ |
| approval_level | INT | ูุณุชูู ุงูููุงููุฉ |
| approver_id | UUID | ุงูููุงูู |
| status | ENUM | ุงูุญุงูุฉ (pending, approved, rejected) |
| decision_date | TIMESTAMP | ุชุงุฑูุฎ ุงููุฑุงุฑ |
| notes | TEXT | ููุงุญุธุงุช |
| signature_url | VARCHAR(500) | ุงูุชูููุน ุงูุฅููุชุฑููู |

---

# 6๏ธโฃ ุงูุฏูุน ูุงูุชุณููุฉ

## ๐ฏ ุงูุบุฑุถ

ุญุณุงุจ ูุณุชุญูุงุช ุงูุนุงูููู ุงูููุฏุงูููู ูุฅุฌุฑุงุก ุงูุชุณููุงุช ุงููุงููุฉ.

## ๐ ุงูุฌุฏุงูู

### ุฌุฏูู ูุณุชุญูุงุช ุงูุนูููุงุช: `operation_payments`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| operation_id | UUID | ุงูุนูููุฉ |
| worker_id | UUID | ุงูุนุงูู |
| payment_type | ENUM | ููุน ุงูุฏูุน (fixed, per_operation, commission) |
| base_amount | DECIMAL | ุงููุจูุบ ุงูุฃุณุงุณู |
| bonus_amount | DECIMAL | ุงูููุงูุฃุฉ |
| deduction_amount | DECIMAL | ุงูุฎุตููุงุช |
| net_amount | DECIMAL | ุงูุตุงูู |
| status | ENUM | ุงูุญุงูุฉ (calculated, approved, paid) |
| calculated_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุญุณุงุจ |
| approved_by | UUID | ุงูููุงูู |
| approved_at | TIMESTAMP | ุชุงุฑูุฎ ุงูููุงููุฉ |
| paid_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฏูุน |

### ุฌุฏูู ุชุณููุงุช ุงููุชุฑุฉ: `period_settlements`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| business_id | UUID | ุงููุฌููุนุฉ |
| settlement_number | VARCHAR(20) | ุฑูู ุงูุชุณููุฉ |
| period_start | DATE | ุจุฏุงูุฉ ุงููุชุฑุฉ |
| period_end | DATE | ููุงูุฉ ุงููุชุฑุฉ |
| total_operations | INT | ุฅุฌูุงูู ุงูุนูููุงุช |
| total_amount | DECIMAL | ุฅุฌูุงูู ุงููุจูุบ |
| total_bonuses | DECIMAL | ุฅุฌูุงูู ุงูููุงูุขุช |
| total_deductions | DECIMAL | ุฅุฌูุงูู ุงูุฎุตููุงุช |
| net_amount | DECIMAL | ุงูุตุงูู |
| status | ENUM | ุงูุญุงูุฉ (draft, approved, paid) |
| approved_by | UUID | ุงูููุงูู |
| approved_at | TIMESTAMP | ุชุงุฑูุฎ ุงูููุงููุฉ |
| created_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฅูุดุงุก |

### ุฌุฏูู ุจููุฏ ุงูุชุณููุฉ: `settlement_items`

| ุงูุญูู | ุงูููุน | ุงููุตู |
|-------|-------|-------|
| id | UUID | ุงููุนุฑู ุงููุฑูุฏ |
| settlement_id | UUID | ุงูุชุณููุฉ |
| worker_id | UUID | ุงูุนุงูู |
| operations_count | INT | ุนุฏุฏ ุงูุนูููุงุช |
| base_amount | DECIMAL | ุงููุจูุบ ุงูุฃุณุงุณู |
| bonuses | DECIMAL | ุงูููุงูุขุช |
| deductions | DECIMAL | ุงูุฎุตููุงุช |
| net_amount | DECIMAL | ุงูุตุงูู |
| payment_method | ENUM | ุทุฑููุฉ ุงูุฏูุน |
| payment_reference | VARCHAR(100) | ูุฑุฌุน ุงูุฏูุน |
| paid_at | TIMESTAMP | ุชุงุฑูุฎ ุงูุฏูุน |

---

## ๐ฐ ุงูุฑุจุท ุงููุญุงุณุจู

### ุงูุญุณุงุจุงุช ุงููุฑุชุจุทุฉ ูู ุดุฌุฑุฉ ุงูุญุณุงุจุงุช:

| ุงูุญุณุงุจ | ุงูุฑูุฒ | ุงูุงุณุชุฎุฏุงู |
|--------|-------|-----------|
| ูุตุฑููุงุช ุงูุนูููุงุช ุงูููุฏุงููุฉ | 515 | ุชูุงููู ุงูุนูููุงุช |
| ุฃุฌูุฑ ุงูุนูุงู ุงูููุฏุงูููู | 5151 | ุฃุฌูุฑ ููุณุชุญูุงุช |
| ููุงูุขุช ูุญูุงูุฒ | 5152 | ุงูููุงูุขุช |
| ูุตุฑููุงุช ุงูููู | 5153 | ุชูุงููู ุงูุชููู |
| ุนูุฏ ุงูุนุงูููู | 1141 | ุงูุนูุฏ ุงููุตุฑููุฉ |
| ูุณุชุญูุงุช ุงูุนุงูููู | 2131 | ุงููุณุชุญูุงุช ุบูุฑ ุงููุฏููุนุฉ |

### ุงููููุฏ ุงูุชููุงุฆูุฉ:

**1. ุตุฑู ุนูุฏุฉ ููุนุงูู:**
```
ูู ุญู/ ุนูุฏ ุงูุนุงูููู (1141)
    ุฅูู ุญู/ ุงูุตูุฏูู/ุงูุจูู (1111/1112)
```

**2. ุชุณููุฉ ุงูุนูุฏุฉ ุจุนุฏ ุงูุนูููุฉ:**
```
ูู ุญู/ ูุตุฑููุงุช ุงูุนูููุงุช ุงูููุฏุงููุฉ (515)
    ุฅูู ุญู/ ุนูุฏ ุงูุนุงูููู (1141)
```

**3. ุงุณุชุญูุงู ุฃุฌูุฑ ุงูุนุงูููู:**
```
ูู ุญู/ ุฃุฌูุฑ ุงูุนูุงู ุงูููุฏุงูููู (5151)
    ุฅูู ุญู/ ูุณุชุญูุงุช ุงูุนุงูููู (2131)
```

**4. ุฏูุน ุงููุณุชุญูุงุช:**
```
ูู ุญู/ ูุณุชุญูุงุช ุงูุนุงูููู (2131)
    ุฅูู ุญู/ ุงูุตูุฏูู/ุงูุจูู (1111/1112)
```

---

## ๐ฑ ุงูุดุงุดุงุช ูุงููุงุฌูุงุช

### 1. ููุญุฉ ุชุญูู ุงูุนูููุงุช ุงูููุฏุงููุฉ:
- ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุนูููุงุช
- ุงูุนูููุงุช ุงูุฌุงุฑูุฉ
- ุงูุนูููุงุช ุงููุชุฃุฎุฑุฉ
- ุฃุฏุงุก ุงููุฑู
- ุฎุฑูุทุฉ ุงูููุงูุน

### 2. ุฅุฏุงุฑุฉ ุงูุนูููุงุช:
- ูุงุฆูุฉ ุงูุนูููุงุช
- ุฅูุดุงุก ุนูููุฉ ุฌุฏูุฏุฉ
- ุชูุงุตูู ุงูุนูููุฉ
- ุชุนููู ุงูุนูููุฉ
- ูุชุงุจุนุฉ ุงูุชูููุฐ

### 3. ุฅุฏุงุฑุฉ ุงูุฎุทุท:
- ูุงุฆูุฉ ุงูุฎุทุท
- ุฅูุดุงุก ุฎุทุฉ ุฌุฏูุฏุฉ
- ุฌุฏููุฉ ุงูุนูููุงุช
- ุชูุฒูุน ุงูููุงุฑุฏ

### 4. ุฅุฏุงุฑุฉ ุงููุฑู:
- ูุงุฆูุฉ ุงููุฑู
- ุฃุนุถุงุก ุงููุฑูู
- ุฌุฏูู ุงููุฑูู
- ุฃุฏุงุก ุงููุฑูู

### 5. ุชุชุจุน ุงูุนุงูููู:
- ุฎุฑูุทุฉ ุงูููุงูุน ุงูุญูุฉ
- ุญุงูุฉ ุงูุนุงูููู
- ุณุฌู ุงูููุงูุน

### 6. ุฅุฏุงุฑุฉ ุงููุนุฏุงุช:
- ูุงุฆูุฉ ุงููุนุฏุงุช
- ุญุฑูุงุช ุงููุนุฏุงุช
- ุตูุงูุฉ ุงููุนุฏุงุช

### 7. ุงููุญุต ูุงููุจูู:
- ูุงุฆูุฉ ุงููุญูุตุงุช
- ูููุฐุฌ ุงููุญุต
- ุงูููุงููุงุช ุงููุนููุฉ

### 8. ุงูุชุณููุงุช ุงููุงููุฉ:
- ุชุณููุงุช ุงููุชุฑุฉ
- ูุณุชุญูุงุช ุงูุนุงูููู
- ุชูุงุฑูุฑ ุงูุฏูุน

---

## ๐ APIs

### ุงูุนูููุงุช:
```
GET    /api/v1/field-operations           - ูุงุฆูุฉ ุงูุนูููุงุช
POST   /api/v1/field-operations           - ุฅูุดุงุก ุนูููุฉ
GET    /api/v1/field-operations/:id       - ุชูุงุตูู ุงูุนูููุฉ
PUT    /api/v1/field-operations/:id       - ุชุนุฏูู ุงูุนูููุฉ
POST   /api/v1/field-operations/:id/assign - ุชุนููู ุงูุนูููุฉ
POST   /api/v1/field-operations/:id/start  - ุจุฏุก ุงูุนูููุฉ
POST   /api/v1/field-operations/:id/complete - ุฅููุงู ุงูุนูููุฉ
POST   /api/v1/field-operations/:id/cancel  - ุฅูุบุงุก ุงูุนูููุฉ
```

### ุงููุฑู ูุงูุนุงูููู:
```
GET    /api/v1/field-teams                - ูุงุฆูุฉ ุงููุฑู
POST   /api/v1/field-teams                - ุฅูุดุงุก ูุฑูู
GET    /api/v1/field-workers              - ูุงุฆูุฉ ุงูุนุงูููู
GET    /api/v1/field-workers/:id/location - ูููุน ุงูุนุงูู
POST   /api/v1/field-workers/:id/location - ุชุญุฏูุซ ุงููููุน
GET    /api/v1/field-workers/:id/performance - ุฃุฏุงุก ุงูุนุงูู
```

### ุงููุนุฏุงุช:
```
GET    /api/v1/field-equipment            - ูุงุฆูุฉ ุงููุนุฏุงุช
POST   /api/v1/field-equipment/:id/checkout - ุงุณุชูุงู ูุนุฏุฉ
POST   /api/v1/field-equipment/:id/return   - ุฅุฑุฌุงุน ูุนุฏุฉ
```

### ุงููุญุต:
```
GET    /api/v1/inspections                - ูุงุฆูุฉ ุงููุญูุตุงุช
POST   /api/v1/inspections                - ุฅูุดุงุก ูุญุต
POST   /api/v1/inspections/:id/approve    - ุงูููุงููุฉ
POST   /api/v1/inspections/:id/reject     - ุงูุฑูุถ
```

### ุงูุชุณููุงุช:
```
GET    /api/v1/settlements                - ูุงุฆูุฉ ุงูุชุณููุงุช
POST   /api/v1/settlements                - ุฅูุดุงุก ุชุณููุฉ
POST   /api/v1/settlements/:id/approve    - ุงูููุงููุฉ
POST   /api/v1/settlements/:id/pay        - ุงูุฏูุน
```

---

## ๐ฑ ุชุทุจูู ุงูุฌูุงู ููููู (Field Technician Mobile App)

### ๐ฏ ุงูุบุฑุถ

ุชุทุจูู ุฌูุงู ุจุณูุท ูุณูู ุงูุงุณุชุฎุฏุงู ููููููู ูุงูุนุงูููู ุงูููุฏุงูููู ูุชูููุฐ ุงูุนูููุงุช ูุชุณุฌูู ุงูุจูุงูุงุช.

### ๐ฒ ุดุงุดุงุช ุงูุชุทุจูู

| ุงูุดุงุดุฉ | ุงููุตู |
|--------|-------|
| **ุชุณุฌูู ุงูุฏุฎูู** | ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ |
| **ุงูุฑุฆูุณูุฉ** | ุงูุนูููุงุช ุงููุนููุฉ ูููููุ ุงูุฅุดุนุงุฑุงุช |
| **ุชูุงุตูู ุงูุนูููุฉ** | ููุน ุงูุนูููุฉุ ุงูุนููุงูุ ุงููุตูุ ุงูููุงุฏ ุงููุทููุจุฉ |
| **ุจุฏุก ุงูุนูููุฉ** | ุฒุฑ ุจุฏุก + ุชุณุฌูู ุงููููุน ุชููุงุฆูุงู |
| **ุฅุฏุฎุงู ุงููุฑุงุกุงุช** | ุฅุฏุฎุงู ูุฑุงุกุฉ ุงูุนุฏุงุฏ ุงูุชูููุฏู |
| **ุงูุชูุงุท ุตูุฑ** | ุชุตููุฑ ุงูุนุฏุงุฏ/ุงูุนูู ุงูููุฌุฒ |
| **ุฅููุงู ุงูุนูููุฉ** | ุชุณุฌูู ุงูุฅูุฌุงุฒ + ุงูููุงุญุธุงุช |
| **ุงูุชูููุน** | ุชูููุน ุงูุนููู (ุฅู ูุฒู) |

### ๐ง ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ

1. **ุงุณุชูุงู ุงูุนูููุงุช ุงููุนููุฉ**
   - ุนุฑุถ ูุงุฆูุฉ ุงูุนูููุงุช ุงููุฌุฏููุฉ ููููู
   - ุฅุดุนุงุฑุงุช ุจุงูุนูููุงุช ุงูุฌุฏูุฏุฉ/ุงูุนุงุฌูุฉ
   - ุนุฑุถ ุชูุงุตูู ุงูุนูููุฉ ูุงููููุน

2. **ุชูููุฐ ุงูุนูููุงุช**
   - ุจุฏุก ุงูุนูููุฉ (ูุณุฌู ุงูููุช ูุงููููุน)
   - ุฅุฏุฎุงู ูุฑุงุกุงุช ุงูุนุฏุงุฏุงุช ุงูุชูููุฏูุฉ
   - ุงูุชูุงุท ุตูุฑ ููุนูู ุงูููุฌุฒ
   - ุชุณุฌูู ุงูููุงุฏ ุงููุณุชุฎุฏูุฉ
   - ุฅููุงู ุงูุนูููุฉ (ูุณุฌู ุงูููุช)

3. **ุชุชุจุน ุงููููุน (GPS)**
   - ุชุญุฏูุซ ุงููููุน ุชููุงุฆูุงู ูู 5 ุฏูุงุฆู
   - ุงูููุงุญุฉ ุฅูู ูููุน ุงูุนูููุฉ

4. **ุงูุนูู ุจุฏูู ุงุชุตุงู (Offline)**
   - ุชุฎุฒูู ุงูุนูููุงุช ูุญููุงู
   - ูุฒุงููุฉ ุนูุฏ ุชููุฑ ุงูุงุชุตุงู

### ๐ฑ APIs ููุชุทุจูู

```
POST   /api/v1/mobile/auth/login         - ุชุณุฌูู ุงูุฏุฎูู
GET    /api/v1/mobile/my-operations       - ุนูููุงุชู
GET    /api/v1/mobile/operations/:id      - ุชูุงุตูู ุงูุนูููุฉ
POST   /api/v1/mobile/operations/:id/start    - ุจุฏุก ุงูุนูููุฉ
POST   /api/v1/mobile/operations/:id/complete - ุฅููุงู ุงูุนูููุฉ
POST   /api/v1/mobile/operations/:id/reading  - ุฅุฏุฎุงู ูุฑุงุกุฉ
POST   /api/v1/mobile/operations/:id/photo    - ุฑูุน ุตูุฑุฉ
POST   /api/v1/mobile/location            - ุชุญุฏูุซ ุงููููุน
POST   /api/v1/mobile/sync                - ูุฒุงููุฉ ุงูุจูุงูุงุช
```

### ๐ป ุงูุชูููุงุช ุงูููุชุฑุญุฉ

| ุงููููู | ุงูุชูููุฉ |
|--------|--------|
| ุงูุฅุทุงุฑ | React Native / Flutter |
| ุงูุชุฎุฒูู ุงููุญูู | SQLite / AsyncStorage |
| ุงููููุน | Geolocation API |
| ุงููุงููุฑุง | Camera API |
| ุงูุฅุดุนุงุฑุงุช | Firebase Cloud Messaging |

---

## โฑ๏ธ ุงูุฌุฏูู ุงูุฒููู

| ุงููููุฉ | ุงููุฏุฉ | ุงูููุงุฑุฏ |
|--------|-------|---------|
| ุงููุญุฑู ุงูุฃุณุงุณู | 5 ุฃุณุงุจูุน | 4 ูุทูุฑูู |
| ุฅุฏุงุฑุฉ ุงูุฎุทุท ูุงูุฌุฏุงูู | 3.75 ุฃุณุงุจูุน | 3 ูุทูุฑูู |
| ุฅุฏุงุฑุฉ ุงููุฑู ูุงูุนุงูููู | 3.75 ุฃุณุงุจูุน | 3 ูุทูุฑูู |
| ุฅุฏุงุฑุฉ ุงูููุงุฏ ูุงููุนุฏุงุช | 3.75 ุฃุณุงุจูุน | 3 ูุทูุฑูู |
| ุงููุญุต ูุงููุจูู | 3.75 ุฃุณุงุจูุน | 3 ูุทูุฑูู |
| ุงูุฏูุน ูุงูุชุณููุฉ | 3.75 ุฃุณุงุจูุน | 3 ูุทูุฑูู |
| **ุงูุฅุฌูุงูู** | **~24 ุฃุณุจูุน** | **800 ุณุงุนุฉ** |

---

## ๐ ููุงุญุธุงุช

1. **ุงููุญุฑู ุงูุฃุณุงุณู** ูู ุงูููุงุฉ ุงูุชู ุชูุจูู ุนูููุง ุจุงูู ุงูููููุงุช
2. **ุชุชุจุน ุงููููุน** ูุชุทูุจ ุชุทุจูู ุฌูุงู ููุนุงูููู ุงูููุฏุงูููู
3. **ุงูุฑุจุท ุจูุธุงู ุงููุฎุฒูู** ุถุฑูุฑู ูุตุฑู ุงูููุงุฏ
4. **ุงูุฑุจุท ุจูุธุงู ุงูุฃุตูู** ูุนูููุงุช ุงูุตูุงูุฉ ูุงูุชุฑููุจ
5. **ุงููููุฏ ุงููุญุงุณุจูุฉ** ุชููุดุฃ ุชููุงุฆูุงู ุนูุฏ ุงูุชุณููุงุช


---

## 12. ุฃูุงูุฑ ุนูู ุงูุชุฑุญูู ุฅูู IoT (Migration Work Orders)

> **ุงูุบุฑุถ:** ุฅุฏุงุฑุฉ ุฃูุงูุฑ ุงูุนูู ุงูููุฏุงููุฉ ููุดุฑูุน ุชุฑุญูู ุงููุดุชุฑููู ูู ุงูุดุจูุฉ ุงูุชูููุฏูุฉ ุฅูู ุงูุดุจูุฉ ุงูุฐููุฉ.

### 12.1 ุฃููุงุน ุฃูุงูุฑ ุนูู ุงูุชุฑุญูู

| ุงูููุน | ุงููุตู | ุงูููุงู |
|-------|-------|--------|
| `box_installation` | ุชุฑููุจ ุทุจููู ุฌุฏูุฏ | ุญูุฑุ ุชุซุจูุชุ ุชูุตูู |
| `customer_migration` | ุชุฑุญูู ูุดุชุฑู | ูู ุงูุนุฏุงุฏ ุงููุฏููุ ุชุฑููุจ ุงูุฌุฏูุฏุ ุชูุตูู ุจุงูุทุจููู ุงูุฌุฏูุฏ |
| `wire_removal` | ุฅุฒุงูุฉ ุงูุฃุณูุงู ุงููุฏููุฉ | ููุ ููุ ุชุณููู ูููุฎุฒู |
| `box_decommission` | ุฅูุบุงุก ุทุจููู ูุฏูู | ูุตูุ ุฅุฒุงูุฉุ ุชูุซูู |

### 12.2 ุฌุฏูู ุฃูุงูุฑ ุนูู ุงูุชุฑุญูู (migration_work_orders)

```sql
CREATE TABLE migration_work_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    work_order_id UUID REFERENCES work_orders(id),
    migration_plan_id UUID NOT NULL,
    migration_item_id UUID,
    
    migration_type VARCHAR(30) NOT NULL,
    
    new_box_id UUID,
    customer_id UUID,
    old_meter_serial VARCHAR(50),
    new_meter_serial VARCHAR(50),
    old_wire_length DECIMAL(6, 2),
    new_wire_length DECIMAL(6, 2),
    
    photos_before JSONB,
    photos_after JSONB,
    gps_location_work POINT,
    
    old_meter_collected BOOLEAN DEFAULT false,
    old_meter_condition VARCHAR(20),
    old_wire_collected BOOLEAN DEFAULT false,
    old_wire_length_actual DECIMAL(6, 2),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 12.3 ุดุงุดุฉ ุชุทุจูู ุงูููู - ุงูุชุฑุญูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฑ ุชุทุจูู ุงูููู - ุฃูุฑ ุชุฑุญูู                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุฃูุฑ ุงูุนูู: WO-MIG-001234                                           โ
โ  ุงูููุน: ุชุฑุญูู ูุดุชุฑู                                                 โ
โ  ุงููุดุชุฑู: ุฃุญูุฏ ูุญูุฏ ุนูู (#1234)                                     โ
โ                                                                     โ
โ  โ ุงูุฎุทูุฉ 1: ุงููุตูู ูููููุน [๐ ุชุณุฌูู GPS]                          โ
โ  โ ุงูุฎุทูุฉ 2: ุชูุซูู ุงููุถุน ุงูุญุงูู [๐ท ุตูุฑ]                           โ
โ  โณ ุงูุฎุทูุฉ 3: ูู ุงูุนุฏุงุฏ ุงููุฏูู                                      โ
โ     ุงูุฑูู: [MTR-001234] ุงููุฑุงุกุฉ: [45,230] ุงูุญุงูุฉ: โูุนูู โุชุงูู       โ
โ  โฌ ุงูุฎุทูุฉ 4: ุชุฑููุจ ุงูุนุฏุงุฏ ุงูุฌุฏูุฏ [ูุณุญ ุงูุจุงุฑููุฏ ๐ท]                 โ
โ  โฌ ุงูุฎุทูุฉ 5: ุชูุตูู ุจุงูุทุจููู ุงูุฌุฏูุฏ (FB-001)                        โ
โ  โฌ ุงูุฎุทูุฉ 6: ุฌูุน ุงูููุงุฏ ุงููุฏููุฉ                                    โ
โ  โฌ ุงูุฎุทูุฉ 7: ุงุฎุชุจุงุฑ ูุชุฃููุฏ + ุชูููุน ุงูุนููู                          โ
โ                                                                     โ
โ  [ุฅูุบุงุก] [ุญูุธ ูุณูุฏุฉ]                    [โ ุฅููุงู ุฃูุฑ ุงูุนูู]        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 12.4 ุดุงุดุฉ ูุชุงุจุนุฉ ุฃูุงูุฑ ุงูุชุฑุญูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ูุชุงุจุนุฉ ุฃูุงูุฑ ุงูุชุฑุญูู                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุฎุทุฉ ุงูุชุฑุญูู: [MIG-01 - ุชุฑุญูู ููุทูุฉ ุฃ โผ]                           โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโ โโโโโโโโโโโโโโ โโโโโโโโโโโโโโ โโโโโโโโโโโโโโ       โ
โ  โ 45 ุฅุฌูุงูู โ โ 12 ููุชูู  โ โ 28 ุฌุงุฑู   โ โ 5 ูุนูู    โ       โ
โ  โโโโโโโโโโโโโโ โโโโโโโโโโโโโโ โโโโโโโโโโโโโโ โโโโโโโโโโโโโโ       โ
โ                                                                     โ
โ  โโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโ            โ
โ  โ ุงูุฃูุฑ  โ ุงููุดุชุฑู  โ ุงูููู    โ ุงูุญุงูุฉ   โ ุงูุชูุฏู   โ            โ
โ  โโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโค            โ
โ  โ WO-001 โ ุฃุญูุฏ     โ ุณุงูู     โ ๐ข ููุชูู โ 7/7      โ            โ
โ  โ WO-002 โ ุนูู      โ ุณุงูู     โ ๐ก ุฌุงุฑู  โ 4/7      โ            โ
โ  โโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโ            โ
โ                                                                     โ
โ  ุงูููุงุฏ ุงููุฌูุนุฉ: ุนุฏุงุฏุงุช: 12 | ุฃุณูุงู: 540 ูุชุฑ                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 12.5 APIs ุฃูุงูุฑ ุนูู ุงูุชุฑุญูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/migration-work-orders` | ูุงุฆูุฉ ุฃูุงูุฑ ุงูุชุฑุญูู |
| GET | `/api/v1/migration-work-orders/:id` | ุชูุงุตูู ุฃูุฑ ุชุฑุญูู |
| PUT | `/api/v1/migration-work-orders/:id/step/:step` | ุชุญุฏูุซ ุฎุทูุฉ |
| POST | `/api/v1/migration-work-orders/:id/photo` | ุฑูุน ุตูุฑุฉ |
| POST | `/api/v1/migration-work-orders/:id/gps` | ุชุณุฌูู ุงููููุน |
| POST | `/api/v1/migration-work-orders/:id/old-meter` | ุชุณุฌูู ุงูุนุฏุงุฏ ุงููุฏูู |
| POST | `/api/v1/migration-work-orders/:id/new-meter` | ุชุณุฌูู ุงูุนุฏุงุฏ ุงูุฌุฏูุฏ |
| POST | `/api/v1/migration-work-orders/:id/complete` | ุฅููุงู ุฃูุฑ ุงูุนูู |
| GET | `/api/v1/migration-work-orders/by-plan/:plan_id` | ุฃูุงูุฑ ุฎุทุฉ ูุนููุฉ |
| GET | `/api/v1/migration-work-orders/stats/:plan_id` | ุฅุญุตุงุฆูุงุช ุฎุทุฉ |



---

## ุฏุนู ุชุณุนูุฑ ุงูุฎุฏูุงุช ูู ุฃูุงูุฑ ุงูุนูู (Service Pricing Integration)

> **ุงูุบุฑุถ:** ุฑุจุท ุฃูุงูุฑ ุงูุนูู ุจูุชุงููุฌ ุงูุฎุฏูุงุช ูุญุณุงุจ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ (ููุงุฏ + ุนูุงูุฉ)

### ุฌุฏูู ุฎุฏูุงุช ุฃูุฑ ุงูุนูู (work_order_services)

```sql
CREATE TABLE work_order_services (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    work_order_id UUID REFERENCES work_orders(id),
    service_id UUID REFERENCES service_catalog(id),
    
    quantity DECIMAL(10, 2) DEFAULT 1,
    unit_cost DECIMAL(12, 2) NOT NULL,
    technician_fee DECIMAL(12, 2) DEFAULT 0,
    total_cost DECIMAL(12, 2) GENERATED ALWAYS AS (quantity * unit_cost) STORED,
    total_fee DECIMAL(12, 2) GENERATED ALWAYS AS (quantity * technician_fee) STORED,
    
    executed_by UUID REFERENCES field_workers(id),
    executed_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### ุญุณุงุจ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ ูุฃูุฑ ุงูุนูู

```sql
CREATE VIEW work_order_cost_summary AS
SELECT 
    wo.id AS work_order_id,
    wo.operation_number,
    COALESCE(SUM(wom.quantity * wom.unit_cost), 0) AS materials_cost,
    COALESCE(SUM(wos.total_cost), 0) AS services_cost,
    COALESCE(SUM(wos.total_fee), 0) AS labor_cost,
    COALESCE(SUM(wom.quantity * wom.unit_cost), 0) + COALESCE(SUM(wos.total_cost), 0) AS total_cost,
    COALESCE(SUM(wos.total_fee), 0) AS total_technician_fees
FROM field_operations wo
LEFT JOIN work_order_materials wom ON wo.id = wom.work_order_id
LEFT JOIN work_order_services wos ON wo.id = wos.work_order_id
GROUP BY wo.id, wo.operation_number;
```

### ุดุงุดุฉ ุชูุงุตูู ุชูููุฉ ุฃูุฑ ุงูุนูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ุฃูุฑ ุงูุนูู: WO-2025-001234                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ๐ฆ ุงูููุงุฏ ุงููุณุชุฎุฏูุฉ:                                               โ
โ  โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโ               โ
โ  โ ุงูุตูู            โ ุงููููุฉ  โ ุงูุณุนุฑ    โ ุงูุฅุฌูุงูู โ               โ
โ  โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโค               โ
โ  โ ุนุฏุงุฏ IoT         โ 1       โ 25,000   โ 25,000   โ               โ
โ  โ ุฎุชู ุฃูุงู         โ 1       โ 500      โ 500      โ               โ
โ  โโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโ               โ
โ  ุฅุฌูุงูู ุงูููุงุฏ: 25,500 ุฑูุงู                                         โ
โ                                                                     โ
โ  ๐ง ุงูุฎุฏูุงุช ุงูููุฌุฒุฉ:                                                โ
โ  โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโ    โ
โ  โ ุงูุฎุฏูุฉ           โ ุงููููุฉ  โ ุงูุชูููุฉ  โ ุฃุฌุฑ ุงููููโ ุงูุฅุฌูุงูู โ    โ
โ  โโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโค    โ
โ  โ ุชุฑููุจ ุนุฏุงุฏ ุฌุฏูุฏ  โ 1       โ 5,000    โ 2,000    โ 5,000    โ    โ
โ  โโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโ    โ
โ  ุฅุฌูุงูู ุงูุฎุฏูุงุช: 5,000 ุฑูุงู | ุฃุฌูุฑ ุงูููููู: 2,000 ุฑูุงู              โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  ๐ฐ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ: 30,500 ุฑูุงู                                  โ
โ  ๐ท ุฅุฌูุงูู ุฃุฌูุฑ ุงูููููู: 2,000 ุฑูุงู                                 โ
โ                                                                     โ
โ  [ุฅูุดุงุก ูุงุชูุฑุฉ ููุนููู]  [ุชุตุฏูุฑ PDF]                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### APIs ุชูููุฉ ุฃูุงูุฑ ุงูุนูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/work-orders/:id/cost-summary` | ููุฎุต ุชูููุฉ ุฃูุฑ ุงูุนูู |
| POST | `/api/v1/work-orders/:id/services` | ุฅุถุงูุฉ ุฎุฏูุฉ ูุฃูุฑ ุงูุนูู |
| DELETE | `/api/v1/work-orders/:id/services/:service_id` | ุญุฐู ุฎุฏูุฉ |
| POST | `/api/v1/work-orders/:id/generate-invoice` | ุฅูุดุงุก ูุงุชูุฑุฉ ูู ุฃูุฑ ุงูุนูู |



---

# 7๏ธโฃ ูุธุงู ุญุฒู ุงูุนูู ุงูููุฏุงููุฉ (Work Packages System)

> **ุงูุบุฑุถ:** ุชุฌููุน ุฃูุงูุฑ ุงูุนูู ูู ุญุฒู ูุงุจูุฉ ููุฅุณูุงุฏ ูุงูุชุนุงูุฏ ูุงููุญุตุ ูุน ุฑูุงุจุฉ ุฌูุฏุฉ ูุงููุฉ

## 7.1 ุฌุฏูู ุญุฒู ุงูุนูู (work_packages)

```sql
CREATE TABLE work_packages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID REFERENCES stations(id),
    
    -- ูุนูููุงุช ุงูุญุฒูุฉ
    package_number VARCHAR(20) UNIQUE NOT NULL,
    package_name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- ุงูุฅุณูุงุฏ
    supervisor_id UUID REFERENCES users(id),           -- ุงููุดุฑู ุงูุฐู ุฃูุดุฃ ุงูุญุฒูุฉ
    assigned_team_id UUID REFERENCES field_teams(id),  -- ุงููุฑูู ุงููููุฐ
    contractor_name VARCHAR(100),                       -- ุงุณู ุงูููุงูู (ุฅู ูุฌุฏ)
    
    -- ุงููุฏุฉ ูุงูุฃุฌุฑ
    expected_duration_days INT,
    agreed_amount DECIMAL(12, 2),                       -- ุงูุฃุฌุฑ ุงููุชูู ุนููู
    calculated_amount DECIMAL(12, 2),                   -- ุงููุญุณูุจ ูู ูุชุงููุฌ ุงูุฎุฏูุงุช
    
    -- ุงููุญุต
    inspector_id UUID REFERENCES users(id),            -- ูุฑุงูุจ ุงูุฌูุฏุฉ
    inspection_notes TEXT,
    rejection_reason TEXT,
    
    -- ุงูุญุงูุฉ
    status VARCHAR(30) DEFAULT 'new',
    -- 'new', 'assigned', 'in_progress', 'completed_by_team', 
    -- 'under_inspection', 'rejected', 'approved'
    
    -- ุงูุชูุงุฑูุฎ
    created_at TIMESTAMP DEFAULT NOW(),
    assigned_at TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    inspected_at TIMESTAMP,
    approved_at TIMESTAMP,
    
    created_by UUID REFERENCES users(id),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 7.2 ุฌุฏูู ููุงู ุงูุญุฒูุฉ (work_package_items)

```sql
CREATE TABLE work_package_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    package_id UUID REFERENCES work_packages(id),
    work_order_id UUID REFERENCES field_operations(id),
    
    -- ุชุฑุชูุจ ุงูููุงู
    sequence_order INT,
    
    -- ุญุงูุฉ ุงููููุฉ ุงููุฑุนูุฉ
    item_status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'in_progress', 'completed'
    
    -- ุชูุซูู ุงูุฅูุฌุงุฒ
    completed_at TIMESTAMP,
    completion_notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 7.3 ุฌุฏูู ุตูุฑ ุงููุญุต (package_inspection_photos)

```sql
CREATE TABLE package_inspection_photos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    package_id UUID REFERENCES work_packages(id),
    
    photo_type VARCHAR(20) NOT NULL,  -- 'team_upload', 'inspector_upload'
    uploaded_by UUID REFERENCES users(id),
    
    file_path VARCHAR(500) NOT NULL,
    caption TEXT,
    
    -- ูููุงุญุต: ูู ุงูุตูุฑุฉ ุชุซุจุช ูุดููุฉุ
    is_issue_evidence BOOLEAN DEFAULT FALSE,
    
    uploaded_at TIMESTAMP DEFAULT NOW()
);
```

## 7.4 ุฏูุฑุฉ ุญูุงุฉ ุญุฒูุฉ ุงูุนูู (Workflow)

```
โโโโโโโโโโโ    ุฅุณูุงุฏ    โโโโโโโโโโโโ    ุจุฏุก    โโโโโโโโโโโโโโโ
โ  ุฌุฏูุฏุฉ  โ โโโโโโโโโโโถ โ  ูุณูุฏุฉ   โ โโโโโโโโโถ โ ููุฏ ุงูุชูููุฐ โ
โ  (New)  โ             โ(Assigned)โ           โ(In Progress)โ
โโโโโโโโโโโ             โโโโโโโโโโโโ           โโโโโโโโฌโโโโโโโ
                                                      โ
                                               ุฅููุงู ุงููุฑูู
                                                      โ
                                                      โผ
โโโโโโโโโโโโ   ุฑูุถ    โโโโโโโโโโโโโโโ   ูุญุต   โโโโโโโโโโโโโโโโโโโ
โ ูุฑููุถุฉ  โ โโโโโโโโโ โ ููุฏ ุงููุญุต  โ โโโโโโโโ โ ููุชููุฉ ูู ุงููุฑููโ
โ(Rejected)โ          โ(Inspection) โ          โ(Completed Team) โ
โโโโโโฌโโโโโโ          โโโโโโโโฌโโโโโโโ          โโโโโโโโโโโโโโโโโโโ
     โ                       โ
     โ ุฅุนุงุฏุฉ ููุชูููุฐ         โ ููุงููุฉ
     โ                       โผ
     โ                โโโโโโโโโโโโโโโ
     โโโโโโโโโโโโโโโโโถโ  ููุงูู ุนูููุง โ โโโถ ุฅูุดุงุก ุฃูุฑ ุฏูุน
                      โ  (Approved)  โ
                      โโโโโโโโโโโโโโโ
```

## 7.5 ุดุงุดุฉ ุงููุดุฑู - ุชุฌููุน ุงูููุงู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฆ ุฅูุดุงุก ุญุฒูุฉ ุนูู ุฌุฏูุฏุฉ                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  ุงุณู ุงูุญุฒูุฉ: [ุชุฑููุจ ุนุฏุงุฏุงุช ุญู ุงููุตุฑ - ุงูุฏูุนุฉ 1        ]            โ
โ                                                                     โ
โ  โโ ุฃูุงูุฑ ุงูุนูู ุงููุชุงุญุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ โ WO-001 | ุชุฑููุจ ุนุฏุงุฏ | ุฃุญูุฏ ุนูู | ุญู ุงููุตุฑ                  โ  โ
โ  โ โ WO-002 | ุชุฑููุจ ุนุฏุงุฏ | ูุญูุฏ ุญุณู | ุญู ุงููุตุฑ                  โ  โ
โ  โ โ WO-003 | ุชุฑููุจ ุนุฏุงุฏ | ุณุงูู ุนุจุฏุงููู | ุญู ุงููุตุฑ              โ  โ
โ  โ โ WO-004 | ุตูุงูุฉ ุนุฏุงุฏ | ุฎุงูุฏ ุฃุญูุฏ | ุญู ุงูุฌูููุฑูุฉ             โ  โ
โ  โ โ WO-005 | ุชุฑุญูู ูุดุชุฑู | ุนูู ูุญูุฏ | ุญู ุงูุณูุงู                โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  ุงูููุงู ุงููุญุฏุฏุฉ: 3                                                  โ
โ                                                                     โ
โ  โโ ุชูุงุตูู ุงูุฅุณูุงุฏ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงููุฑูู/ุงูููุงูู: [ูุฑูู ุงูุชุฑููุจุงุช - ุฃุญูุฏ โผ]                    โ  โ
โ  โ ุงููุฏุฉ ุงููุชููุนุฉ: [3] ุฃูุงู                                      โ  โ
โ  โ ุงูุฃุฌุฑ (ูุญุณูุจ): 15,000 ุฑูุงู                                    โ  โ
โ  โ ุงูุฃุฌุฑ (ูุชูู ุนููู): [14,000] ุฑูุงู                              โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  [ุฅูุดุงุก ุงูุญุฒูุฉ ูุฅุณูุงุฏูุง]                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 7.6 ุดุงุดุฉ ุงููุงุญุต/ูุฑุงูุจ ุงูุฌูุฏุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ูุญุต ุญุฒูุฉ ุงูุนูู: PKG-2025-0042                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                     โ
โ  ุงูุญุฒูุฉ: ุชุฑููุจ ุนุฏุงุฏุงุช ุญู ุงููุตุฑ - ุงูุฏูุนุฉ 1                          โ
โ  ุงููุฑูู ุงููููุฐ: ูุฑูู ุงูุชุฑููุจุงุช - ุฃุญูุฏ                               โ
โ  ุชุงุฑูุฎ ุงูุฅููุงู: 2025-12-15                                          โ
โ                                                                     โ
โ  โโ ุงูููุงู ุงูููุฌุฒุฉ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ โ WO-001 | ุชุฑููุจ ุนุฏุงุฏ | ุฃุญูุฏ ุนูู | ููุชูู                     โ  โ
โ  โ โ WO-002 | ุชุฑููุจ ุนุฏุงุฏ | ูุญูุฏ ุญุณู | ููุชูู                     โ  โ
โ  โ โ WO-003 | ุชุฑููุจ ุนุฏุงุฏ | ุณุงูู ุนุจุฏุงููู | ููุชูู                 โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  โโ ุตูุฑ ุงููุฑูู โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ [๐ท ุตูุฑุฉ 1] [๐ท ุตูุฑุฉ 2] [๐ท ุตูุฑุฉ 3]                           โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  โโ ุชูุซูู ุงููุญุต โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ููุงุญุธุงุช ุงููุญุต: [                                    ]         โ โ
โ  โ ุฑูุน ุตูุฑ ุงููุญุต: [ุงุฎุชุฑ ูููุงุช...]                                โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  [โ ููุงููุฉ]  [โ ุฑูุถ ูุน ููุงุญุธุงุช]                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 7.7 ุฌุฏูู ุฃูุงูุฑ ุงูุฏูุน (payment_orders)

```sql
CREATE TABLE payment_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID REFERENCES stations(id),
    
    -- ูุตุฏุฑ ุฃูุฑ ุงูุฏูุน
    source_type VARCHAR(30) NOT NULL,  -- 'work_package', 'invoice', 'other'
    source_id UUID,                     -- work_package_id ุฃู invoice_id
    
    -- ุงููุณุชููุฏ
    beneficiary_type VARCHAR(20) NOT NULL,  -- 'team', 'contractor', 'supplier'
    beneficiary_id UUID,
    beneficiary_name VARCHAR(100) NOT NULL,
    
    -- ุงููุจูุบ
    amount DECIMAL(12, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'YER',
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'approved', 'paid', 'cancelled'
    
    -- ุงูููุงููุงุช
    created_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    paid_at TIMESTAMP,
    payment_reference VARCHAR(100),
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 7.8 Trigger: ุฅูุดุงุก ุฃูุฑ ุฏูุน ุนูุฏ ุงูููุงููุฉ

```sql
CREATE OR REPLACE FUNCTION on_work_package_approved()
RETURNS TRIGGER AS $$
BEGIN
    -- ููุท ุนูุฏ ุงูุงูุชูุงู ูุญุงูุฉ "approved"
    IF NEW.status = 'approved' AND OLD.status = 'under_inspection' THEN
        
        -- ุฅูุดุงุก ุฃูุฑ ุฏูุน ูููุฑูู/ุงูููุงูู
        INSERT INTO payment_orders (
            station_id,
            source_type,
            source_id,
            beneficiary_type,
            beneficiary_id,
            beneficiary_name,
            amount,
            created_by
        ) VALUES (
            NEW.station_id,
            'work_package',
            NEW.id,
            CASE WHEN NEW.contractor_name IS NOT NULL THEN 'contractor' ELSE 'team' END,
            NEW.assigned_team_id,
            COALESCE(NEW.contractor_name, (SELECT name FROM field_teams WHERE id = NEW.assigned_team_id)),
            NEW.agreed_amount,
            NEW.inspector_id
        );
        
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_work_package_approved
    AFTER UPDATE ON work_packages
    FOR EACH ROW
    EXECUTE FUNCTION on_work_package_approved();
```

## 7.9 APIs ูุธุงู ุญุฒู ุงูุนูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/work-packages` | ูุงุฆูุฉ ุญุฒู ุงูุนูู |
| POST | `/api/v1/work-packages` | ุฅูุดุงุก ุญุฒูุฉ ุฌุฏูุฏุฉ |
| GET | `/api/v1/work-packages/:id` | ุชูุงุตูู ุญุฒูุฉ |
| PUT | `/api/v1/work-packages/:id/assign` | ุฅุณูุงุฏ ุงูุญุฒูุฉ ููุฑูู |
| PUT | `/api/v1/work-packages/:id/start` | ุจุฏุก ุงูุชูููุฐ |
| PUT | `/api/v1/work-packages/:id/complete` | ุฅููุงู ูู ุงููุฑูู |
| PUT | `/api/v1/work-packages/:id/inspect` | ุชุณุฌูู ูุชูุฌุฉ ุงููุญุต |
| GET | `/api/v1/work-packages/pending-inspection` | ุงูุญุฒู ุจุงูุชุธุงุฑ ุงููุญุต |
| POST | `/api/v1/work-packages/:id/photos` | ุฑูุน ุตูุฑ ููุญุฒูุฉ |
| GET | `/api/v1/payment-orders` | ูุงุฆูุฉ ุฃูุงูุฑ ุงูุฏูุน |
| PUT | `/api/v1/payment-orders/:id/approve` | ุงุนุชูุงุฏ ุฃูุฑ ุงูุฏูุน |
| PUT | `/api/v1/payment-orders/:id/pay` | ุชุณุฌูู ุงูุตุฑู |



---


---

# 8. ุงูุชูุงูู ูุน ูุธุงู ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10)

> **ููุงุญุธุฉ:** ุชู ููู ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน ูุงูุฎุทุท ุฅูู ูุธุงู ูููุตู: **ูุธุงู ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10)**

## 8.1 ุงูุนูุงูุฉ ุจูู ุงููุธุงููู

```
ูุธุงู ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10)              ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ (04)
โโโโโโโโโโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงููุดุงุฑูุน (Projects)     โ              โ ุฃูุงูุฑ ุงูุนูู             โ
โ ุงูุฎุทุท (Phases)          โโโโโโโโโโโโโโโโถโ (Field Operations)      โ
โ ุญุฒู ุงูุนูู (Work Packages)โ              โ ุชูููุฐ ุงูุญุฒู             โ
โ ุงูููุงูููู (Contractors) โ              โ ุงููุญุต ูุงูุฌูุฏุฉ           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 8.2 ุงูุญููู ุงููุฑุชุจุทุฉ ูู ุฃูุงูุฑ ุงูุนูู

| ุงูุญูู | ุงููุตู | ุงููุตุฏุฑ |
|-------|-------|--------|
| `project_id` | ูุนุฑู ุงููุดุฑูุน | ูุธุงู 10 |
| `phase_id` | ูุนุฑู ุงูุฎุทุฉ | ูุธุงู 10 |
| `work_package_id` | ูุนุฑู ุญุฒูุฉ ุงูุนูู | ูุธุงู 10 |
| `contractor_id` | ูุนุฑู ุงูููุงูู | ูุธุงู 10 |

## 8.3 ุณูุฑ ุงูุนูู ุงููุชูุงูู

1. **ุฅูุดุงุก ุงููุดุฑูุน** โ ูุธุงู ุงูุชุฎุทูุท (10)
2. **ุชุฌุฒุฆุฉ ุงูุนูู (WBS)** โ ูุธุงู ุงูุชุฎุทูุท (10)
3. **ุฅูุดุงุก ุญุฒู ุงูุนูู** โ ูุธุงู ุงูุชุฎุทูุท (10)
4. **ุฅุณูุงุฏ ููููุงูู** โ ูุธุงู ุงูุชุฎุทูุท (10)
5. **ุฅูุดุงุก ุฃูุงูุฑ ุงูุนูู** โ ูุธุงู ุงูุนูููุงุช (04)
6. **ุชูููุฐ ุงูุนูู** โ ูุธุงู ุงูุนูููุงุช (04)
7. **ุงููุญุต ูุงูุฌูุฏุฉ** โ ูุธุงู ุงูุนูููุงุช (04)
8. **ุชุญุฏูุซ ุชูุฏู ุงูุญุฒูุฉ** โ ูุธุงู ุงูุชุฎุทูุท (10)
9. **ุงูููุงููุฉ ูุฃูุฑ ุงูุฏูุน** โ ูุธุงู ุงูุชุฎุทูุท (10) + ุงููุธุงู ุงูุฃู (01)

## 8.4 APIs ุงูุชูุงูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/work-packages/:id/work-orders` | ุฃูุงูุฑ ุนูู ุงูุญุฒูุฉ |
| POST | `/api/v1/work-orders` | ุฅูุดุงุก ุฃูุฑ ุนูู (ูุน ุฑุจุท ุจุงูุญุฒูุฉ) |
| PUT | `/api/v1/work-orders/:id/complete` | ุฅููุงู ุฃูุฑ ุนูู (ูุญุฏุซ ุชูุฏู ุงูุญุฒูุฉ) |

---

> **ููุชูุงุตูู ุงููุงููุฉ ุนู ุฅุฏุงุฑุฉ ุงููุดุงุฑูุนุ ุฑุงุฌุน:** [ูุธุงู ุงูุชุฎุทูุท ูุงููุดุงุฑูุน (10)](./10_ูุธุงู_ุงูุชุฎุทูุท_ูุงููุดุงุฑูุน.md)


---

# 9. ุชุตููุฉ ุงูุนูุฏ ูู ุชุทุจูู ุงูููู (Custody Settlement in Technician App)

> **ุงูุบุฑุถ:** ุชูููู ุงูููู ูู ุชุตููุฉ ุงูุนูุฏ ุงููุงุฏูุฉ ุนูุฏ ุฅููุงู ุฃูุฑ ุงูุนูู ุฃู ุญุฒูุฉ ุงูุนูู

## 9.1 ุณูุฑ ุนูู ุชุตููุฉ ุงูุนูุฏุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ุณูุฑ ุนูู ุชุตููุฉ ุงูุนูุฏุฉ                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  1. ุตุฑู ุงูุนูุฏุฉ                    2. ุชูููุฐ ุงูุนูู                           โ
โ  โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโ                      โ
โ  โ ูุธุงู ุงููุฎุฒูู   โ              โ ุชุทุจูู ุงูููู    โ                      โ
โ  โ ุตุฑู ููุงุฏ ูุนูุฏุฉ โโโโโโโโโโโโโโโถโ ุงุณุชูุงู ุงูุนูุฏุฉ  โ                      โ
โ  โ ููููู/ุงููุฑูู   โ              โ ุชูููุฐ ุงูููุงู   โ                      โ
โ  โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโฌโโโโโโโโโ                      โ
โ                                            โ                               โ
โ                                            โผ                               โ
โ  4. ุชุญุฏูุซ ุงููุฎุฒูู                 3. ุชุตููุฉ ุงูุนูุฏุฉ                          โ
โ  โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโ                      โ
โ  โ ูุธุงู ุงููุฎุฒูู   โ              โ ุชุทุจูู ุงูููู    โ                      โ
โ  โ ุงุณุชูุงู ุงููุฑุชุฌุน โโโโโโโโโโโโโโโโ ุฅุฏุฎุงู ุงููููุงุช  โ                      โ
โ  โ ุชุญุฏูุซ ุงูุฃุฑุตุฏุฉ  โ              โ ุงููุนููุฉ        โ                      โ
โ  โโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโ                      โ
โ                                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 9.2 ุดุงุดุฉ ุชุตููุฉ ุงูุนูุฏุฉ ูู ุชุทุจูู ุงูููู (Mobile)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฑ ุชุตููุฉ ุงูุนูุฏุฉ                      โ ๐  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                             โ
โ ุฃูุฑ ุงูุนูู: WO-2025-0123                    โ
โ ุญุฒูุฉ ุงูุนูู: ุชูุฏูุฏ ุฃุณูุงู ููุจุฑ              โ
โ                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ฆ ุณูู ููุจุฑ ุฃุญุงุฏู                      โ โ
โ โ ุงูุนูุฏุฉ: 500 ูุชุฑ                        โ โ
โ โ                                         โ โ
โ โ ุงููููุฉ ุงููุณุชุฎุฏูุฉ:                      โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ โ โ [480                            ] ูุชุฑโ โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ โ                                         โ โ
โ โ ุงููุชุจูู: 20 ูุชุฑ                        โ โ
โ โ                                         โ โ
โ โ ูุงุฐุง ูุนูุช ุจุงููุชุจููุ                   โ โ
โ โ โ ุฅุฑุฌุงุน ูููุฎุฒู                        โ โ
โ โ โ ุฅุจูุงุก ูููููุฉ ุงูุชุงููุฉ                โ โ
โ โ โ ุชุงูู/ูุณุชููู                         โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ฆ ููุตูุงุช ููุจุฑ                         โ โ
โ โ ุงูุนูุฏุฉ: 50 ูุทุนุฉ                        โ โ
โ โ                                         โ โ
โ โ ุงููููุฉ ุงููุณุชุฎุฏูุฉ:                      โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ โ โ [48                             ] ูุทุนุฉโ โ โ
โ โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ โ
โ โ                                         โ โ
โ โ ุงูุชุงูู: [2] ูุทุนุฉ                       โ โ
โ โ ุณุจุจ ุงูุชูู: [ูุณุฑ ุฃุซูุงุก ุงูุชุฑููุจ      ]   โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ธ ุตูุฑ ุงูุชุตููุฉ (ุงุฎุชูุงุฑู)               โ โ
โ โ [+ ุฅุถุงูุฉ ุตูุฑุฉ]                         โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ููุงุญุธุงุช:                               โ โ
โ โ [ุชู ุงุณุชุฎุฏุงู ูููุฉ ุฃูู ุจุณุจุจ ุชุบููุฑ       โ โ
โ โ  ุงููุณุงุฑ ุงููุฎุทุท                        ] โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                             โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ         [ุชุฃููุฏ ุงูุชุตููุฉ]                โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 9.3 ุฌุฏูู ุชุตููุฉ ุงูุนูุฏ ุงูููุฏุงููุฉ (field_custody_settlements)

```sql
CREATE TABLE field_custody_settlements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ุงูุนูุฏุฉ ุงูุฃุตููุฉ
    custody_id UUID REFERENCES material_custodies(id) NOT NULL,
    custody_item_id UUID REFERENCES custody_items(id) NOT NULL,
    
    -- ุงููุฑุฌุน
    work_order_id UUID REFERENCES field_operations(id),
    work_package_id UUID REFERENCES work_packages(id),
    
    -- ุงูููู
    technician_id UUID REFERENCES users(id) NOT NULL,
    
    -- ุงููููุงุช
    original_quantity DECIMAL(15, 3) NOT NULL,
    used_quantity DECIMAL(15, 3) NOT NULL,
    returned_quantity DECIMAL(15, 3) DEFAULT 0,
    damaged_quantity DECIMAL(15, 3) DEFAULT 0,
    kept_quantity DECIMAL(15, 3) DEFAULT 0, -- ูููููุฉ ุงูุชุงููุฉ
    
    -- ูุตูุฑ ุงููุชุจูู
    remaining_action VARCHAR(20),
    -- 'return': ุฅุฑุฌุงุน ูููุฎุฒู
    -- 'keep': ุฅุจูุงุก ูููููุฉ ุงูุชุงููุฉ
    -- 'damaged': ุชุงูู
    -- 'consumed': ูุณุชููู ุจุงููุงูู
    
    -- ุงูุชูู
    damage_reason TEXT,
    
    -- ุงูุตูุฑ
    photos JSONB DEFAULT '[]',
    
    -- ุงูููุงุญุธุงุช
    notes TEXT,
    
    -- ุงููููุน
    settlement_location GEOGRAPHY(POINT, 4326),
    
    -- ุงูุชูููุช
    settled_at TIMESTAMP DEFAULT NOW(),
    
    -- ุงูุญุงูุฉ
    status VARCHAR(20) DEFAULT 'pending',
    -- 'pending': ุจุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ
    -- 'approved': ููุงูู ุนูููุง
    -- 'rejected': ูุฑููุถุฉ
    
    reviewed_by UUID REFERENCES users(id),
    reviewed_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- ููุงุฑุณ
CREATE INDEX idx_field_settlements_custody ON field_custody_settlements(custody_id);
CREATE INDEX idx_field_settlements_work_order ON field_custody_settlements(work_order_id);
CREATE INDEX idx_field_settlements_technician ON field_custody_settlements(technician_id);
```

## 9.4 Trigger: ุชุญุฏูุซ ุงูุนูุฏุฉ ุนูุฏ ุงูุชุตููุฉ ุงูููุฏุงููุฉ

```sql
CREATE OR REPLACE FUNCTION process_field_custody_settlement()
RETURNS TRIGGER AS $$
BEGIN
    -- ุชุญุฏูุซ ุจูุฏ ุงูุนูุฏุฉ
    UPDATE custody_items
    SET 
        consumed_quantity = consumed_quantity + NEW.used_quantity,
        returned_quantity = returned_quantity + NEW.returned_quantity,
        damaged_quantity = damaged_quantity + NEW.damaged_quantity,
        status = CASE 
            WHEN remaining_quantity = 0 THEN 'consumed'
            WHEN returned_quantity > 0 AND consumed_quantity > 0 THEN 'mixed'
            WHEN returned_quantity > 0 THEN 'fully_returned'
            ELSE 'issued'
        END,
        updated_at = NOW()
    WHERE id = NEW.custody_item_id;
    
    -- ุฅูุดุงุก ุญุฑูุฉ ูู ุณุฌู ุงูุนูุฏุฉ
    INSERT INTO custody_transactions (
        custody_id, custody_item_id, transaction_type,
        quantity, reference_type, reference_id, notes, created_by
    ) VALUES (
        NEW.custody_id, NEW.custody_item_id, 'consume',
        NEW.used_quantity, 'work_order', NEW.work_order_id,
        'ุชุตููุฉ ููุฏุงููุฉ', NEW.technician_id
    );
    
    -- ุฅุฐุง ูุงู ููุงู ุฅุฑุฌุงุน
    IF NEW.returned_quantity > 0 THEN
        INSERT INTO custody_transactions (
            custody_id, custody_item_id, transaction_type,
            quantity, reference_type, reference_id, notes, created_by
        ) VALUES (
            NEW.custody_id, NEW.custody_item_id, 'return',
            NEW.returned_quantity, 'work_order', NEW.work_order_id,
            'ุฅุฑุฌุงุน ูู ุงูููุฏุงู', NEW.technician_id
        );
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_field_custody_settlement
AFTER INSERT ON field_custody_settlements
FOR EACH ROW
EXECUTE FUNCTION process_field_custody_settlement();
```

## 9.5 APIs ุชุตููุฉ ุงูุนูุฏ ุงูููุฏุงููุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/technician/custodies` | ุนูุฏ ุงูููู ุงูุญุงููุฉ |
| GET | `/api/v1/work-orders/:id/custody` | ุนูุฏุฉ ุฃูุฑ ุงูุนูู |
| POST | `/api/v1/work-orders/:id/custody/settle` | ุชุตููุฉ ุนูุฏุฉ ุฃูุฑ ุงูุนูู |
| GET | `/api/v1/custody-settlements` | ูุงุฆูุฉ ุงูุชุตููุงุช |
| GET | `/api/v1/custody-settlements/:id` | ุชูุงุตูู ุชุตููุฉ |
| POST | `/api/v1/custody-settlements/:id/approve` | ุงูููุงููุฉ ุนูู ุงูุชุตููุฉ |
| POST | `/api/v1/custody-settlements/:id/reject` | ุฑูุถ ุงูุชุตููุฉ |

---

## 14. ุฑุจุท ุฃูุงูุฑ ุงูุนูู ุจุนูุงุตุฑ ุงูุดุจูุฉ

> **ุงูุบุฑุถ:** ุฑุจุท ุฃูุงูุฑ ุงูุนูู ุงูููุฏุงููุฉ ุจุนูุงุตุฑ ุงูุดุจูุฉ ุงูููุฑุจุงุฆูุฉ (ุนูุฏ ูููุงุทุน) ูุชุชุจุน ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช

### 14.1 ุงููุจุฏุฃ

```
ุฃูุฑ ุงูุนูู ูููู ุฃู ูุฑุชุจุท ุจู:
โ
โโโ ุนูุฏุฉ ุดุจูุฉ (Network Node)
โ   โโโ ุตูุงูุฉ ุนููุฏ
โ   โโโ ุงุณุชุจุฏุงู ูุญูู
โ   โโโ ุฅุตูุงุญ ุทุจููู
โ   โโโ ุชุฑููุจ ููุทุฉ ุชุนููู ุฌุฏูุฏุฉ
โ
โโโ ููุทุน ุดุจูุฉ (Network Segment)
โ   โโโ ุฅุตูุงุญ ูุทุน ูู ุงูููุจู
โ   โโโ ุงุณุชุจุฏุงู ููุจู ุชุงูู
โ   โโโ ุชูุฏูุฏ ููุจู ุฌุฏูุฏ
โ
โโโ ุฃุตู ุดุจูุฉ ูุฌูุน (Network Asset)
    โโโ ุตูุงูุฉ ุดุงููุฉ ููุดุจูุฉ
    โโโ ุชูุณุนุฉ ุงูุดุจูุฉ
```

### 14.2 ุชุญุฏูุซ ุฌุฏูู ุฃูุงูุฑ ุงูุนูู

```sql
-- ุฅุถุงูุฉ ุญููู ุฑุจุท ุงูุดุจูุฉ ูุฌุฏูู ุฃูุงูุฑ ุงูุนูู
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS network_node_id UUID;
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS network_segment_id UUID;
ALTER TABLE work_orders ADD COLUMN IF NOT EXISTS network_asset_id UUID;

-- ุฅุถุงูุฉ ููุน ุนูููุฉ ุฌุฏูุฏ ููุดุจูุฉ
-- ูู ENUM operation_type: ุฅุถุงูุฉ 'network_maintenance', 'network_installation', 'network_repair'
```

### 14.3 ุฌุฏูู ุฃูุงูุฑ ุนูู ุงูุดุจูุฉ (network_work_orders)

```sql
CREATE TABLE network_work_orders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    work_order_id UUID NOT NULL REFERENCES work_orders(id),
    
    -- ููุน ุนูู ุงูุดุจูุฉ
    network_work_type VARCHAR(50) NOT NULL,  -- 'node_maintenance', 'segment_repair', 'component_replacement', 'new_installation'
    
    -- ุฑุจุท ุจุนูุงุตุฑ ุงูุดุจูุฉ
    network_node_id UUID,
    network_segment_id UUID,
    network_asset_id UUID,
    
    -- ุชูุงุตูู ุงูุนูู
    affected_component VARCHAR(100),  -- 'tension_clamp', 'cable', 'transformer', 'pole'
    fault_description TEXT,
    repair_description TEXT,
    
    -- ุงูููููุงุช ุงููุณุชุจุฏูุฉ
    old_component_serial VARCHAR(100),
    new_component_serial VARCHAR(100),
    
    -- ุงูููุงุณุงุช ูุจู ูุจุนุฏ
    voltage_before DECIMAL(10,2),
    voltage_after DECIMAL(10,2),
    
    -- ุงูุชูููุฉ
    labor_cost DECIMAL(15,2),
    material_cost DECIMAL(15,2),
    total_cost DECIMAL(15,2),
    
    -- ุงูุชูุซูู
    photos_before JSONB,  -- [{url, caption, timestamp}]
    photos_after JSONB,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 14.4 ุฃููุงุน ุฃูุงูุฑ ุนูู ุงูุดุจูุฉ

```sql
-- ุฃููุงุน ุฃุนูุงู ุงูุดุจูุฉ
CREATE TYPE network_work_type AS ENUM (
    'pole_maintenance',        -- ุตูุงูุฉ ุนููุฏ
    'pole_replacement',        -- ุงุณุชุจุฏุงู ุนููุฏ
    'transformer_maintenance', -- ุตูุงูุฉ ูุญูู
    'transformer_replacement', -- ุงุณุชุจุฏุงู ูุญูู
    'cable_repair',           -- ุฅุตูุงุญ ููุจู
    'cable_replacement',      -- ุงุณุชุจุฏุงู ููุจู
    'cable_extension',        -- ุชูุฏูุฏ ููุจู ุฌุฏูุฏ
    'clamp_replacement',      -- ุงุณุชุจุฏุงู ูุทุนุฉ ุดุฏ/ุชุนููู
    'insulator_replacement',  -- ุงุณุชุจุฏุงู ุนุงุฒู
    'distribution_box_maintenance', -- ุตูุงูุฉ ุทุจููู
    'network_inspection',     -- ูุญุต ุฏูุฑู ููุดุจูุฉ
    'fault_investigation'     -- ุชุญููู ูู ุนุทู
);
```

### 14.5 ุดุงุดุฉ ุฅูุดุงุก ุฃูุฑ ุนูู ููุดุจูุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุฃูุฑ ุนูู ุตูุงูุฉ ุงูุดุจูุฉ                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โ ููุน ุงูุนูู: [ุงุณุชุจุฏุงู ูุทุนุฉ ุดุฏ โผ]                                โ
โ                                                                 โ
โ ุฑุจุท ุจุงูุดุจูุฉ:                                                   โ
โ โโ ุนูุฏุฉ ุงูุดุจูุฉ: [ุนููุฏ ุฑูู 5 - POL-005 โผ]                      โ
โ โโ ููุทุน ุงูุดุจูุฉ: [ุบูุฑ ูุญุฏุฏ]                                    โ
โ โโ ุฃุตู ุงูุดุจูุฉ: [ุดุจูุฉ ุชูุฒูุน ุญู ุงูุณูุงู โผ]                       โ
โ                                                                 โ
โ ุงููููู ุงููุชุฃุซุฑ: [ูุทุนุฉ ุดุฏ โผ]                                    โ
โ                                                                 โ
โ ูุตู ุงูุนุทู:                                                     โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ูุทุนุฉ ุงูุดุฏ ุนูู ุงูุนููุฏ 5 ุชุงููุฉ ูุชุญุชุงุฌ ุงุณุชุจุฏุงู               โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โ ุงูุฃููููุฉ: [โ ุนุงุฌู โ ุนุงุฏู โ ูุฌุฏูู]                             โ
โ                                                                 โ
โ ุงูููู ุงููุณูุฏ: [ุฃุญูุฏ ูุญูุฏ - ููู ุดุจูุงุช โผ]                       โ
โ                                                                 โ
โ ุงูููุงุฏ ุงููุทููุจุฉ:                                               โ
โ โโ ูุทุนุฉ ุดุฏ 120mmยฒ (1 ูุทุนุฉ)                                    โ
โ โโ [+ ุฅุถุงูุฉ ูุงุฏุฉ]                                              โ
โ                                                                 โ
โ                              [ุฅูุบุงุก] [ุฅูุดุงุก ุฃูุฑ ุงูุนูู]         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 14.6 ุดุงุดุฉ ุชูููุฐ ุฃูุฑ ุนูู ุงูุดุจูุฉ (ุชุทุจูู ุงูููู)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุชูููุฐ ุฃูุฑ ุนูู ุงูุดุจูุฉ                                          โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โ ุฃูุฑ ุงูุนูู: WO-NET-2025-001                                     โ
โ ุงูููุน: ุงุณุชุจุฏุงู ูุทุนุฉ ุดุฏ                                        โ
โ ุงููููุน: ุนููุฏ ุฑูู 5 - ุญู ุงูุณูุงู                                โ
โ                                                                 โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                 โ
โ 1. ุตูุฑ ูุจู ุงูุนูู:                                              โ
โ    [๐ท ุงูุชูุงุท ุตูุฑุฉ] [3 ุตูุฑ ููุชูุทุฉ โ]                          โ
โ                                                                 โ
โ 2. ุงููููู ุงููุฏูู:                                              โ
โ    ุงูุฑูู ุงูุชุณูุณูู: [ูุณุญ ุงูุจุงุฑููุฏ ๐ท] TC-2020-0542             โ
โ                                                                 โ
โ 3. ุงููููู ุงูุฌุฏูุฏ:                                              โ
โ    ุงูุฑูู ุงูุชุณูุณูู: [ูุณุญ ุงูุจุงุฑููุฏ ๐ท] TC-2025-1234             โ
โ                                                                 โ
โ 4. ุงูููุงุณุงุช:                                                   โ
โ    ุงูุฌูุฏ ูุจู: [378] ูููุช                                      โ
โ    ุงูุฌูุฏ ุจุนุฏ: [380] ูููุช                                      โ
โ                                                                 โ
โ 5. ุตูุฑ ุจุนุฏ ุงูุนูู:                                              โ
โ    [๐ท ุงูุชูุงุท ุตูุฑุฉ] [2 ุตูุฑ ููุชูุทุฉ โ]                          โ
โ                                                                 โ
โ 6. ููุงุญุธุงุช:                                                    โ
โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ    โ ุชู ุงูุงุณุชุจุฏุงู ุจูุฌุงุญุ ุงููุทุนุฉ ุงููุฏููุฉ ูุงูุช ูุชุขููุฉ        โ โ
โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                 โ
โ                              [ุญูุธ ูุณูุฏุฉ] [ุฅููุงู ุงูุนูู]         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 14.7 View: ุณุฌู ุตูุงูุฉ ุนูุงุตุฑ ุงูุดุจูุฉ

```sql
CREATE OR REPLACE VIEW v_network_element_maintenance_history AS
SELECT 
    COALESCE(nwo.network_node_id, nwo.network_segment_id) as element_id,
    CASE 
        WHEN nwo.network_node_id IS NOT NULL THEN 'node'
        ELSE 'segment'
    END as element_type,
    wo.work_order_number,
    nwo.network_work_type,
    nwo.affected_component,
    nwo.fault_description,
    nwo.repair_description,
    wo.status,
    wo.completed_at,
    nwo.total_cost,
    u.full_name as technician_name
FROM network_work_orders nwo
JOIN work_orders wo ON wo.id = nwo.work_order_id
LEFT JOIN users u ON u.id = wo.assigned_to
ORDER BY wo.completed_at DESC;
```

### 14.8 Trigger: ุชุญุฏูุซ ุณุฌู ุงูุฃุตู ุนูุฏ ุฅููุงู ุตูุงูุฉ ุงูุดุจูุฉ

```sql
CREATE OR REPLACE FUNCTION update_network_asset_on_maintenance()
RETURNS TRIGGER AS $$
BEGIN
    -- ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ุตูุงูุฉ ููุนูุฏุฉ
    IF NEW.network_node_id IS NOT NULL THEN
        UPDATE network_nodes 
        SET last_maintenance_date = NOW(),
            maintenance_status = 'good'
        WHERE id = NEW.network_node_id;
    END IF;
    
    -- ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ุตูุงูุฉ ููููุทุน
    IF NEW.network_segment_id IS NOT NULL THEN
        UPDATE network_segments 
        SET last_maintenance_date = NOW(),
            maintenance_status = 'good'
        WHERE id = NEW.network_segment_id;
    END IF;
    
    -- ุชุณุฌูู ูู ุณุฌู ุงูุฃุตู
    INSERT INTO asset_history (
        asset_id,
        event_type,
        event_description,
        cost,
        created_at
    )
    SELECT 
        anl.asset_id,
        'maintenance',
        NEW.repair_description,
        NEW.total_cost,
        NOW()
    FROM asset_network_links anl
    WHERE anl.network_element_id = COALESCE(NEW.network_node_id, NEW.network_segment_id);
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_network_asset_on_maintenance
AFTER INSERT ON network_work_orders
FOR EACH ROW
WHEN (NEW.work_order_id IN (SELECT id FROM work_orders WHERE status = 'completed'))
EXECUTE FUNCTION update_network_asset_on_maintenance();
```

### 14.9 APIs ุฃูุงูุฑ ุนูู ุงูุดุจูุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/work-orders/network` | ุฅูุดุงุก ุฃูุฑ ุนูู ุดุจูุฉ |
| GET | `/api/v1/work-orders/network/node/:nodeId` | ุฃูุงูุฑ ุนูู ุนูุฏุฉ |
| GET | `/api/v1/work-orders/network/segment/:segmentId` | ุฃูุงูุฑ ุนูู ููุทุน |
| PUT | `/api/v1/work-orders/network/:id/complete` | ุฅููุงู ุฃูุฑ ุนูู ุดุจูุฉ |
| GET | `/api/v1/network/elements/:id/maintenance-history` | ุณุฌู ุตูุงูุฉ ุนูุตุฑ |
| GET | `/api/v1/network/assets/:id/total-maintenance-cost` | ุฅุฌูุงูู ุชูุงููู ุตูุงูุฉ ุฃุตู |

---

> **ุงูุธุฑ ุฃูุถุงู:** 
> - `05_ูุธุงู_ุงููุฑุงูุจุฉ_ูุงูุชุญูู.md` - ุงููุณู 9 ููุชูุฃู ุงูุฑููู ููุดุจูุฉ
> - `06_ูุธุงู_ุงููุฎุฒูู_ูุงููุดุชุฑูุงุช.md` - ุงููุณู 19 ูุฃุตูุงู ููููุงุช ุงูุดุจูุฉ

---

## 14. ุชุฃููุฏ ุชุฑููุจ ุงูุฃุตูุงู ุงููุชุชุจุนุฉ (ุชุทุจูู ุงูููู)

### 14.1 ุดุงุดุฉ ุชุฃููุฏ ุงูุชุฑููุจ ูู ุชุทุจูู ุงูููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ฑ ุชุทุจูู ุงูููู - ุชุฃููุฏ ุงูุชุฑููุจ                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฃูุฑ ุงูุนูู: WO-2024-0892                                                   โ
โ  ุงูุนููู: ุฃุญูุฏ ูุญูุฏ ุนูู                                                     โ
โ  ุงูุนููุงู: ุดุงุฑุน ุงูุฌูููุฑูุฉุ ุจุฌูุงุฑ ูุณุฌุฏ ุงูููุฑ                                 โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                        ุชุฃููุฏ ุงูุฃุตูุงู ุงููุฑูุจุฉ                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 1. ุงูุนุฏุงุฏ                                                            โ   โ
โ  โ    ุงููุตุฑูู: MTR-2024-00156                                          โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ MTR-2024-00156 โ ูุทุงุจู                        โ   โ
โ  โ    ๐ ุงููุฑุงุกุฉ ุงูุงูุชุชุงุญูุฉ: [0000.00] kWh                              โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงูุนุฏุงุฏ ุงููุฑูุจ]                                    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 2. ุงูุฎุชู                                                             โ   โ
โ  โ    ุงููุตุฑูู: SEAL-2024-08956                                         โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ SEAL-2024-08956 โ ูุทุงุจู                       โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงูุฎุชู]                                            โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 3. ุงููุงุทุน                                                            โ   โ
โ  โ    ุงููุตุฑูู: BRK-2024-04521 (32A)                                    โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ BRK-2024-04521 โ ูุทุงุจู                        โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงููุงุทุน]                                           โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 4. ุงูุณูู                                                             โ   โ
โ  โ    ุงููุตุฑูู: 5 ูุชุฑ ุณูู 4 ูู                                          โ   โ
โ  โ    ุงููููุฉ ุงููุณุชุฎุฏูุฉ ูุนููุงู: [4.5] ูุชุฑ                                โ   โ
โ  โ    ุงููุฑุชุฌุน: 0.5 ูุชุฑ                                                  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  ๐ ุงููููุน ุงูุฌุบุฑุงูู: 15.3694ยฐ N, 44.1910ยฐ E โ                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ููุงุญุธุงุช: [ุงูุชุฑููุจ ุชู ุจูุฌุงุญุ ุงูุนููู ุฑุงุถู________________]                โ
โ                                                                             โ
โ  ุชูููุน ุงูุนููู: [โ๏ธ ุงูุชูููุน ุงูุฅููุชุฑููู]                                    โ
โ                                                                             โ
โ                        [โ ุชุฃููุฏ ุฅุชูุงู ุงูุชุฑููุจ]                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 14.2 ุฌุฏูู ุชุฃููุฏ ุงูุชุฑููุจ (installation_confirmations)

```sql
CREATE TABLE installation_confirmations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID NOT NULL REFERENCES stations(id),
    work_order_id UUID NOT NULL REFERENCES work_orders(id),
    customer_id UUID NOT NULL REFERENCES customers(id),
    technician_id UUID NOT NULL REFERENCES users(id),
    
    -- ุงูุนุฏุงุฏ
    meter_serial_number VARCHAR(100) NOT NULL,
    meter_confirmed BOOLEAN DEFAULT false,
    meter_opening_reading DECIMAL(15,3),
    meter_photo_url TEXT,
    
    -- ุงูุฎุชู
    seal_serial_number VARCHAR(100),
    seal_confirmed BOOLEAN DEFAULT false,
    seal_photo_url TEXT,
    
    -- ุงููุงุทุน
    breaker_serial_number VARCHAR(100),
    breaker_confirmed BOOLEAN DEFAULT false,
    breaker_amperage INTEGER,
    breaker_photo_url TEXT,
    
    -- ุงููููุน
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- ุงูุชูููุน
    customer_signature_url TEXT,
    
    -- ุงูุญุงูุฉ
    confirmation_status ENUM('pending', 'confirmed', 'rejected') DEFAULT 'pending',
    confirmed_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 14.3 Trigger ูุชุญุฏูุซ ุญุงูุฉ ุงูุฃุตูุงู ุนูุฏ ุชุฃููุฏ ุงูุชุฑููุจ

```sql
CREATE OR REPLACE FUNCTION update_items_on_installation_confirmation()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.confirmation_status = 'confirmed' THEN
        -- ุชุญุฏูุซ ุญุงูุฉ ุงูุนุฏุงุฏ
        UPDATE meter_status_tracking
        SET current_status = 'installed',
            installed_customer_id = NEW.customer_id,
            installed_date = NOW(),
            updated_at = NOW()
        WHERE serial_number = NEW.meter_serial_number;
        
        -- ุชุญุฏูุซ ุญุงูุฉ ุงูุฎุชู
        IF NEW.seal_serial_number IS NOT NULL THEN
            UPDATE seal_tracking
            SET current_status = 'installed',
                installed_meter_id = (SELECT id FROM meters WHERE serial_number = NEW.meter_serial_number),
                installed_customer_id = NEW.customer_id,
                installed_date = NOW(),
                updated_at = NOW()
            WHERE serial_number = NEW.seal_serial_number;
        END IF;
        
        -- ุชุญุฏูุซ ุญุงูุฉ ุงููุงุทุน
        IF NEW.breaker_serial_number IS NOT NULL THEN
            UPDATE breaker_tracking
            SET current_status = 'installed',
                installed_meter_id = (SELECT id FROM meters WHERE serial_number = NEW.meter_serial_number),
                installed_customer_id = NEW.customer_id,
                installed_date = NOW(),
                updated_at = NOW()
            WHERE serial_number = NEW.breaker_serial_number;
        END IF;
        
        -- ุชุณุฌูู ูู ุงูุณุฌู ุงูุชุงุฑูุฎู
        INSERT INTO serialized_item_history (
            station_id, item_type, serial_number,
            from_status, to_status,
            to_location_type, to_location_id,
            reference_type, reference_id, performed_by,
            latitude, longitude
        ) VALUES
        (NEW.station_id, 'meter', NEW.meter_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude),
        (NEW.station_id, 'seal', NEW.seal_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude),
        (NEW.station_id, 'breaker', NEW.breaker_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude);
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_installation_confirmation
AFTER UPDATE ON installation_confirmations
FOR EACH ROW
WHEN (NEW.confirmation_status = 'confirmed' AND OLD.confirmation_status != 'confirmed')
EXECUTE FUNCTION update_items_on_installation_confirmation();
```

### 14.4 View: ุงูุฃุตูุงู ุงููุฑูุจุฉ ูุฏู ุงูุนููู

```sql
CREATE OR REPLACE VIEW v_customer_installed_items AS
SELECT 
    c.id AS customer_id,
    c.name AS customer_name,
    c.account_number,
    
    -- ุงูุนุฏุงุฏ
    mst.serial_number AS meter_serial,
    m.meter_type,
    mst.installed_date AS meter_installed_date,
    
    -- ุงูุฎุชู
    st.serial_number AS seal_serial,
    st.seal_type,
    st.installed_date AS seal_installed_date,
    
    -- ุงููุงุทุน
    bt.serial_number AS breaker_serial,
    bt.amperage AS breaker_amperage,
    bt.breaker_type,
    bt.installed_date AS breaker_installed_date,
    
    -- ุตูุฑ ุงูุชุฑููุจ
    ic.meter_photo_url,
    ic.seal_photo_url,
    ic.breaker_photo_url,
    ic.customer_signature_url
    
FROM customers c
LEFT JOIN meter_status_tracking mst ON mst.installed_customer_id = c.id AND mst.current_status = 'installed'
LEFT JOIN meters m ON m.serial_number = mst.serial_number
LEFT JOIN seal_tracking st ON st.installed_customer_id = c.id AND st.current_status = 'installed'
LEFT JOIN breaker_tracking bt ON bt.installed_customer_id = c.id AND bt.current_status = 'installed'
LEFT JOIN installation_confirmations ic ON ic.customer_id = c.id AND ic.confirmation_status = 'confirmed';
```

### 14.5 APIs ุชุฃููุฏ ุงูุชุฑููุจ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | /api/v1/installations/confirm | ุชุฃููุฏ ุชุฑููุจ ุฃุตูุงู |
| GET | /api/v1/installations/:work_order_id | ุจูุงูุงุช ุงูุชุฑููุจ ูุฃูุฑ ุนูู |
| GET | /api/v1/customers/:id/installed-items | ุงูุฃุตูุงู ุงููุฑูุจุฉ ูุนููู |
| POST | /api/v1/installations/upload-photo | ุฑูุน ุตูุฑุฉ ุงูุชุฑููุจ |
| POST | /api/v1/installations/signature | ุญูุธ ุชูููุน ุงูุนููู |


---

## 15. ุณูุฑ ุนูู ุชุฑููุจ ุนุฏุงุฏุงุช STS (4 ุฃุตูุงู)

### 15.1 ุดุงุดุฉ ุชุฃููุฏ ุชุฑููุจ STS ูู ุชุทุจูู ุงูููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ฑ ุชุทุจูู ุงูููู - ุชุฃููุฏ ุชุฑููุจ ุนุฏุงุฏ STS                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฃูุฑ ุงูุนูู: WO-2024-0956                                                   โ
โ  ุงูุนููู: ูุญูุฏ ุฃุญูุฏ ุณุนูุฏ                                                    โ
โ  ุงูุนููุงู: ุญู ุงููุตุฑุ ุดุงุฑุน 14 ููููู                                          โ
โ  ููุน ุงูุชุฑููุจ: ุนุฏุงุฏ ุฏูุน ูุณุจู STS                                            โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                    ุชุฃููุฏ ุงูุฃุตูุงู ุงูุฃุฑุจุนุฉ ุงููุฑูุจุฉ                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 1. ุนุฏุงุฏ STS                                                          โ   โ
โ  โ    ุงููุตุฑูู: STS-2024-00156                                          โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ STS-2024-00156 โ ูุทุงุจู                        โ   โ
โ  โ    ๐ ุงููุฑุงุกุฉ ุงูุงูุชุชุงุญูุฉ: [0000.00] kWh                              โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงูุนุฏุงุฏ ุงููุฑูุจ] โ                                  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 2. ุดุงุดุฉ ุงูุนุฑุถ STS (CIU) โญ ููู                                       โ   โ
โ  โ    ุงููุตุฑูู: CIU-2024-00156                                          โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ CIU-2024-00156 โ ูุทุงุจู                        โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงูุดุงุดุฉ ูุน ุงูุนููู] โ                               โ   โ
โ  โ    โ๏ธ ุชู ุชุณููู ุงูุดุงุดุฉ ููุนููู ูุชูุนูููุง                                โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 3. ุงูุฎุชู                                                             โ   โ
โ  โ    ุงููุตุฑูู: SEAL-2024-09123                                         โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ SEAL-2024-09123 โ ูุทุงุจู                       โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงูุฎุชู] โ                                          โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 4. ุงููุงุทุน                                                            โ   โ
โ  โ    ุงููุตุฑูู: BRK-2024-05678 (32A)                                    โ   โ
โ  โ    [๐ท ูุณุญ ููุชุฃููุฏ] โ BRK-2024-05678 โ ูุทุงุจู                        โ   โ
โ  โ    ๐ธ [ุงูุชูุงุท ุตูุฑุฉ ุงููุงุทุน] โ                                         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  ๐ ุงููููุน ุงูุฌุบุฑุงูู: 15.3694ยฐ N, 44.1910ยฐ E โ                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ููุงุญุธุงุช: [ุชู ุงูุชุฑููุจ ุจูุฌุงุญ ูุชูุนูู ุงูุดุงุดุฉ_______________]                โ
โ                                                                             โ
โ  ุชูููุน ุงูุนููู ุจุงุณุชูุงู ุงูุดุงุดุฉ: [โ๏ธ ุงูุชูููุน ุงูุฅููุชุฑููู] โ                   โ
โ                                                                             โ
โ                        [โ ุชุฃููุฏ ุฅุชูุงู ุงูุชุฑููุจ]                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 15.2 ุฌุฏูู ุชุฃููุฏ ุชุฑููุจ STS (sts_installation_confirmations)

```sql
CREATE TABLE sts_installation_confirmations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID NOT NULL REFERENCES stations(id),
    work_order_id UUID NOT NULL REFERENCES work_orders(id),
    customer_id UUID NOT NULL REFERENCES customers(id),
    technician_id UUID NOT NULL REFERENCES users(id),
    
    -- ุงูุนุฏุงุฏ STS
    meter_serial_number VARCHAR(100) NOT NULL,
    meter_confirmed BOOLEAN DEFAULT false,
    meter_opening_reading DECIMAL(15,3),
    meter_photo_url TEXT,
    
    -- ุดุงุดุฉ ุงูุนุฑุถ CIU
    ciu_serial_number VARCHAR(100) NOT NULL,
    ciu_confirmed BOOLEAN DEFAULT false,
    ciu_delivered_to_customer BOOLEAN DEFAULT false,
    ciu_activated BOOLEAN DEFAULT false,
    ciu_photo_url TEXT,
    
    -- ุงูุฎุชู
    seal_serial_number VARCHAR(100),
    seal_confirmed BOOLEAN DEFAULT false,
    seal_photo_url TEXT,
    
    -- ุงููุงุทุน
    breaker_serial_number VARCHAR(100),
    breaker_confirmed BOOLEAN DEFAULT false,
    breaker_amperage INTEGER,
    breaker_photo_url TEXT,
    
    -- ุงููููุน
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- ุงูุชูููุน
    customer_signature_url TEXT,
    customer_acknowledged_ciu_receipt BOOLEAN DEFAULT false,
    
    -- ุงูุญุงูุฉ
    confirmation_status ENUM('pending', 'confirmed', 'rejected') DEFAULT 'pending',
    confirmed_at TIMESTAMP,
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 15.3 Trigger ูุชุญุฏูุซ ุญุงูุฉ ุงูุฃุตูุงู ุงูุฃุฑุจุนุฉ ุนูุฏ ุชุฃููุฏ ุชุฑููุจ STS

```sql
CREATE OR REPLACE FUNCTION update_sts_items_on_installation()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.confirmation_status = 'confirmed' THEN
        -- ุชุญุฏูุซ ุญุงูุฉ ุงูุนุฏุงุฏ
        UPDATE meter_status_tracking
        SET current_status = 'installed',
            installed_customer_id = NEW.customer_id,
            installed_date = NOW()
        WHERE serial_number = NEW.meter_serial_number;
        
        -- ุชุญุฏูุซ ุญุงูุฉ ุดุงุดุฉ ุงูุนุฑุถ CIU
        UPDATE ciu_tracking
        SET current_status = 'installed',
            installed_meter_id = (SELECT id FROM meters WHERE serial_number = NEW.meter_serial_number),
            installed_customer_id = NEW.customer_id,
            installed_date = NOW()
        WHERE serial_number = NEW.ciu_serial_number;
        
        -- ุชุญุฏูุซ ุญุงูุฉ ุงูุฎุชู
        IF NEW.seal_serial_number IS NOT NULL THEN
            UPDATE seal_tracking
            SET current_status = 'installed',
                installed_meter_id = (SELECT id FROM meters WHERE serial_number = NEW.meter_serial_number),
                installed_customer_id = NEW.customer_id,
                installed_date = NOW()
            WHERE serial_number = NEW.seal_serial_number;
        END IF;
        
        -- ุชุญุฏูุซ ุญุงูุฉ ุงููุงุทุน
        IF NEW.breaker_serial_number IS NOT NULL THEN
            UPDATE breaker_tracking
            SET current_status = 'installed',
                installed_meter_id = (SELECT id FROM meters WHERE serial_number = NEW.meter_serial_number),
                installed_customer_id = NEW.customer_id,
                installed_date = NOW()
            WHERE serial_number = NEW.breaker_serial_number;
        END IF;
        
        -- ุชุณุฌูู ูู ุงูุณุฌู ุงูุชุงุฑูุฎู ููุฃุตูุงู ุงูุฃุฑุจุนุฉ
        INSERT INTO serialized_item_history (
            station_id, item_type, serial_number,
            from_status, to_status,
            to_location_type, to_location_id,
            reference_type, reference_id, performed_by,
            latitude, longitude
        ) VALUES
        -- ุงูุนุฏุงุฏ
        (NEW.station_id, 'meter', NEW.meter_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'sts_installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude),
        -- ุดุงุดุฉ ุงูุนุฑุถ
        (NEW.station_id, 'ciu', NEW.ciu_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'sts_installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude),
        -- ุงูุฎุชู
        (NEW.station_id, 'seal', NEW.seal_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'sts_installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude),
        -- ุงููุงุทุน
        (NEW.station_id, 'breaker', NEW.breaker_serial_number,
         'in_technician_custody', 'installed',
         'customer', NEW.customer_id,
         'sts_installation', NEW.id, NEW.technician_id,
         NEW.latitude, NEW.longitude);
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_sts_installation_confirmation
AFTER UPDATE ON sts_installation_confirmations
FOR EACH ROW
WHEN (NEW.confirmation_status = 'confirmed' AND OLD.confirmation_status != 'confirmed')
EXECUTE FUNCTION update_sts_items_on_installation();
```

### 15.4 View: ุงูุฃุตูุงู ุงูุฃุฑุจุนุฉ ุงููุฑูุจุฉ ูุนููู STS

```sql
CREATE OR REPLACE VIEW v_sts_customer_equipment AS
SELECT 
    c.id AS customer_id,
    c.name AS customer_name,
    c.account_number,
    
    -- ุงูุนุฏุงุฏ
    mst.serial_number AS meter_serial,
    m.meter_type,
    mst.installed_date AS meter_installed_date,
    
    -- ุดุงุดุฉ ุงูุนุฑุถ
    ciu.serial_number AS ciu_serial,
    ciu.ciu_type,
    ciu.installed_date AS ciu_installed_date,
    
    -- ุงูุฎุชู
    st.serial_number AS seal_serial,
    st.seal_type,
    st.installed_date AS seal_installed_date,
    
    -- ุงููุงุทุน
    bt.serial_number AS breaker_serial,
    bt.amperage AS breaker_amperage,
    bt.installed_date AS breaker_installed_date,
    
    -- ุตูุฑ ุงูุชุฑููุจ
    sic.meter_photo_url,
    sic.ciu_photo_url,
    sic.seal_photo_url,
    sic.breaker_photo_url,
    sic.customer_signature_url
    
FROM customers c
INNER JOIN meters m ON m.customer_id = c.id AND m.meter_type = 'sts_prepaid'
LEFT JOIN meter_status_tracking mst ON mst.serial_number = m.serial_number AND mst.current_status = 'installed'
LEFT JOIN ciu_tracking ciu ON ciu.installed_customer_id = c.id AND ciu.current_status = 'installed'
LEFT JOIN seal_tracking st ON st.installed_customer_id = c.id AND st.current_status = 'installed'
LEFT JOIN breaker_tracking bt ON bt.installed_customer_id = c.id AND bt.current_status = 'installed'
LEFT JOIN sts_installation_confirmations sic ON sic.customer_id = c.id AND sic.confirmation_status = 'confirmed';
```

### 15.5 APIs ุชุฑููุจ STS

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | /api/v1/sts/installations/confirm | ุชุฃููุฏ ุชุฑููุจ STS ูุงูู |
| GET | /api/v1/sts/installations/:work_order_id | ุจูุงูุงุช ุชุฑููุจ STS |
| GET | /api/v1/customers/:id/sts-equipment | ุงูุฃุตูุงู ุงูุฃุฑุจุนุฉ ูุนููู STS |
| POST | /api/v1/sts/installations/upload-photos | ุฑูุน ุตูุฑ ุงูุชุฑููุจ |
| GET | /api/v1/sts/installation-kit/validate | ุงูุชุญูู ูู ูุทุงุจูุฉ ุงูุฃุตูุงู |


---

# 15. ูุญุฏุฉ ุฌููุงุช ุงููุฑุงุกุฉ ุงููุฏููุฉ (Manual Reading Rounds)

## 15.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุชูููุฑ ูุธุงู ุฑููู ูุฌุฏููุฉ ูุชูููุฐ ูุชุณุฌูู ุฌููุงุช ุงููุฑุงุกุฉ ุงููุฏููุฉ ููุนุฏุงุฏุงุช ูุงูุฃุฌูุฒุฉ ุบูุฑ ุงููุชุตูุฉุ ูุน ุฏูุฌ ุงูุจูุงูุงุช ูู ููุณ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุชู ุชุณุชูุจู ุงูุจูุงูุงุช ุงูุขููุฉ.

### ุงููุจุงุฏุฆ ุงูุฃุณุงุณูุฉ

1. **ุชูุญูุฏ ุงูุจูุงูุงุช:** ุงูุจูุงูุงุช ุงููุฏููุฉ ูุงูุขููุฉ ูู ููุณ ุงูุฌุฏุงูู
2. **ุชูููุฒ ุงููุตุฏุฑ:** ุญูู `data_source` ูุชุญุฏูุฏ ูุตุฏุฑ ูู ูุฑุงุกุฉ
3. **ูุณุงุฑ ุชุฑููุฉ ุณูุณ:** ุงูุงูุชูุงู ูู ูุฏูู ูุขูู ุจุชุบููุฑ ุฅุนุฏุงุฏ ูุงุญุฏ
4. **ุชุฌุฑุจุฉ ูุณุชุฎุฏู ูุชุณูุฉ:** ููุณ ุงููุงุฌูุงุช ููุจูุงูุงุช ุงููุฏููุฉ ูุงูุขููุฉ

## 15.2 ุฌุฏูู ููุงูุจ ุงูุฌููุงุช (reading_round_templates)

```sql
CREATE TABLE reading_round_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    station_id UUID NOT NULL REFERENCES stations(id),
    
    -- ูุนูููุงุช ุงููุงูุจ
    template_name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- ุงูุฌุฏููุฉ
    schedule_type ENUM(
        'daily',              -- ูููู
        'shift',              -- ูู ูุฑุฏูุฉ (8 ุณุงุนุงุช)
        'weekly',             -- ุฃุณุจูุนู
        'monthly',            -- ุดูุฑู
        'custom'              -- ูุฎุตุต
    ) NOT NULL,
    schedule_time TIME,                    -- ููุช ุงูุจุฏุก
    schedule_days VARCHAR(20),             -- ุฃูุงู ุงูุฃุณุจูุน (ููุฃุณุจูุนู)
    schedule_interval_hours INT,           -- ุงููุชุฑุฉ ุจุงูุณุงุนุงุช (ูููุฎุตุต)
    
    -- ุงูุฅุณูุงุฏ ุงูุงูุชุฑุงุถู
    default_assigned_role VARCHAR(100),    -- ุงูุฏูุฑ ุงููุณูุฏ ุฅููู
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT true,
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_round_templates_station ON reading_round_templates(station_id);
```

## 15.3 ุฌุฏูู ุนูุงุตุฑ ูุงูุจ ุงูุฌููุฉ (reading_round_template_items)

```sql
CREATE TABLE reading_round_template_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL REFERENCES reading_round_templates(id) ON DELETE CASCADE,
    
    -- ุงูุฃุตู ุงููุทููุจ ูุฑุงุกุชู
    asset_type ENUM('generator', 'transformer', 'meter', 'panel', 'other') NOT NULL,
    asset_id UUID NOT NULL,
    asset_name VARCHAR(200) NOT NULL,
    
    -- ุชุฑุชูุจ ุงูุฒูุงุฑุฉ
    visit_order INT NOT NULL,
    
    -- ุงููููุน
    location_description VARCHAR(500),
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_template_items_template ON reading_round_template_items(template_id);
```

## 15.4 ุฌุฏูู ุญููู ุงููุฑุงุกุฉ ุงููุทููุจุฉ (reading_fields)

```sql
CREATE TABLE reading_fields (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_item_id UUID NOT NULL REFERENCES reading_round_template_items(id) ON DELETE CASCADE,
    
    -- ุชุนุฑูู ุงูุญูู
    field_code VARCHAR(50) NOT NULL,
    field_name_ar VARCHAR(200) NOT NULL,
    field_name_en VARCHAR(200) NOT NULL,
    
    -- ููุน ุงูุจูุงูุงุช
    data_type ENUM('number', 'decimal', 'text', 'boolean', 'select') NOT NULL,
    unit VARCHAR(50),                      -- ุงููุญุฏุฉ (kWh, ุณุงุนุฉ, ูุชุฑ, ุฅูุฎ)
    
    -- ุงูุชุญูู ูู ุงูุตุญุฉ
    is_required BOOLEAN DEFAULT true,
    min_value DECIMAL(15, 4),
    max_value DECIMAL(15, 4),
    must_be_greater_than_previous BOOLEAN DEFAULT false,  -- ููุนุฏุงุฏุงุช ุงูุชุฑุงูููุฉ
    
    -- ูุงุฆูุฉ ุงูุฎูุงุฑุงุช (ูููุน select)
    select_options JSONB,                  -- ["ุฌูุฏ", "ูุชูุณุท", "ุณูุก"]
    
    -- ุงูุชุฑุชูุจ
    display_order INT NOT NULL,
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- ุฃูุซูุฉ ุนูู ุญููู ุงููุฑุงุกุฉ ูููููุฏุงุช
INSERT INTO reading_fields (template_item_id, field_code, field_name_ar, field_name_en, data_type, unit, must_be_greater_than_previous, display_order) VALUES
-- ุณูุชู ุฅุฏุฑุงุฌูุง ุนูุฏ ุฅูุดุงุก ุงููุงูุจ
('...', 'running_hours', 'ุณุงุนุงุช ุงูุชุดุบูู', 'Running Hours', 'decimal', 'ุณุงุนุฉ', true, 1),
('...', 'kwh_reading', 'ูุฑุงุกุฉ ุงูุทุงูุฉ', 'Energy Reading', 'decimal', 'kWh', true, 2),
('...', 'fuel_level', 'ูุณุชูู ุงููููุฏ', 'Fuel Level', 'number', '%', false, 3),
('...', 'oil_pressure', 'ุถุบุท ุงูุฒูุช', 'Oil Pressure', 'decimal', 'bar', false, 4),
('...', 'coolant_temp', 'ุฏุฑุฌุฉ ุญุฑุงุฑุฉ ุงููุจุฑุฏ', 'Coolant Temperature', 'number', 'ยฐC', false, 5);
```

## 15.5 ุฌุฏูู ุฌููุงุช ุงููุฑุงุกุฉ ุงููุฌุฏููุฉ (scheduled_reading_rounds)

```sql
CREATE TABLE scheduled_reading_rounds (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    template_id UUID NOT NULL REFERENCES reading_round_templates(id),
    station_id UUID NOT NULL REFERENCES stations(id),
    
    -- ูุนูููุงุช ุงูุฌููุฉ
    round_name VARCHAR(200) NOT NULL,
    scheduled_date DATE NOT NULL,
    scheduled_time TIME NOT NULL,
    
    -- ุงูุฅุณูุงุฏ
    assigned_to UUID NOT NULL REFERENCES users(id),
    assigned_by UUID REFERENCES users(id),
    assigned_at TIMESTAMP DEFAULT NOW(),
    
    -- ุงูุญุงูุฉ
    status ENUM(
        'scheduled',          -- ูุฌุฏููุฉ
        'in_progress',        -- ููุฏ ุงูุชูููุฐ
        'completed',          -- ููุชููุฉ
        'partial',            -- ููุชููุฉ ุฌุฒุฆูุงู
        'missed',             -- ูุงุฆุชุฉ
        'cancelled'           -- ููุบุงุฉ
    ) DEFAULT 'scheduled',
    
    -- ุงูุชูููุฐ
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    
    -- ุงูููุงุญุธุงุช
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_scheduled_rounds_date ON scheduled_reading_rounds(scheduled_date);
CREATE INDEX idx_scheduled_rounds_assigned ON scheduled_reading_rounds(assigned_to);
CREATE INDEX idx_scheduled_rounds_status ON scheduled_reading_rounds(status);
```

## 15.6 ุฌุฏูู ุงููุฑุงุกุงุช ุงููุณุฌูุฉ (recorded_readings)

```sql
CREATE TABLE recorded_readings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    round_id UUID NOT NULL REFERENCES scheduled_reading_rounds(id),
    template_item_id UUID NOT NULL REFERENCES reading_round_template_items(id),
    
    -- ุงูุฃุตู
    asset_type VARCHAR(50) NOT NULL,
    asset_id UUID NOT NULL,
    
    -- ุงููุฑุงุกุงุช (JSONB ูููุฑููุฉ)
    readings JSONB NOT NULL,
    -- ูุซุงู: {"running_hours": 1234.5, "kwh_reading": 56789, "fuel_level": 75}
    
    -- ุงูุจูุงูุงุช ุงููุตููุฉ
    recorded_by UUID NOT NULL REFERENCES users(id),
    recorded_at TIMESTAMP NOT NULL DEFAULT NOW(),
    
    -- ุงููููุน ุงูุฌุบุฑุงูู (ููุชุญูู)
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    
    -- ุงูุตูุฑ ุงููุฑููุฉ
    photos JSONB,                          -- ["url1", "url2"]
    
    -- ุงูููุงุญุธุงุช
    notes TEXT,
    
    -- ุนูุงูุงุช ุงูุชุญูู
    validation_status ENUM('valid', 'warning', 'error') DEFAULT 'valid',
    validation_messages JSONB,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_recorded_readings_round ON recorded_readings(round_id);
CREATE INDEX idx_recorded_readings_asset ON recorded_readings(asset_type, asset_id);
CREATE INDEX idx_recorded_readings_time ON recorded_readings(recorded_at);
```

## 15.7 ุดุงุดุฉ ุฅูุดุงุก ูุงูุจ ุฌููุฉ ุงููุฑุงุกุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     ๐ ุฅูุดุงุก ูุงูุจ ุฌููุฉ ูุฑุงุกุฉ ุฌุฏูุฏ                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุงุณู ุงููุงูุจ: [ูุฑุงุกุงุช ูููุฏุงุช ูุญุทุฉ ุงูุดูุงู - ูุฑุฏูุฉ ุงูุตุจุงุญ          ]          โ
โ  ุงููุตู:      [ุฌููุฉ ูุฑุงุกุฉ ููููุฉ ูุฌููุน ูููุฏุงุช ุงููุญุทุฉ             ]          โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                              ุงูุฌุฏููุฉ                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ููุน ุงูุฌุฏููุฉ: (โ) ูููู  ( ) ูู ูุฑุฏูุฉ  ( ) ุฃุณุจูุนู  ( ) ุดูุฑู  ( ) ูุฎุตุต      โ
โ  ููุช ุงูุจุฏุก:   [08:00 โผ]                                                    โ
โ  ุงูุฏูุฑ ุงููุณูุฏ: [ูุดุบู ุงููุฑุฏูุฉ โผ]                                            โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ุงูุฃุตูู ุงููุทููุจ ูุฑุงุกุชูุง                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุฃุตูู ุงููุชุงุญุฉ              โ  ุงูุฃุตูู ูู ุงูุฌููุฉ                    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ ๐ฒ ุงููููุฏ G1 - Caterpillar โ  1. โ ุงููููุฏ G2 - Cummins           โ   โ
โ  โ ๐ฒ ุงููููุฏ G3 - Perkins     โ  2. โ ุงููููุฏ G4 - Volvo             โ   โ
โ  โ ๐ฒ ุงููุญูู T1               โ     [โฌ๏ธ] [โฌ๏ธ] [โ]                    โ   โ
โ  โ ๐ฒ ุงููุญูู T2               โ                                       โ   โ
โ  โ                             โ                                       โ   โ
โ  โ        [โก๏ธ ุฅุถุงูุฉ]          โ        [โฌ๏ธ ุฅุฒุงูุฉ]                    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                    ุญููู ุงููุฑุงุกุฉ ููุฃุตู ุงููุญุฏุฏ: ุงููููุฏ G2                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงูุญูู          โ ุงูููุน   โ ุงููุญุฏุฉ โ ุฅุฌุจุงุฑู โ ุชุญูู ุชุตุงุนุฏู          โ   โ
โ  โโโโโโโโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโผโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ ุณุงุนุงุช ุงูุชุดุบูู โ ุฑูู    โ ุณุงุนุฉ  โ โ     โ โ                   โ   โ
โ  โ ูุฑุงุกุฉ ุงูุทุงูุฉ  โ ุฑูู    โ kWh   โ โ     โ โ                   โ   โ
โ  โ ูุณุชูู ุงููููุฏ โ ุฑูู    โ %     โ โ     โ โ                   โ   โ
โ  โ ุถุบุท ุงูุฒูุช    โ ุฑูู    โ bar   โ โ     โ โ                   โ   โ
โ  โ ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ โ ุฑูู    โ ยฐC    โ โ     โ โ                   โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  [โ ุฅุถุงูุฉ ุญูู]                                                            โ
โ                                                                             โ
โ              [โ ุฅูุบุงุก]                    [โ ุญูุธ ุงููุงูุจ]                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.8 ุดุงุดุฉ ุชุทุจูู ุงูููู - ุฌููุฉ ุงููุฑุงุกุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฑ ุชุทุจูู ุงูููู                                              ๐ 85%  ๐ถ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  ๐ ุฌููุฉ ุงููุฑุงุกุฉ: ูุฑุงุกุงุช ุงููููุฏุงุช - ูุฑุฏูุฉ ุงูุตุจุงุญ                   โ   โ
โ  โ  ๐ 16/12/2024  โฐ 08:00                                            โ   โ
โ  โ  ๐ ุงูุชูุฏู: โโโโโโโโโโโโโโโโ 2/4 (50%)                             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ุงูุฃุตูู ูู ุงูุฌููุฉ                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  1. โ ุงููููุฏ G2 - Cummins                        [ุชู โ]           โ   โ
โ  โ     ๐ ุบุฑูุฉ ุงููููุฏุงุช - ุงูุฌูุงุญ ุงูุดุฑูู                               โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ  2. โ ุงููููุฏ G4 - Volvo                          [ุชู โ]           โ   โ
โ  โ     ๐ ุบุฑูุฉ ุงููููุฏุงุช - ุงูุฌูุงุญ ุงูุบุฑุจู                               โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ  3. โณ ุงููุญูู T1                                  [ุฅุฏุฎุงู ุงููุฑุงุกุฉ]  โ   โ
โ  โ     ๐ ุบุฑูุฉ ุงููุญููุงุช ุงูุฑุฆูุณูุฉ                                      โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค   โ
โ  โ  4. โฌ ุงููุญูู T2                                  [ูู ุงูุงูุชุธุงุฑ]    โ   โ
โ  โ     ๐ ุบุฑูุฉ ุงููุญููุงุช ุงูุงุญุชูุงุทูุฉ                                    โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ                         [๐ค ุฅุฑุณุงู ุงูุฌููุฉ]                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.9 ุดุงุดุฉ ุฅุฏุฎุงู ุงููุฑุงุกุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฑ ุฅุฏุฎุงู ูุฑุงุกุฉ: ุงููููุฏ G2 - Cummins                         ๐ 85%  ๐ถ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  ๐ ุงููููุน: ุบุฑูุฉ ุงููููุฏุงุช - ุงูุฌูุงุญ ุงูุดุฑูู                          โ   โ
โ  โ  โฐ ุขุฎุฑ ูุฑุงุกุฉ: 15/12/2024 08:15 ุจูุงุณุทุฉ: ูุญูุฏ ุฃุญูุฏ                  โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                              ุงููุฑุงุกุงุช                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ุณุงุนุงุช ุงูุชุดุบูู (ุณุงุนุฉ): *                                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 1234.5                                                             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  ๐ ุงููุฑุงุกุฉ ุงูุณุงุจูุฉ: 1230.2                                               โ
โ                                                                             โ
โ  ูุฑุงุกุฉ ุงูุทุงูุฉ (kWh): *                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 56789                                                              โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  ๐ ุงููุฑุงุกุฉ ุงูุณุงุจูุฉ: 56750                                                โ
โ                                                                             โ
โ  ูุณุชูู ุงููููุฏ (%): *                                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 75                                                                 โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ุถุบุท ุงูุฒูุช (bar):                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ 4.2                                                                โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  ููุงุญุธุงุช:                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ุงููููุฏ ูุนูู ุจุดูู ุทุจูุนู                                             โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [๐ท ุฅุถุงูุฉ ุตูุฑุฉ]                                                           โ
โ                                                                             โ
โ              [โฌ๏ธ ุงูุณุงุจู]                    [โ ุญูุธ ูุงูุชุงูู]               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 15.10 Trigger ุฅูุดุงุก ุงูุฌููุงุช ุงููุฌุฏููุฉ ุชููุงุฆูุงู

```sql
CREATE OR REPLACE FUNCTION generate_scheduled_rounds()
RETURNS void AS $$
DECLARE
    v_template RECORD;
    v_next_date DATE;
    v_next_time TIME;
BEGIN
    FOR v_template IN 
        SELECT * FROM reading_round_templates 
        WHERE is_active = true
    LOOP
        -- ุญุณุงุจ ุงูุชุงุฑูุฎ ุงูุชุงูู ุญุณุจ ููุน ุงูุฌุฏููุฉ
        CASE v_template.schedule_type
            WHEN 'daily' THEN
                v_next_date := CURRENT_DATE + INTERVAL '1 day';
                v_next_time := v_template.schedule_time;
            WHEN 'shift' THEN
                -- ูู 8 ุณุงุนุงุช
                v_next_date := CURRENT_DATE;
                v_next_time := v_template.schedule_time;
            WHEN 'weekly' THEN
                -- ุญุณุงุจ ุงูููู ุงูุชุงูู ูู ุฃูุงู ุงูุฃุณุจูุน ุงููุญุฏุฏุฉ
                v_next_date := CURRENT_DATE + INTERVAL '7 days';
                v_next_time := v_template.schedule_time;
            ELSE
                v_next_date := CURRENT_DATE + INTERVAL '1 day';
                v_next_time := v_template.schedule_time;
        END CASE;
        
        -- ุฅูุดุงุก ุงูุฌููุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        INSERT INTO scheduled_reading_rounds (
            template_id, station_id, round_name,
            scheduled_date, scheduled_time, assigned_to, status
        )
        SELECT 
            v_template.id,
            v_template.station_id,
            v_template.template_name || ' - ' || v_next_date,
            v_next_date,
            v_next_time,
            (SELECT id FROM users WHERE role_code = v_template.default_assigned_role LIMIT 1),
            'scheduled'
        WHERE NOT EXISTS (
            SELECT 1 FROM scheduled_reading_rounds
            WHERE template_id = v_template.id
            AND scheduled_date = v_next_date
        );
    END LOOP;
END;
$$ LANGUAGE plpgsql;

-- ุฌุฏููุฉ ุงูุชูููุฐ ููููุงู
-- ูุชู ุงุณุชุฏุนุงุก ูุฐู ุงูุฏุงูุฉ ุนุจุฑ cron job ุฃู pg_cron
```

## 15.11 Function ุงูุชุญูู ูู ุตุญุฉ ุงููุฑุงุกุฉ

```sql
CREATE OR REPLACE FUNCTION validate_reading(
    p_template_item_id UUID,
    p_field_code VARCHAR(50),
    p_new_value DECIMAL,
    p_asset_id UUID
) RETURNS JSONB AS $$
DECLARE
    v_field RECORD;
    v_previous_value DECIMAL;
    v_result JSONB := '{"valid": true, "messages": []}'::JSONB;
BEGIN
    -- ุงูุญุตูู ุนูู ุชุนุฑูู ุงูุญูู
    SELECT * INTO v_field
    FROM reading_fields
    WHERE template_item_id = p_template_item_id
    AND field_code = p_field_code;
    
    IF NOT FOUND THEN
        RETURN '{"valid": false, "messages": ["ุญูู ุบูุฑ ูุนุฑู"]}'::JSONB;
    END IF;
    
    -- ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃุฏูู
    IF v_field.min_value IS NOT NULL AND p_new_value < v_field.min_value THEN
        v_result := jsonb_set(v_result, '{valid}', 'false');
        v_result := jsonb_set(v_result, '{messages}', 
            v_result->'messages' || jsonb_build_array('ุงููููุฉ ุฃูู ูู ุงูุญุฏ ุงูุฃุฏูู: ' || v_field.min_value));
    END IF;
    
    -- ุงูุชุญูู ูู ุงูุญุฏ ุงูุฃูุตู
    IF v_field.max_value IS NOT NULL AND p_new_value > v_field.max_value THEN
        v_result := jsonb_set(v_result, '{valid}', 'false');
        v_result := jsonb_set(v_result, '{messages}', 
            v_result->'messages' || jsonb_build_array('ุงููููุฉ ุฃูุจุฑ ูู ุงูุญุฏ ุงูุฃูุตู: ' || v_field.max_value));
    END IF;
    
    -- ุงูุชุญูู ูู ุงูุชุตุงุนุฏ (ููุนุฏุงุฏุงุช ุงูุชุฑุงูููุฉ)
    IF v_field.must_be_greater_than_previous THEN
        SELECT (readings->>p_field_code)::DECIMAL INTO v_previous_value
        FROM recorded_readings
        WHERE asset_id = p_asset_id
        ORDER BY recorded_at DESC
        LIMIT 1;
        
        IF v_previous_value IS NOT NULL AND p_new_value < v_previous_value THEN
            v_result := jsonb_set(v_result, '{valid}', 'false');
            v_result := jsonb_set(v_result, '{messages}', 
                v_result->'messages' || jsonb_build_array('ุงููุฑุงุกุฉ ูุฌุจ ุฃู ุชููู ุฃูุจุฑ ูู ุงูุณุงุจูุฉ: ' || v_previous_value));
        END IF;
    END IF;
    
    RETURN v_result;
END;
$$ LANGUAGE plpgsql;
```

## 15.12 APIs ุฌููุงุช ุงููุฑุงุกุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/reading-rounds/templates` | ููุงูุจ ุงูุฌููุงุช |
| POST | `/api/v1/reading-rounds/templates` | ุฅูุดุงุก ูุงูุจ ุฌุฏูุฏ |
| GET | `/api/v1/reading-rounds/scheduled` | ุงูุฌููุงุช ุงููุฌุฏููุฉ |
| GET | `/api/v1/reading-rounds/my-rounds` | ุฌููุงุชู (ููููู) |
| POST | `/api/v1/reading-rounds/:id/start` | ุจุฏุก ุงูุฌููุฉ |
| POST | `/api/v1/reading-rounds/:id/readings` | ุฅุฑุณุงู ุงููุฑุงุกุงุช |
| POST | `/api/v1/reading-rounds/:id/complete` | ุฅููุงู ุงูุฌููุฉ |
| POST | `/api/v1/readings/validate` | ุงูุชุญูู ูู ุตุญุฉ ุงููุฑุงุกุฉ |


---

# 12. ูุญุฏุฉ ุชุชุจุน ุงููุฑู ุงูููุฏุงููุฉ (Field Team GPS Tracking)

## 12.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุชุชุจุน ุญุฑูุฉ ุงูููุธููู ุงูููุฏุงูููู ูู ุงูููุช ุงููุนูู ุนุจุฑ GPSุ ูุน ุงุญุชุฑุงู ุงูุฎุตูุตูุฉ ูุงูุดูุงููุฉ.

### ุงููุฒุงูุง ุงูุฑุฆูุณูุฉ

1. **ุฅุณูุงุฏ ุฐูู ููููุงู:** ุชุญุฏูุฏ ุฃูุฑุจ ููู ูููููุน ุงูุทุงุฑุฆ
2. **ุงูุชุญูู ูู ุงูุฅูุฌุงุฒ:** ููุงุฑูุฉ ูููุน ุงูููู ุจูููุน ุงููููุฉ
3. **ุชุญุณูู ุงููุณุงุฑุงุช:** ุชูููู ุงูุชููู ุบูุฑ ุงูุถุฑูุฑู
4. **ุงูุณูุงูุฉ:** ูุนุฑูุฉ ุขุฎุฑ ูููุน ูู ุญุงูุงุช ุงูุทูุงุฑุฆ

## 12.2 ุฌุฏูู ุณุฌู ุชุชุจุน ุงูููุงูุน (location_tracking_log)

```sql
CREATE TABLE location_tracking_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    
    -- ุจูุงูุงุช ุงููููุน
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    altitude DECIMAL(8, 2),
    accuracy_meters DECIMAL(8, 2),
    
    -- ุงูุณุฑุนุฉ ูุงูุงุชุฌุงู
    speed_kmh DECIMAL(6, 2),
    heading_degrees DECIMAL(5, 2),
    
    -- ูุตุฏุฑ ุงูุจูุงูุงุช
    source ENUM('gps', 'network', 'wifi') DEFAULT 'gps',
    device_id VARCHAR(100),
    app_version VARCHAR(20),
    
    -- ุญุงูุฉ ุงูููุธู
    employee_status ENUM(
        'available',          -- ูุชุงุญ
        'on_task',            -- ูุดุบูู ูู ูููุฉ
        'on_break',           -- ูู ุงุณุชุฑุงุญุฉ
        'traveling',          -- ูู ุงูุทุฑูู
        'offline'             -- ุบูุฑ ูุชุตู
    ) DEFAULT 'available',
    
    current_task_id UUID REFERENCES work_orders(id),
    
    -- ูุนูููุงุช ุงูุจุทุงุฑูุฉ
    battery_level INT,
    is_charging BOOLEAN,
    
    -- ุงูุทุงุจุน ุงูุฒููู
    recorded_at TIMESTAMP NOT NULL,
    received_at TIMESTAMP DEFAULT NOW(),
    
    -- ููุฑุณุฉ ููุฃุฏุงุก
    CONSTRAINT valid_coordinates CHECK (
        latitude BETWEEN -90 AND 90 AND
        longitude BETWEEN -180 AND 180
    )
);

-- ููุงุฑุณ ููุฃุฏุงุก
CREATE INDEX idx_location_employee ON location_tracking_log(employee_id);
CREATE INDEX idx_location_time ON location_tracking_log(recorded_at DESC);
CREATE INDEX idx_location_employee_time ON location_tracking_log(employee_id, recorded_at DESC);

-- ุชูุณูู ุงูุฌุฏูู ุญุณุจ ุงูุดูุฑ ููุฃุฏุงุก
-- CREATE TABLE location_tracking_log_2024_12 PARTITION OF location_tracking_log
-- FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
```

## 12.3 ุฌุฏูู ุฅุนุฏุงุฏุงุช ุงูุชุชุจุน (tracking_settings)

```sql
CREATE TABLE tracking_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ูุทุงู ุงูุฅุนุฏุงุฏ
    scope_type ENUM('global', 'branch', 'station', 'employee') NOT NULL,
    scope_id UUID,                                -- NULL ููุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ
    
    -- ุฅุนุฏุงุฏุงุช ุงูุชุชุจุน
    is_tracking_enabled BOOLEAN DEFAULT true,
    tracking_interval_seconds INT DEFAULT 300,    -- ูู 5 ุฏูุงุฆู
    
    -- ุณุงุนุงุช ุงูุชุชุจุน
    tracking_start_time TIME DEFAULT '08:00',
    tracking_end_time TIME DEFAULT '16:00',
    track_on_weekends BOOLEAN DEFAULT false,
    
    -- ุฅุนุฏุงุฏุงุช ุงูุฎุตูุตูุฉ
    show_notification BOOLEAN DEFAULT true,       -- ุฅุธูุงุฑ ุฅุดุนุงุฑ ููููุธู
    allow_employee_pause BOOLEAN DEFAULT false,   -- ุงูุณูุงุญ ุจุฅููุงู ูุคูุช
    
    -- ุฅุนุฏุงุฏุงุช ุงูุจุทุงุฑูุฉ
    reduce_frequency_low_battery BOOLEAN DEFAULT true,
    low_battery_threshold INT DEFAULT 20,
    low_battery_interval_seconds INT DEFAULT 900, -- ูู 15 ุฏูููุฉ
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(scope_type, scope_id)
);

-- ุงูุฅุนุฏุงุฏุงุช ุงูุงูุชุฑุงุถูุฉ
INSERT INTO tracking_settings (scope_type, is_tracking_enabled) 
VALUES ('global', true);
```

## 12.4 ุฌุฏูู ุขุฎุฑ ูููุน ูุนุฑูู (last_known_locations)

```sql
CREATE TABLE last_known_locations (
    employee_id UUID PRIMARY KEY REFERENCES employees(id),
    
    -- ุขุฎุฑ ูููุน
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    accuracy_meters DECIMAL(8, 2),
    
    -- ุงูุญุงูุฉ
    employee_status ENUM('available', 'on_task', 'on_break', 'traveling', 'offline') DEFAULT 'available',
    current_task_id UUID REFERENCES work_orders(id),
    
    -- ูุนูููุงุช ุฅุถุงููุฉ
    battery_level INT,
    last_update TIMESTAMP NOT NULL,
    is_online BOOLEAN DEFAULT true,
    
    -- ุญุณุงุจ ุงูููุช ููุฐ ุขุฎุฑ ุชุญุฏูุซ
    offline_threshold_minutes INT DEFAULT 15
);

CREATE INDEX idx_last_location_status ON last_known_locations(employee_status);
CREATE INDEX idx_last_location_online ON last_known_locations(is_online);
```

## 12.5 API ุงุณุชูุจุงู ุจูุงูุงุช ุงููููุน

```sql
CREATE OR REPLACE FUNCTION receive_location_data(
    p_employee_id UUID,
    p_latitude DECIMAL(10, 8),
    p_longitude DECIMAL(11, 8),
    p_accuracy DECIMAL(8, 2),
    p_speed DECIMAL(6, 2) DEFAULT NULL,
    p_heading DECIMAL(5, 2) DEFAULT NULL,
    p_source VARCHAR(10) DEFAULT 'gps',
    p_device_id VARCHAR(100) DEFAULT NULL,
    p_battery_level INT DEFAULT NULL,
    p_status VARCHAR(20) DEFAULT 'available',
    p_task_id UUID DEFAULT NULL,
    p_recorded_at TIMESTAMP DEFAULT NOW()
) RETURNS JSONB AS $$
DECLARE
    v_settings RECORD;
    v_schedule RECORD;
    v_current_time TIME;
    v_is_within_hours BOOLEAN;
BEGIN
    -- ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูุชุชุจุน
    SELECT * INTO v_settings
    FROM tracking_settings
    WHERE scope_type = 'global' OR 
          (scope_type = 'employee' AND scope_id = p_employee_id)
    ORDER BY CASE scope_type WHEN 'employee' THEN 1 ELSE 2 END
    LIMIT 1;
    
    IF NOT v_settings.is_tracking_enabled THEN
        RETURN jsonb_build_object('success', false, 'error', 'ุงูุชุชุจุน ูุนุทู');
    END IF;
    
    -- ุงูุชุญูู ูู ุณุงุนุงุช ุงูุนูู
    v_current_time := p_recorded_at::TIME;
    v_is_within_hours := v_current_time BETWEEN v_settings.tracking_start_time AND v_settings.tracking_end_time;
    
    IF NOT v_is_within_hours THEN
        RETURN jsonb_build_object('success', false, 'error', 'ุฎุงุฑุฌ ุณุงุนุงุช ุงูุนูู');
    END IF;
    
    -- ุฅุฏุฑุงุฌ ุณุฌู ุงููููุน
    INSERT INTO location_tracking_log (
        employee_id, latitude, longitude, accuracy_meters,
        speed_kmh, heading_degrees, source, device_id,
        battery_level, employee_status, current_task_id, recorded_at
    ) VALUES (
        p_employee_id, p_latitude, p_longitude, p_accuracy,
        p_speed, p_heading, p_source, p_device_id,
        p_battery_level, p_status, p_task_id, p_recorded_at
    );
    
    -- ุชุญุฏูุซ ุขุฎุฑ ูููุน ูุนุฑูู
    INSERT INTO last_known_locations (
        employee_id, latitude, longitude, accuracy_meters,
        employee_status, current_task_id, battery_level, last_update, is_online
    ) VALUES (
        p_employee_id, p_latitude, p_longitude, p_accuracy,
        p_status, p_task_id, p_battery_level, p_recorded_at, true
    )
    ON CONFLICT (employee_id) DO UPDATE SET
        latitude = EXCLUDED.latitude,
        longitude = EXCLUDED.longitude,
        accuracy_meters = EXCLUDED.accuracy_meters,
        employee_status = EXCLUDED.employee_status,
        current_task_id = EXCLUDED.current_task_id,
        battery_level = EXCLUDED.battery_level,
        last_update = EXCLUDED.last_update,
        is_online = true;
    
    RETURN jsonb_build_object('success', true);
END;
$$ LANGUAGE plpgsql;
```

## 12.6 Function ุฅูุฌุงุฏ ุฃูุฑุจ ููู

```sql
CREATE OR REPLACE FUNCTION find_nearest_technician(
    p_latitude DECIMAL(10, 8),
    p_longitude DECIMAL(11, 8),
    p_skill_required VARCHAR(100) DEFAULT NULL,
    p_max_distance_km DECIMAL(6, 2) DEFAULT 50
) RETURNS TABLE (
    employee_id UUID,
    employee_name VARCHAR,
    distance_km DECIMAL(8, 2),
    employee_status VARCHAR,
    battery_level INT,
    last_update TIMESTAMP
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        lkl.employee_id,
        e.full_name,
        -- ุญุณุงุจ ุงููุณุงูุฉ ุจุงููููููุชุฑ (ุตูุบุฉ Haversine ูุจุณุทุฉ)
        ROUND(
            6371 * ACOS(
                COS(RADIANS(p_latitude)) * COS(RADIANS(lkl.latitude)) *
                COS(RADIANS(lkl.longitude) - RADIANS(p_longitude)) +
                SIN(RADIANS(p_latitude)) * SIN(RADIANS(lkl.latitude))
            )::DECIMAL, 2
        ) AS distance_km,
        lkl.employee_status::VARCHAR,
        lkl.battery_level,
        lkl.last_update
    FROM last_known_locations lkl
    JOIN employees e ON e.id = lkl.employee_id
    WHERE lkl.is_online = true
    AND lkl.employee_status = 'available'
    AND (p_skill_required IS NULL OR e.skills @> ARRAY[p_skill_required])
    HAVING ROUND(
        6371 * ACOS(
            COS(RADIANS(p_latitude)) * COS(RADIANS(lkl.latitude)) *
            COS(RADIANS(lkl.longitude) - RADIANS(p_longitude)) +
            SIN(RADIANS(p_latitude)) * SIN(RADIANS(lkl.latitude))
        )::DECIMAL, 2
    ) <= p_max_distance_km
    ORDER BY distance_km ASC
    LIMIT 10;
END;
$$ LANGUAGE plpgsql;
```

## 12.7 Function ุงุณุชุฑุฌุงุน ูุณุงุฑ ุงูููู

```sql
CREATE OR REPLACE FUNCTION get_employee_route(
    p_employee_id UUID,
    p_date DATE DEFAULT CURRENT_DATE
) RETURNS TABLE (
    point_number INT,
    latitude DECIMAL(10, 8),
    longitude DECIMAL(11, 8),
    recorded_at TIMESTAMP,
    employee_status VARCHAR,
    task_id UUID,
    task_description VARCHAR,
    stop_duration_minutes INT
) AS $$
BEGIN
    RETURN QUERY
    WITH route_points AS (
        SELECT 
            ROW_NUMBER() OVER (ORDER BY ltl.recorded_at) AS point_num,
            ltl.latitude,
            ltl.longitude,
            ltl.recorded_at,
            ltl.employee_status,
            ltl.current_task_id,
            wo.description AS task_desc,
            -- ุญุณุงุจ ูุฏุฉ ุงูุชููู
            EXTRACT(EPOCH FROM (
                LEAD(ltl.recorded_at) OVER (ORDER BY ltl.recorded_at) - ltl.recorded_at
            )) / 60 AS stop_mins
        FROM location_tracking_log ltl
        LEFT JOIN work_orders wo ON wo.id = ltl.current_task_id
        WHERE ltl.employee_id = p_employee_id
        AND DATE(ltl.recorded_at) = p_date
    )
    SELECT 
        point_num::INT,
        rp.latitude,
        rp.longitude,
        rp.recorded_at,
        rp.employee_status::VARCHAR,
        rp.current_task_id,
        rp.task_desc,
        COALESCE(rp.stop_mins, 0)::INT
    FROM route_points rp
    ORDER BY point_num;
END;
$$ LANGUAGE plpgsql;
```

## 12.8 ุชุญุฏูุซ ุชุทุจูู ุงูููู - ุฎุฏูุฉ ุงูุชุชุจุน

```javascript
// ุฅุนุฏุงุฏุงุช ุฎุฏูุฉ ุงูุชุชุจุน ูู ุชุทุจูู ุงูููู
const TrackingServiceConfig = {
    // ุงููุชุฑุฉ ุงูุฒูููุฉ ุจูู ุงูุชุญุฏูุซุงุช (ุจุงูุซูุงูู)
    normalInterval: 300,      // 5 ุฏูุงุฆู
    lowBatteryInterval: 900,  // 15 ุฏูููุฉ ุนูุฏ ุงูุฎูุงุถ ุงูุจุทุงุฑูุฉ
    lowBatteryThreshold: 20,  // ูุณุจุฉ ุงูุจุทุงุฑูุฉ ุงูููุฎูุถุฉ
    
    // ุณุงุนุงุช ุงูุนูู
    workStartTime: '08:00',
    workEndTime: '16:00',
    
    // ุฅุนุฏุงุฏุงุช ุงูุฏูุฉ
    desiredAccuracy: 'high',  // high, balanced, low
    
    // ุฑุณุงูุฉ ุงูุฅุดุนุงุฑ
    notificationTitle: 'ุชุชุจุน ุงููููุน ูุดุท',
    notificationBody: 'ูุชู ุชุชุจุน ูููุนู ูุฃุบุฑุงุถ ุงูุนูู ุฎูุงู ุณุงุนุงุช ุงูุฏูุงู',
    
    // API Endpoint
    apiEndpoint: '/api/v1/tracking/location'
};

// ูููู ุงูุจูุงูุงุช ุงููุฑุณูุฉ
const LocationPayload = {
    employee_id: 'UUID',
    latitude: 15.3694,
    longitude: 44.1910,
    accuracy: 10.5,
    speed: 25.0,
    heading: 180,
    source: 'gps',
    device_id: 'device-uuid',
    battery_level: 85,
    status: 'available',  // available, on_task, on_break, traveling
    task_id: 'UUID or null',
    recorded_at: '2024-12-16T10:30:00Z'
};
```

## 12.9 APIs ุชุชุจุน ุงููุฑู ุงูููุฏุงููุฉ

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| POST | `/api/v1/tracking/location` | ุงุณุชูุจุงู ุจูุงูุงุช ุงููููุน |
| GET | `/api/v1/tracking/live` | ุงูููุงูุน ุงูุญูุฉ ูููุฑู |
| GET | `/api/v1/tracking/employee/:id` | ูููุน ููุธู ูุญุฏุฏ |
| GET | `/api/v1/tracking/route/:id/:date` | ูุณุงุฑ ููุธู ูููู ูุญุฏุฏ |
| GET | `/api/v1/tracking/nearest` | ุฃูุฑุจ ููู ููููุน |
| PUT | `/api/v1/tracking/status` | ุชุญุฏูุซ ุญุงูุฉ ุงูููุธู |
| GET | `/api/v1/tracking/settings` | ุฅุนุฏุงุฏุงุช ุงูุชุชุจุน |
| PUT | `/api/v1/tracking/settings` | ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุชุชุจุน |


---

# 17. ุดุงุดุฉ ุงุณุชุจุฏุงู ุงูููููุงุช ูู ุชุทุจูู ุงูููู (Scan In/Out)

## 17.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุชูููู ุงูููู ูู ุชุณุฌูู ุงุณุชุจุฏุงู ุงูููููุงุช ูู ุงูููุฏุงู ุนุจุฑ ูุณุญ ุงูุจุงุฑููุฏ ูููููู ุงููุฏูู ูุงูุฌุฏูุฏ.

## 17.2 ุณูุฑ ุนูู ุงุณุชุจุฏุงู ุงููููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ฑ ุชุทุจูู ุงูููู - ุงุณุชุจุฏุงู ูููู                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฃูุฑ ุงูุนูู: WO-2024-1234                                                   โ
โ  ุงููููุฉ: ุชุบููุฑ ููุชุฑ ุงูุฒูุช ูููููุฏ G1                                        โ
โ  ุงูุฃุตู: ูููุฏ ูุงุชุฑุจููุฑ C15 (G1)                                             โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ุงูุฎุทูุฉ 1: ูุณุญ ุงููููู ุงููุฏูู (Scan Out)              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                                                                       โ โ
โ  โ                        โโโโโโโโโโโโโโโโโโโ                           โ โ
โ  โ                        โ   ๐ท            โ                           โ โ
โ  โ                        โ   ุงููุงููุฑุง     โ                           โ โ
โ  โ                        โ   ูุดุทุฉ         โ                           โ โ
โ  โ                        โโโโโโโโโโโโโโโโโโโ                           โ โ
โ  โ                                                                       โ โ
โ  โ           ูุฌูู ุงููุงููุฑุง ูุญู ุจุงุฑููุฏ ุงููููู ุงููุฏูู                      โ โ
โ  โ                                                                       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  ุฃู ุฃุฏุฎู ุงูุฑูู ุงูุชุณูุณูู ูุฏููุงู:                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ FO-2024-001234                                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [ุงูุชุงูู โก๏ธ]                                                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ฑ ุชุทุจูู ุงูููู - ุงุณุชุจุฏุงู ูููู                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ุงูุฎุทูุฉ 2: ูุณุญ ุงููููู ุงูุฌุฏูุฏ (Scan In)               โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โ ุงููููู ุงููุฏูู: FO-2024-001234                                          โ
โ     ุงูุนูุฑ: 248 ุณุงุนุฉ | 62 ููู                                               โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                                                                       โ โ
โ  โ                        โโโโโโโโโโโโโโโโโโโ                           โ โ
โ  โ                        โ   ๐ท            โ                           โ โ
โ  โ                        โ   ุงููุงููุฑุง     โ                           โ โ
โ  โ                        โ   ูุดุทุฉ         โ                           โ โ
โ  โ                        โโโโโโโโโโโโโโโโโโโ                           โ โ
โ  โ                                                                       โ โ
โ  โ           ูุฌูู ุงููุงููุฑุง ูุญู ุจุงุฑููุฏ ุงููููู ุงูุฌุฏูุฏ                      โ โ
โ  โ                                                                       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  ุฃู ุฃุฏุฎู ุงูุฑูู ุงูุชุณูุณูู ูุฏููุงู:                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ FO-2024-005678                                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [โฌ๏ธ ุฑุฌูุน]                                              [ุงูุชุงูู โก๏ธ]        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ฑ ุชุทุจูู ุงูููู - ุงุณุชุจุฏุงู ูููู                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         ุงูุฎุทูุฉ 3: ุชุฃููุฏ ุงูุงุณุชุจุฏุงู                           โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ๐ ุงููููุน: ููุชุฑ ุงูุฒูุช                                                โ โ
โ  โ ๐ญ ุงูุฃุตู: ูููุฏ G1                                                    โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โ
โ  โ                                                                       โ โ
โ  โ โ ุงููููู ุงููุฏูู (Scan Out):                                         โ โ
โ  โ    ุงูุฑูู ุงูุชุณูุณูู: FO-2024-001234                                    โ โ
โ  โ    ุงูููุน: ููุชุฑ ุฒูุช CAT-1R-0739                                       โ โ
โ  โ    ุงูุนูุฑ ุงูุชุดุบููู: 248 ุณุงุนุฉ                                          โ โ
โ  โ    ุงูุนูุฑ ุงูุฒููู: 62 ููู                                              โ โ
โ  โ                                                                       โ โ
โ  โ โ ุงููููู ุงูุฌุฏูุฏ (Scan In):                                          โ โ
โ  โ    ุงูุฑูู ุงูุชุณูุณูู: FO-2024-005678                                    โ โ
โ  โ    ุงูููุน: ููุชุฑ ุฒูุช CAT-1R-0739                                       โ โ
โ  โ    ูู ุงููุฎุฒูู: ุนูุฏุฉ ุงูููู                                            โ โ
โ  โ                                                                       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค โ
โ  โ ๐ ูุฑุงุกุฉ ุณุงุนุงุช ุงูุชุดุบูู ุงูุญุงููุฉ:                                      โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ โ
โ  โ โ 2450                                                           โ   โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ โ
โ  โ                                                                       โ โ
โ  โ ๐ ุณุจุจ ุงูุงุณุชุจุฏุงู:                                                    โ โ
โ  โ โ ุงุณุชุจุฏุงู ุฏูุฑู (ุตูุงูุฉ ููุงุฆูุฉ)                                        โ โ
โ  โ โ ูุดู/ุนุทู                                                            โ โ
โ  โ โ ุชุฑููุฉ                                                              โ โ
โ  โ                                                                       โ โ
โ  โ ๐ ูุตู ุงูุนุทู (ุฅู ูุฌุฏ):                                               โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ โ
โ  โ โ ุชุณุฑุจ ุฒูุช ูู ุงูููุชุฑ                                             โ   โ โ
โ  โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ  [โฌ๏ธ ุฑุฌูุน]                                        [โ ุชุฃููุฏ ุงูุงุณุชุจุฏุงู]     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ฑ ุชุทุจูู ุงูููู - ุงุณุชุจุฏุงู ูููู                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                              โ ุชู ุงูุงุณุชุจุฏุงู ุจูุฌุงุญ!                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                                                                       โ โ
โ  โ                           โ                                         โ โ
โ  โ                                                                       โ โ
โ  โ                    ุชู ุชุณุฌูู ุงูุงุณุชุจุฏุงู ุจูุฌุงุญ                          โ โ
โ  โ                                                                       โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ โ
โ  โ                                                                       โ โ
โ  โ  ๐ ููุฎุต ุงูุนูุฑ ุงูุชุดุบููู ูููููู ุงููุฏูู:                               โ โ
โ  โ                                                                       โ โ
โ  โ     โฑ๏ธ ุณุงุนุงุช ุงูุชุดุบูู: 248 ุณุงุนุฉ                                       โ โ
โ  โ     ๐ ุงูุฃูุงู: 62 ููู                                                โ โ
โ  โ     ๐ ููุงุฑูุฉ ุจุงููุชูุณุท: 99% (ุทุจูุนู)                                  โ โ
โ  โ                                                                       โ โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ โ
โ  โ                                                                       โ โ
โ  โ  โ๏ธ ุชูุจูู: ุชู ุชุณุฌูู ูุฐุง ูู "ูุดู ูุจูุฑ" ูุฃู ุงูุนูุฑ ุฃูู ูู 50%          โ โ
โ  โ     ูู ุงููุชููุน. ุณูุชู ูุฑุงุฌุนุชู ูู ูุจู ูุฑูู ุงูููุซูููุฉ.                  โ โ
โ  โ                                                                       โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                             โ
โ                              [๐ ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ]                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 17.3 ุฌุฏูู ุทูุจุงุช ุงุณุชุจุฏุงู ุงูููููุงุช (component_replacement_requests)

```sql
CREATE TABLE component_replacement_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ุฃูุฑ ุงูุนูู
    work_order_id UUID REFERENCES work_orders(id),
    
    -- ุงูุฃุตู ูุงููููุน
    asset_id UUID NOT NULL REFERENCES assets(id),
    slot_id UUID NOT NULL REFERENCES component_slots(id),
    
    -- ุงููููู ุงููุฏูู
    old_serial_number VARCHAR(100) NOT NULL,
    old_component_id UUID REFERENCES installed_components(id),
    
    -- ุงููููู ุงูุฌุฏูุฏ
    new_serial_number VARCHAR(100) NOT NULL,
    new_item_id UUID REFERENCES inventory_items(id),
    
    -- ูุฑุงุกุฉ ุงูุนุฏุงุฏ
    meter_reading DECIMAL(12, 2),
    
    -- ุณุจุจ ุงูุงุณุชุจุฏุงู
    replacement_reason ENUM('scheduled', 'failure', 'upgrade') NOT NULL,
    failure_description TEXT,
    
    -- ุงูููู
    technician_id UUID NOT NULL REFERENCES employees(id),
    
    -- ุงูุญุงูุฉ
    status ENUM('pending', 'completed', 'failed') DEFAULT 'pending',
    
    -- ุงูุชูููุช
    requested_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP,
    
    -- ุงููุชุงุฆุฌ
    operating_hours_recorded DECIMAL(12, 2),
    calendar_days_recorded INT,
    is_anomaly BOOLEAN DEFAULT false,
    anomaly_type VARCHAR(50),
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_replacement_wo ON component_replacement_requests(work_order_id);
CREATE INDEX idx_replacement_asset ON component_replacement_requests(asset_id);
CREATE INDEX idx_replacement_tech ON component_replacement_requests(technician_id);
```

## 17.4 APIs ุงุณุชุจุฏุงู ุงูููููุงุช ูู ุชุทุจูู ุงูููู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/mobile/assets/:id/slots` | ููุงูุน ุงูููููุงุช ููุฃุตู |
| GET | `/api/v1/mobile/slots/:id/current` | ุงููููู ุงููุฑูุจ ุญุงููุงู |
| POST | `/api/v1/mobile/components/scan-out` | ูุณุญ ุงููููู ุงููุฏูู |
| POST | `/api/v1/mobile/components/scan-in` | ูุณุญ ุงููููู ุงูุฌุฏูุฏ |
| POST | `/api/v1/mobile/components/replace` | ุชุฃููุฏ ุงูุงุณุชุจุฏุงู |
| GET | `/api/v1/mobile/technician/inventory` | ุนูุฏุฉ ุงูููู ูู ุงูููููุงุช |


---

# 18. ุชุชุจุน ุชูุงููู ุฃูุฑ ุงูุนูู (Work Order Costing)

## 18.1 ูุธุฑุฉ ุนุงูุฉ

> **ุงูุบุฑุถ:** ุชุฌููุน ูู ุงูุชูุงููู ุงููุชุนููุฉ ุจุนูููุฉ ุตูุงูุฉ ุฃู ุฅุตูุงุญ ูู ุฃูุฑ ุงูุนูู ูุญุณุงุจ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ.

## 18.2 ุฌุฏูู ุชูุงููู ุฃูุฑ ุงูุนูู (work_order_costs)

```sql
CREATE TABLE work_order_costs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ุฃูุฑ ุงูุนูู
    work_order_id UUID NOT NULL REFERENCES work_orders(id) ON DELETE CASCADE,
    
    -- ููุน ุงูุชูููุฉ
    cost_type ENUM(
        'labor',              -- ุชูููุฉ ุงูุนูุงูุฉ
        'material',           -- ุชูููุฉ ุงูููุงุฏ
        'component',          -- ุชูููุฉ ุงูููููุงุช
        'external_service',   -- ุฎุฏูุงุช ุฎุงุฑุฌูุฉ
        'transport',          -- ุชูููุฉ ุงูููู
        'other'               -- ุฃุฎุฑู
    ) NOT NULL,
    
    -- ุงูุชูุงุตูู
    description TEXT NOT NULL,
    
    -- ุงููููุฉ ูุงูุณุนุฑ
    quantity DECIMAL(10, 2) DEFAULT 1,
    unit_cost DECIMAL(12, 2) NOT NULL,
    total_cost DECIMAL(12, 2) GENERATED ALWAYS AS (quantity * unit_cost) STORED,
    
    -- ุงููุฑุฌุน
    reference_type VARCHAR(50),
    reference_id UUID,
    
    -- ุงููุงุชูุฑุฉ ุงูุฎุงุฑุฌูุฉ (ุฅู ูุฌุฏุช)
    external_invoice_number VARCHAR(100),
    external_vendor VARCHAR(200),
    
    -- ูู ุฃุถุงู ุงูุชูููุฉ
    added_by UUID REFERENCES employees(id),
    added_at TIMESTAMP DEFAULT NOW(),
    
    -- ุงูููุงููุฉ
    approved_by UUID REFERENCES employees(id),
    approved_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_wo_costs_wo ON work_order_costs(work_order_id);
CREATE INDEX idx_wo_costs_type ON work_order_costs(cost_type);
```

## 18.3 ุญุณุงุจ ุชูููุฉ ุงูุนูุงูุฉ ุงูุชููุงุฆู

```sql
-- Function ูุญุณุงุจ ุชูููุฉ ุงูุนูุงูุฉ ูู ุณุฌู ุงูุฏูุงู
CREATE OR REPLACE FUNCTION calculate_labor_cost(p_work_order_id UUID)
RETURNS DECIMAL AS $$
DECLARE
    v_total_cost DECIMAL := 0;
    v_record RECORD;
BEGIN
    -- ุญุณุงุจ ุณุงุนุงุช ุงูุนูู ููู ููู
    FOR v_record IN (
        SELECT 
            woa.technician_id,
            e.hourly_rate,
            EXTRACT(EPOCH FROM (woa.ended_at - woa.started_at)) / 3600 AS hours_worked
        FROM work_order_assignments woa
        JOIN employees e ON e.id = woa.technician_id
        WHERE woa.work_order_id = p_work_order_id
        AND woa.ended_at IS NOT NULL
    ) LOOP
        v_total_cost := v_total_cost + (v_record.hours_worked * v_record.hourly_rate);
    END LOOP;
    
    RETURN v_total_cost;
END;
$$ LANGUAGE plpgsql;
```

## 18.4 ุญุณุงุจ ุชูููุฉ ุงูููุงุฏ ุงูุชููุงุฆู

```sql
-- Function ูุญุณุงุจ ุชูููุฉ ุงูููุงุฏ ุงููุณุชุฎุฏูุฉ
CREATE OR REPLACE FUNCTION calculate_material_cost(p_work_order_id UUID)
RETURNS DECIMAL AS $$
DECLARE
    v_total_cost DECIMAL := 0;
BEGIN
    SELECT COALESCE(SUM(wom.quantity * ii.unit_cost), 0)
    INTO v_total_cost
    FROM work_order_materials wom
    JOIN inventory_items ii ON ii.id = wom.item_id
    WHERE wom.work_order_id = p_work_order_id;
    
    RETURN v_total_cost;
END;
$$ LANGUAGE plpgsql;
```

## 18.5 View ููุฎุต ุชูุงููู ุฃูุฑ ุงูุนูู

```sql
CREATE VIEW v_work_order_cost_summary AS
SELECT 
    wo.id AS work_order_id,
    wo.wo_number,
    wo.asset_id,
    a.asset_name,
    
    -- ุชูููุฉ ุงูุนูุงูุฉ
    calculate_labor_cost(wo.id) AS labor_cost,
    
    -- ุชูููุฉ ุงูููุงุฏ
    calculate_material_cost(wo.id) AS material_cost,
    
    -- ุชูููุฉ ุงูููููุงุช
    COALESCE((
        SELECT SUM(total_cost) FROM work_order_costs 
        WHERE work_order_id = wo.id AND cost_type = 'component'
    ), 0) AS component_cost,
    
    -- ุงูุฎุฏูุงุช ุงูุฎุงุฑุฌูุฉ
    COALESCE((
        SELECT SUM(total_cost) FROM work_order_costs 
        WHERE work_order_id = wo.id AND cost_type = 'external_service'
    ), 0) AS external_service_cost,
    
    -- ุชูุงููู ุฃุฎุฑู
    COALESCE((
        SELECT SUM(total_cost) FROM work_order_costs 
        WHERE work_order_id = wo.id AND cost_type IN ('transport', 'other')
    ), 0) AS other_costs,
    
    -- ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ
    (
        calculate_labor_cost(wo.id) +
        calculate_material_cost(wo.id) +
        COALESCE((SELECT SUM(total_cost) FROM work_order_costs WHERE work_order_id = wo.id), 0)
    ) AS total_cost
    
FROM work_orders wo
LEFT JOIN assets a ON a.id = wo.asset_id;
```

## 18.6 ุดุงุดุฉ ุชูุงููู ุฃูุฑ ุงูุนูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         ๐ฐ ุชูุงููู ุฃูุฑ ุงูุนูู                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                             โ
โ  ุฃูุฑ ุงูุนูู: WO-2024-1234                                                   โ
โ  ุงูุฃุตู: ูููุฏ ูุงุชุฑุจููุฑ C15 (G1)                                             โ
โ  ุงููููุฉ: ุตูุงูุฉ ุฏูุฑูุฉ ุดุงููุฉ                                                 โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                              ููุฎุต ุงูุชูุงููู                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ๐ท ุชูููุฉ ุงูุนูุงูุฉ (ุชููุงุฆู)                                          โ   โ
โ  โ    ุฃุญูุฏ ูุญูุฏ - 4.5 ุณุงุนุฉ ร 50 ุฑ.ุณ = 225 ุฑ.ุณ                        โ   โ
โ  โ    ุฎุงูุฏ ุนูู - 3.0 ุณุงุนุฉ ร 45 ุฑ.ุณ = 135 ุฑ.ุณ                         โ   โ
โ  โ                                        โโโโโโโโโโโโโ                โ   โ
โ  โ                                        ุงููุฌููุน: 360 ุฑ.ุณ            โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ๐ฆ ุชูููุฉ ุงูููุงุฏ (ุชููุงุฆู)                                           โ   โ
โ  โ    ููุชุฑ ุฒูุช CAT-1R-0739 ร 1 = 150 ุฑ.ุณ                              โ   โ
โ  โ    ููุชุฑ ููุงุก ร 1 = 200 ุฑ.ุณ                                         โ   โ
โ  โ    ุฒูุช ูุญุฑู 15W-40 ร 20 ูุชุฑ = 400 ุฑ.ุณ                              โ   โ
โ  โ                                        โโโโโโโโโโโโโ                โ   โ
โ  โ                                        ุงููุฌููุน: 750 ุฑ.ุณ            โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ ๐ง ุฎุฏูุงุช ุฎุงุฑุฌูุฉ (ูุฏูู)                                             โ   โ
โ  โ    ุฅุตูุงุญ ูุถุฎุฉ ูููุฏ - ูุฑุดุฉ ุงูุฃูู = 500 ุฑ.ุณ                          โ   โ
โ  โ    ูุงุชูุฑุฉ ุฑูู: INV-2024-789                                        โ   โ
โ  โ                                        โโโโโโโโโโโโโ                โ   โ
โ  โ                                        ุงููุฌููุน: 500 ุฑ.ุณ            โ   โ
โ  โ                                                                     โ   โ
โ  โ    [โ ุฅุถุงูุฉ ุชูููุฉ ุฎุฏูุฉ ุฎุงุฑุฌูุฉ]                                     โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ                    ๐ฐ ุงูุชูููุฉ ุงูุฅุฌูุงููุฉ: 1,610 ุฑ.ุณ                         โ
โ                                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                                                                             โ
โ  [๐จ๏ธ ุทุจุงุนุฉ]                                              [โ ุงุนุชูุงุฏ]      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## 18.7 ุชุญุฏูุซ ุฎูุงุฑ ุญุงูุฉ ุงููุทุนุฉ ุนูุฏ Scan Out

```sql
-- ุชุญุฏูุซ ุฌุฏูู component_replacement_requests
ALTER TABLE component_replacement_requests 
ADD COLUMN IF NOT EXISTS removed_part_condition ENUM(
    'scrap',           -- ุชุงูู ููุงุฆูุงู
    'repairable',      -- ูุงุจู ููุฅุตูุงุญ
    'good_used'        -- ูุณุชุนูู ุตุงูุญ
);

ALTER TABLE component_replacement_requests 
ADD COLUMN IF NOT EXISTS removed_part_destination VARCHAR(50);
```

## 18.8 APIs ุชูุงููู ุฃูุฑ ุงูุนูู

| Method | Endpoint | ุงููุตู |
|--------|----------|-------|
| GET | `/api/v1/work-orders/:id/costs` | ููุฎุต ุชูุงููู ุฃูุฑ ุงูุนูู |
| POST | `/api/v1/work-orders/:id/costs` | ุฅุถุงูุฉ ุชูููุฉ ูุฏููุฉ |
| PUT | `/api/v1/work-orders/:id/costs/:costId` | ุชุนุฏูู ุชูููุฉ |
| DELETE | `/api/v1/work-orders/:id/costs/:costId` | ุญุฐู ุชูููุฉ |
| POST | `/api/v1/work-orders/:id/costs/approve` | ุงุนุชูุงุฏ ุงูุชูุงููู |



---

## ๐จ๏ธ ุงููุธุงู ุงููุฑุนู: ููุตุฉ ุงูุชูุงุตู ุงูุฏุงุฎูู ูููุฑูู (Internal Team Chat)

### 31.1 ุงูุจููุฉ ุงูุฃุณุงุณูุฉ ูููุญุงุฏุซุงุช

#### 31.1.1 ุฌุฏูู ุงููููุงุช ูุงููุฌููุนุงุช

```sql
CREATE TABLE chat_channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ูุนูููุงุช ุงูููุงุฉ
    name VARCHAR(100) NOT NULL,
    description TEXT,
    avatar_url VARCHAR(500),
    
    -- ููุน ุงูููุงุฉ
    channel_type ENUM(
        'direct',          -- ูุญุงุฏุซุฉ ูุฑุฏูุฉ ุจูู ููุธููู
        'private_group',   -- ูุฌููุนุฉ ุฎุงุตุฉ
        'public_channel',  -- ููุงุฉ ุนุงูุฉ
        'entity_channel'   -- ููุงุฉ ูุฑุชุจุทุฉ ุจููุงู (ูุดุฑูุน/ุฃุตู/ุฃูุฑ ุนูู)
    ) NOT NULL,
    
    -- ุงูุฑุจุท ุจุงูููุงูุงุช (ูููููุงุช ุงููุฑุชุจุทุฉ)
    entity_type ENUM('project', 'work_order', 'asset', 'maintenance_plan') NULL,
    entity_id UUID NULL,
    
    -- ุงููุทุงู
    branch_id UUID REFERENCES branches(id),
    is_company_wide BOOLEAN DEFAULT FALSE,
    
    -- ุงูุฅุนุฏุงุฏุงุช
    is_archived BOOLEAN DEFAULT FALSE,
    auto_add_project_members BOOLEAN DEFAULT TRUE,
    
    -- ุงูููุดุฆ
    created_by UUID NOT NULL REFERENCES employees(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_chat_channels_type ON chat_channels(channel_type);
CREATE INDEX idx_chat_channels_entity ON chat_channels(entity_type, entity_id);
```

#### 31.1.2 ุฌุฏูู ุฃุนุถุงุก ุงูููุงุฉ

```sql
CREATE TABLE chat_channel_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID NOT NULL REFERENCES chat_channels(id) ON DELETE CASCADE,
    employee_id UUID NOT NULL REFERENCES employees(id),
    
    -- ุงูุฏูุฑ ูู ุงูููุงุฉ
    role ENUM('owner', 'admin', 'member') DEFAULT 'member',
    
    -- ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
    notification_setting ENUM('all', 'mentions_only', 'muted') DEFAULT 'all',
    
    -- ุณุงุนุงุช ุนุฏู ุงูุฅุฒุนุงุฌ
    dnd_enabled BOOLEAN DEFAULT FALSE,
    dnd_start_time TIME,
    dnd_end_time TIME,
    
    -- ุขุฎุฑ ูุฑุงุกุฉ
    last_read_at TIMESTAMP DEFAULT NOW(),
    last_read_message_id UUID,
    
    joined_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(channel_id, employee_id)
);
```

### 31.2 ุฌุฏูู ุงูุฑุณุงุฆู

```sql
CREATE TABLE chat_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID NOT NULL REFERENCES chat_channels(id) ON DELETE CASCADE,
    sender_id UUID NOT NULL REFERENCES employees(id),
    
    -- ููุน ุงูุฑุณุงูุฉ
    message_type ENUM(
        'text', 'image', 'video', 'file', 'voice', 'entity_share', 'system'
    ) NOT NULL DEFAULT 'text',
    
    -- ุงููุญุชูู
    content TEXT,
    formatted_content TEXT,
    
    -- ุงููุฑููุงุช
    attachments JSONB,
    
    -- ูุดุงุฑูุฉ ุงูููุงูุงุช
    shared_entity_type VARCHAR(50),
    shared_entity_id UUID,
    shared_entity_preview JSONB,
    
    -- ุงูุฑุฏ ูุงูุฎููุท
    reply_to_message_id UUID REFERENCES chat_messages(id),
    thread_root_id UUID REFERENCES chat_messages(id),
    
    -- ุงูุฅุดุงุฑุงุช
    mentions JSONB,
    mention_all BOOLEAN DEFAULT FALSE,
    
    -- ุงูุญุงูุฉ
    is_edited BOOLEAN DEFAULT FALSE,
    is_deleted BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_chat_messages_channel ON chat_messages(channel_id, created_at DESC);
CREATE INDEX idx_chat_messages_search ON chat_messages USING gin(to_tsvector('arabic', content));
```

### 31.3 ุฌุฏูู ุฑุฏูุฏ ุงููุนู (Reactions)

```sql
CREATE TABLE chat_message_reactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL REFERENCES chat_messages(id) ON DELETE CASCADE,
    employee_id UUID NOT NULL REFERENCES employees(id),
    emoji VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(message_id, employee_id, emoji)
);
```

### 31.4 ุงูุชูุงูู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู

#### 31.4.1 ุฅูุดุงุก ููุงุฉ ุชููุงุฆูุฉ ูููุดุงุฑูุน

```sql
CREATE OR REPLACE FUNCTION create_project_channel()
RETURNS TRIGGER AS $$
DECLARE
    new_channel_id UUID;
BEGIN
    INSERT INTO chat_channels (
        name, description, channel_type, entity_type, entity_id, 
        branch_id, created_by
    ) VALUES (
        'ูุดุฑูุน: ' || NEW.name,
        'ููุงุฉ ููุงุด ูุดุฑูุน ' || NEW.name,
        'entity_channel', 'project', NEW.id, NEW.branch_id, NEW.created_by
    ) RETURNING id INTO new_channel_id;
    
    INSERT INTO chat_channel_members (channel_id, employee_id, role)
    VALUES (new_channel_id, NEW.project_manager_id, 'owner');
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_project_channel
    AFTER INSERT ON projects
    FOR EACH ROW EXECUTE FUNCTION create_project_channel();
```

#### 31.4.2 ุชุญููู ุงูุฑุณุงูุฉ ุฅูู ูููุฉ

```sql
CREATE TABLE chat_quick_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    source_message_id UUID NOT NULL REFERENCES chat_messages(id),
    source_channel_id UUID NOT NULL REFERENCES chat_channels(id),
    
    title VARCHAR(200) NOT NULL,
    description TEXT,
    
    assigned_to UUID REFERENCES employees(id),
    assigned_by UUID NOT NULL REFERENCES employees(id),
    
    priority ENUM('low', 'medium', 'high', 'urgent') DEFAULT 'medium',
    due_date DATE,
    
    status ENUM('pending', 'in_progress', 'completed', 'cancelled') DEFAULT 'pending',
    completed_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 31.5 ูุธุงู ุงูุฅุดุนุงุฑุงุช

```sql
CREATE TABLE chat_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    
    channel_id UUID REFERENCES chat_channels(id),
    message_id UUID REFERENCES chat_messages(id),
    
    notification_type ENUM(
        'new_message', 'mention', 'reply', 'reaction', 'channel_invite', 'task_assigned'
    ) NOT NULL,
    
    title VARCHAR(200) NOT NULL,
    body TEXT,
    
    is_read BOOLEAN DEFAULT FALSE,
    push_sent BOOLEAN DEFAULT FALSE,
    
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_chat_notifications_employee ON chat_notifications(employee_id, is_read);
```

### 31.6 ูุงุฌูุงุช ุงููุณุชุฎุฏู

#### ุดุงุดุฉ ูุงุฆูุฉ ุงููุญุงุฏุซุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐จ๏ธ ุงููุญุงุฏุซุงุช                              [๐] [โ ุฌุฏูุฏ]   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ ๐ ุงููุซุจุชุฉ                                                  โ
โ โ ๐ข #ุฅุนูุงูุงุช_ุงูุดุฑูุฉ                           ููุฐ 2ุณ    โ โ
โ                                                             โ
โ ๐ฌ ุงููุญุงุฏุซุงุช ุงููุจุงุดุฑุฉ                                       โ
โ โ ๐ค ุฃุญูุฏ ูุญูุฏ                              ๐ข ูุชุตู       โ โ
โ โ ๐ค ุณุงุฑุฉ ุฃุญูุฏ                              โช ุบูุฑ ูุชุตู   โ โ
โ                                                             โ
โ ๐ฅ ุงููุฌููุนุงุช                                                โ
โ โ ๐ง ูุฑูู ุตูุงูุฉ ูุญุทุฉ G1                      (5 ุฃุนุถุงุก)   โ โ
โ โ ๐ ูุดุฑูุน: ุชูุณุนุฉ ุงูุดุจูุฉ ุงูุดุฑููุฉ             (12 ุนุถู)    โ โ
โ                                                             โ
โ ๐ข ุงููููุงุช ุงูุนุงูุฉ                                           โ
โ โ #ููุงุดุงุช_ุชูููุฉ                              (45 ุนุถู)    โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุดุงุดุฉ ุงููุญุงุฏุซุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ง ูุฑูู ุตูุงูุฉ ูุญุทุฉ G1                    [๐] [๐น] [โ๏ธ]   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ โ ๐ค ุฃุญูุฏ: ุงููููุฏ G1-001 ูุตุฏุฑ ุตูุช ุบุฑูุจ      10:30 ุต    โ โ
โ โ ๐ท [ุตูุฑุฉ ูุฑููุฉ]                                        โ โ
โ โ                                                         โ โ
โ โ ๐ค ุงููููุฏุณ ุฎุงูุฏ: โฉ๏ธ ูุจุฏู ุฃู ุงููุดููุฉ ูู ุงููุถุฎุฉ         โ โ
โ โ    @ุณุงุฑุฉ ูู ููููู ูุญุต ูุณุชูู ุงูุฒูุชุ        10:35 ุต    โ โ
โ โ                                                         โ โ
โ โ ๐ [ููุงู ูุดุงุฑู: ุฃูุฑ ุนูู WO-2024-001234]               โ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [๐] [๐ค] [๐]  ุงูุชุจ ุฑุณุงูุฉ...                    [ุฅุฑุณุงู]  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 31.7 APIs ููุตุฉ ุงูุชูุงุตู

```yaml
# ุงููููุงุช ูุงููุฌููุนุงุช
GET    /api/v1/chat/channels                    - ูุงุฆูุฉ ุงููููุงุช
POST   /api/v1/chat/channels                    - ุฅูุดุงุก ููุงุฉ/ูุฌููุนุฉ
GET    /api/v1/chat/channels/{id}               - ุชูุงุตูู ุงูููุงุฉ
PUT    /api/v1/chat/channels/{id}               - ุชุนุฏูู ุงูููุงุฉ

# ุงูุฃุนุถุงุก
GET    /api/v1/chat/channels/{id}/members       - ุฃุนุถุงุก ุงูููุงุฉ
POST   /api/v1/chat/channels/{id}/members       - ุฅุถุงูุฉ ุนุถู
DELETE /api/v1/chat/channels/{id}/members/{uid} - ุฅุฒุงูุฉ ุนุถู

# ุงูุฑุณุงุฆู
GET    /api/v1/chat/channels/{id}/messages      - ุฑุณุงุฆู ุงูููุงุฉ
POST   /api/v1/chat/channels/{id}/messages      - ุฅุฑุณุงู ุฑุณุงูุฉ
PUT    /api/v1/chat/messages/{id}               - ุชุนุฏูู ุฑุณุงูุฉ
DELETE /api/v1/chat/messages/{id}               - ุญุฐู ุฑุณุงูุฉ

# ุฑุฏูุฏ ุงููุนู
POST   /api/v1/chat/messages/{id}/reactions     - ุฅุถุงูุฉ ุฑุฏ ูุนู

# ุงูููุงู
POST   /api/v1/chat/messages/{id}/convert-to-task - ุชุญููู ููููุฉ

# WebSocket
WS     /api/v1/chat/ws                          - ุงุชุตุงู ูุจุงุดุฑ ููุฑุณุงุฆู ุงูููุฑูุฉ
```

### 31.8 ููุงุท ุงูุฃูู ุงููุนุงูุฌุฉ

| ููุทุฉ ุงูุฃูู | ุงููุดููุฉ | ุงูุญู |
|------------|---------|------|
| ููุถู ูุฌููุนุงุช ุงููุงุชุณุงุจ | ูุญุงุฏุซุงุช ุบูุฑ ููุธูุฉ | ููุตุฉ ูุฑูุฒูุฉ ุขููุฉ |
| ูุญุงุฏุซุงุช ุบูุฑ ูุฑุชุจุทุฉ ุจุงูุนูู | ุถูุงุน ุงูุณูุงู | ุฑุจุท ุจุงููุดุงุฑูุน ูุงูููุงู |
| ุถูุงุน ุงูุทูุจุงุช ูู ุงููุญุงุฏุซุงุช | ูุง ูุชุงุจุนุฉ | ุชุญููู ุงูุฑุณุงูุฉ ููููุฉ |
| ูุฎุงูู ุงูุฃูุงู ูุงูุฎุตูุตูุฉ | ุจูุงูุงุช ุนูู ุฎูุงุฏู ุฎุงุฑุฌูุฉ | ุจูุงูุงุช ุนูู ุฎูุงุฏู ุงูุดุฑูุฉ |
| ุตุนูุจุฉ ุงูุจุญุซ | ูุง ุฃุฑุดูู | ุจุญุซ ูุงูู ูู ุงูุฑุณุงุฆู |



### 31.9 ุงูููุฒุงุช ุงููุชูุฏูุฉ (ุงููุฌูุงุช ุงูููุชููุฉ)

#### 31.9.1 ุชุซุจูุช ุงูุฑุณุงุฆู ูุงููุญุงุฏุซุงุช

```sql
-- ุฅุถุงูุฉ ุญูู ุงูุชุซุจูุช ููุฑุณุงุฆู
ALTER TABLE chat_messages ADD COLUMN is_pinned BOOLEAN DEFAULT FALSE;
ALTER TABLE chat_messages ADD COLUMN pinned_at TIMESTAMP;
ALTER TABLE chat_messages ADD COLUMN pinned_by UUID REFERENCES employees(id);

-- ุฌุฏูู ุงููุญุงุฏุซุงุช ุงููุซุจุชุฉ ูููุณุชุฎุฏู
CREATE TABLE chat_pinned_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    channel_id UUID NOT NULL REFERENCES chat_channels(id),
    pinned_at TIMESTAMP DEFAULT NOW(),
    pin_order INT DEFAULT 0,
    UNIQUE(employee_id, channel_id)
);

-- ุฌุฏูู ุงููุญุงุฏุซุงุช ุงูููุถูุฉ
CREATE TABLE chat_favorite_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id),
    channel_id UUID NOT NULL REFERENCES chat_channels(id),
    added_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(employee_id, channel_id)
);
```

#### 31.9.2 ุญุงูุฉ ุงูุงุชุตุงู (Online Status)

```sql
CREATE TABLE chat_user_presence (
    employee_id UUID PRIMARY KEY REFERENCES employees(id),
    
    -- ุญุงูุฉ ุงูุงุชุตุงู
    status ENUM('online', 'away', 'busy', 'offline') DEFAULT 'offline',
    custom_status VARCHAR(100),  -- "ูู ุงุฌุชูุงุน"ุ "ุฃุนูู ูู ุงูููุฒู"
    
    -- ุขุฎุฑ ูุดุงุท
    last_seen_at TIMESTAMP DEFAULT NOW(),
    last_activity_at TIMESTAMP DEFAULT NOW(),
    
    -- ุงูุฌูุงุฒ
    device_type VARCHAR(50),  -- mobile, desktop, web
    
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Trigger: ุชุญุฏูุซ ุญุงูุฉ ุงูุงุชุตุงู ุชููุงุฆูุงู
CREATE OR REPLACE FUNCTION update_user_presence()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE chat_user_presence 
    SET last_activity_at = NOW(),
        status = 'online',
        updated_at = NOW()
    WHERE employee_id = NEW.sender_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_presence_on_message
    AFTER INSERT ON chat_messages
    FOR EACH ROW EXECUTE FUNCTION update_user_presence();
```

#### 31.9.3 ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช ุงูุชูุตูููุฉ

```sql
CREATE TABLE chat_notification_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id) UNIQUE,
    
    -- ุฅุนุฏุงุฏุงุช ุนุงูุฉ
    notifications_enabled BOOLEAN DEFAULT TRUE,
    sound_enabled BOOLEAN DEFAULT TRUE,
    vibration_enabled BOOLEAN DEFAULT TRUE,
    
    -- ุฅุดุนุงุฑุงุช ุงููุญุงุฏุซุงุช
    direct_messages BOOLEAN DEFAULT TRUE,
    private_groups BOOLEAN DEFAULT TRUE,
    public_channels BOOLEAN DEFAULT TRUE,
    mentions_only_channels BOOLEAN DEFAULT FALSE,
    
    -- ุฅุดุนุงุฑุงุช ุงูููุงูุงุช
    project_updates BOOLEAN DEFAULT TRUE,
    work_order_updates BOOLEAN DEFAULT TRUE,
    asset_updates BOOLEAN DEFAULT TRUE,
    
    -- ุณุงุนุงุช ุนุฏู ุงูุฅุฒุนุงุฌ
    dnd_enabled BOOLEAN DEFAULT FALSE,
    dnd_start_time TIME DEFAULT '22:00',
    dnd_end_time TIME DEFAULT '08:00',
    dnd_allow_urgent BOOLEAN DEFAULT TRUE,
    
    -- ุฃูุงู ุนุฏู ุงูุฅุฒุนุงุฌ
    dnd_weekends BOOLEAN DEFAULT FALSE,
    
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 31.9.4 ูููุงุช ุงูุฃุตูู ุงููููุฉ

```sql
-- Trigger: ุฅูุดุงุก ููุงุฉ ููุฃุตูู ุงููููุฉ (ุงููููุฏุงุช ูุงููุญููุงุช)
CREATE OR REPLACE FUNCTION create_critical_asset_channel()
RETURNS TRIGGER AS $$
DECLARE
    new_channel_id UUID;
BEGIN
    -- ููุท ููุฃุตูู ุงููููุฉ
    IF NEW.asset_type IN ('generator', 'transformer', 'substation') 
       AND NEW.criticality IN ('critical', 'high') THEN
        
        INSERT INTO chat_channels (
            name, description, channel_type, entity_type, entity_id, 
            branch_id, created_by, is_company_wide
        ) VALUES (
            'ุฃุตู: ' || NEW.name,
            'ููุงุฉ ููุงูุดุฉ ุงูุฃุฏุงุก ูุงูุตูุงูุฉ ููุฃุตู ' || NEW.asset_code,
            'entity_channel',
            'asset',
            NEW.id,
            NEW.branch_id,
            NEW.created_by,
            FALSE
        ) RETURNING id INTO new_channel_id;
        
        -- ุฅุถุงูุฉ ุงููุณุคูู ุนู ุงูุฃุตู
        IF NEW.responsible_employee_id IS NOT NULL THEN
            INSERT INTO chat_channel_members (channel_id, employee_id, role)
            VALUES (new_channel_id, NEW.responsible_employee_id, 'admin');
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_asset_channel
    AFTER INSERT ON assets
    FOR EACH ROW EXECUTE FUNCTION create_critical_asset_channel();
```

#### 31.9.5 ูููุงุช ุฃูุงูุฑ ุงูุนูู ุงููุนูุฏุฉ

```sql
-- Trigger: ุฅูุดุงุก ูุฌููุนุฉ ูุคูุชุฉ ูุฃูุงูุฑ ุงูุนูู ุงููุนูุฏุฉ
CREATE OR REPLACE FUNCTION create_complex_work_order_chat()
RETURNS TRIGGER AS $$
DECLARE
    new_channel_id UUID;
BEGIN
    -- ููุท ูุฃูุงูุฑ ุงูุนูู ุงููุนูุฏุฉ ุฃู ุงูุทุงุฑุฆุฉ
    IF NEW.complexity IN ('complex', 'critical') 
       OR NEW.priority = 'urgent' THEN
        
        INSERT INTO chat_channels (
            name, description, channel_type, entity_type, entity_id, 
            branch_id, created_by
        ) VALUES (
            'ุฃูุฑ ุนูู: ' || NEW.order_number,
            'ูุฌููุนุฉ ููุงุด ุฃูุฑ ุงูุนูู - ' || NEW.title,
            'entity_channel',
            'work_order',
            NEW.id,
            NEW.branch_id,
            NEW.created_by
        ) RETURNING id INTO new_channel_id;
        
        -- ุฅุถุงูุฉ ุงูููู ุงููุณูุฏ
        IF NEW.assigned_to IS NOT NULL THEN
            INSERT INTO chat_channel_members (channel_id, employee_id, role)
            VALUES (new_channel_id, NEW.assigned_to, 'member');
        END IF;
        
        -- ุฅุถุงูุฉ ุงููุดุฑู
        IF NEW.supervisor_id IS NOT NULL THEN
            INSERT INTO chat_channel_members (channel_id, employee_id, role)
            VALUES (new_channel_id, NEW.supervisor_id, 'admin');
        END IF;
        
        -- ุชุญุฏูุซ ุฃูุฑ ุงูุนูู ุจุฑุงุจุท ุงูููุงุฉ
        NEW.chat_channel_id := new_channel_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_work_order_chat
    BEFORE INSERT ON field_operations
    FOR EACH ROW EXECUTE FUNCTION create_complex_work_order_chat();

-- ุฅุถุงูุฉ ุญูู ุฑุงุจุท ุงูููุงุฉ ูุฃูุงูุฑ ุงูุนูู
ALTER TABLE field_operations ADD COLUMN chat_channel_id UUID REFERENCES chat_channels(id);
```

#### 31.9.6 ูุดุงุฑูุฉ ุงูููุงูุงุช ุงูููุณุนุฉ

```sql
-- View: ูุนุงููุฉ ุฌููุน ุงูููุงูุงุช ุงููุงุจูุฉ ูููุดุงุฑูุฉ
CREATE OR REPLACE VIEW chat_shareable_entities AS

-- ุฃูุงูุฑ ุงูุนูู
SELECT 
    'work_order' AS entity_type,
    fo.id AS entity_id,
    fo.order_number AS entity_code,
    fo.title AS entity_name,
    jsonb_build_object(
        'order_number', fo.order_number,
        'type', fo.operation_type,
        'status', fo.status,
        'priority', fo.priority,
        'customer_name', c.full_name,
        'assigned_to', e.full_name,
        'scheduled_date', fo.scheduled_date
    ) AS preview_data
FROM field_operations fo
LEFT JOIN customers c ON fo.customer_id = c.id
LEFT JOIN employees e ON fo.assigned_to = e.id

UNION ALL

-- ุงูุฃุตูู
SELECT 
    'asset' AS entity_type,
    a.id AS entity_id,
    a.asset_code AS entity_code,
    a.name AS entity_name,
    jsonb_build_object(
        'asset_code', a.asset_code,
        'name', a.name,
        'type', a.asset_type,
        'status', a.status,
        'location', a.location_name,
        'health_score', a.health_score
    ) AS preview_data
FROM assets a

UNION ALL

-- ุงููุดุงุฑูุน
SELECT 
    'project' AS entity_type,
    p.id AS entity_id,
    p.project_code AS entity_code,
    p.name AS entity_name,
    jsonb_build_object(
        'project_code', p.project_code,
        'name', p.name,
        'status', p.status,
        'progress', p.progress_percentage,
        'manager', e.full_name,
        'deadline', p.end_date
    ) AS preview_data
FROM projects p
LEFT JOIN employees e ON p.project_manager_id = e.id

UNION ALL

-- ุงูููุงุชูุฑ
SELECT 
    'invoice' AS entity_type,
    i.id AS entity_id,
    i.invoice_number AS entity_code,
    'ูุงุชูุฑุฉ ' || c.full_name AS entity_name,
    jsonb_build_object(
        'invoice_number', i.invoice_number,
        'customer_name', c.full_name,
        'amount', i.total_amount,
        'status', i.status,
        'due_date', i.due_date
    ) AS preview_data
FROM invoices i
LEFT JOIN customers c ON i.customer_id = c.id

UNION ALL

-- ุงูุชูุงุฑูุฑ
SELECT 
    'report' AS entity_type,
    r.id AS entity_id,
    r.report_code AS entity_code,
    r.title AS entity_name,
    jsonb_build_object(
        'report_code', r.report_code,
        'title', r.title,
        'type', r.report_type,
        'created_by', e.full_name,
        'created_at', r.created_at
    ) AS preview_data
FROM reports r
LEFT JOIN employees e ON r.created_by = e.id;
```

#### 31.9.7 ุงูุจุญุซ ุงููุชูุฏู

```sql
-- Function: ุจุญุซ ูุชูุฏู ูู ุงูุฑุณุงุฆู
CREATE OR REPLACE FUNCTION search_chat_messages(
    p_employee_id UUID,
    p_query TEXT DEFAULT NULL,
    p_channel_id UUID DEFAULT NULL,
    p_sender_id UUID DEFAULT NULL,
    p_message_type VARCHAR DEFAULT NULL,
    p_date_from DATE DEFAULT NULL,
    p_date_to DATE DEFAULT NULL,
    p_has_attachments BOOLEAN DEFAULT NULL,
    p_limit INT DEFAULT 50,
    p_offset INT DEFAULT 0
) RETURNS TABLE (
    message_id UUID,
    channel_id UUID,
    channel_name VARCHAR,
    sender_id UUID,
    sender_name VARCHAR,
    content TEXT,
    message_type VARCHAR,
    attachments JSONB,
    created_at TIMESTAMP,
    relevance_score FLOAT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        m.id AS message_id,
        m.channel_id,
        ch.name AS channel_name,
        m.sender_id,
        e.full_name AS sender_name,
        m.content,
        m.message_type::VARCHAR,
        m.attachments,
        m.created_at,
        CASE 
            WHEN p_query IS NOT NULL 
            THEN ts_rank(to_tsvector('arabic', m.content), plainto_tsquery('arabic', p_query))
            ELSE 1.0
        END AS relevance_score
    FROM chat_messages m
    JOIN chat_channels ch ON m.channel_id = ch.id
    JOIN chat_channel_members cm ON ch.id = cm.channel_id AND cm.employee_id = p_employee_id
    LEFT JOIN employees e ON m.sender_id = e.id
    WHERE m.is_deleted = FALSE
      AND (p_query IS NULL OR to_tsvector('arabic', m.content) @@ plainto_tsquery('arabic', p_query))
      AND (p_channel_id IS NULL OR m.channel_id = p_channel_id)
      AND (p_sender_id IS NULL OR m.sender_id = p_sender_id)
      AND (p_message_type IS NULL OR m.message_type::VARCHAR = p_message_type)
      AND (p_date_from IS NULL OR m.created_at::DATE >= p_date_from)
      AND (p_date_to IS NULL OR m.created_at::DATE <= p_date_to)
      AND (p_has_attachments IS NULL OR (p_has_attachments = TRUE AND m.attachments IS NOT NULL))
    ORDER BY 
        CASE WHEN p_query IS NOT NULL THEN relevance_score ELSE 0 END DESC,
        m.created_at DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;
```

#### 31.9.8 ุฅุดุนุงุฑุงุช ุงูููุงูุงุช ุงููุฑุชุจุทุฉ

```sql
-- Trigger: ุฅุดุนุงุฑ ุนูุฏ ุชุญุฏูุซ ูุดุฑูุน ูุชุงุจุน
CREATE OR REPLACE FUNCTION notify_project_followers()
RETURNS TRIGGER AS $$
BEGIN
    -- ุฅุฑุณุงู ุฅุดุนุงุฑ ูุฃุนุถุงุก ููุงุฉ ุงููุดุฑูุน
    INSERT INTO chat_notifications (
        employee_id, channel_id, notification_type, title, body
    )
    SELECT 
        cm.employee_id,
        ch.id,
        'new_message',
        'ุชุญุฏูุซ ูู ุงููุดุฑูุน: ' || NEW.name,
        'ุชู ุชุญุฏูุซ ุญุงูุฉ ุงููุดุฑูุน ุฅูู: ' || NEW.status
    FROM chat_channels ch
    JOIN chat_channel_members cm ON ch.id = cm.channel_id
    WHERE ch.entity_type = 'project' AND ch.entity_id = NEW.id
      AND cm.notification_setting != 'muted';
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_notify_project_update
    AFTER UPDATE OF status, progress_percentage ON projects
    FOR EACH ROW
    WHEN (OLD.status IS DISTINCT FROM NEW.status OR OLD.progress_percentage IS DISTINCT FROM NEW.progress_percentage)
    EXECUTE FUNCTION notify_project_followers();
```

### 31.10 APIs ุงูููุฒุงุช ุงููุชูุฏูุฉ

```yaml
# ุงูุชุซุจูุช ูุงูููุถูุฉ
POST   /api/v1/chat/messages/{id}/pin           - ุชุซุจูุช ุฑุณุงูุฉ
DELETE /api/v1/chat/messages/{id}/pin           - ุฅูุบุงุก ุชุซุจูุช
POST   /api/v1/chat/channels/{id}/pin           - ุชุซุจูุช ูุญุงุฏุซุฉ
POST   /api/v1/chat/channels/{id}/favorite      - ุฅุถุงูุฉ ููููุถูุฉ

# ุญุงูุฉ ุงูุงุชุตุงู
GET    /api/v1/chat/presence                    - ุญุงูุงุช ุงุชุตุงู ุงูุฒููุงุก
PUT    /api/v1/chat/presence                    - ุชุญุฏูุซ ุญุงูุชู
PUT    /api/v1/chat/presence/status             - ุชุญุฏูุซ ุงูุญุงูุฉ ุงููุฎุตุตุฉ

# ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
GET    /api/v1/chat/settings/notifications      - ุฌูุจ ุฅุนุฏุงุฏุงุช ุงูุฅุดุนุงุฑุงุช
PUT    /api/v1/chat/settings/notifications      - ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช

# ุงูุจุญุซ ุงููุชูุฏู
GET    /api/v1/chat/search                      - ุจุญุซ ูุชูุฏู
       ?q={query}
       &channel_id={id}
       &sender_id={id}
       &type={message_type}
       &from={date}
       &to={date}
       &has_attachments={bool}

# ูุดุงุฑูุฉ ุงูููุงูุงุช
GET    /api/v1/chat/entities/search             - ุจุญุซ ูู ุงูููุงูุงุช ูููุดุงุฑูุฉ
POST   /api/v1/chat/messages/share-entity       - ูุดุงุฑูุฉ ููุงู ูู ุงููุญุงุฏุซุฉ
```



### 31.11 ุงูุชุดููุฑ ูู ุทุฑู ุฅูู ุทุฑู (E2E Encryption)

> **ููุงุญุธุฉ:** ุงูุชุดููุฑ ูุชู ุนูู ูุณุชูู ุงูุชุทุจูู ูููุณ ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### 31.11.1 ุฌุฏูู ููุงุชูุญ ุงูุชุดููุฑ

```sql
-- ุฌุฏูู ุงูููุงุชูุญ ุงูุนุงูุฉ ูููุณุชุฎุฏููู
CREATE TABLE chat_user_encryption_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    employee_id UUID NOT NULL REFERENCES employees(id) UNIQUE,
    
    -- ุงูููุชุงุญ ุงูุนุงู (Public Key)
    public_key TEXT NOT NULL,
    key_algorithm VARCHAR(50) DEFAULT 'RSA-OAEP-256',
    
    -- ูุนูููุงุช ุงูููุชุงุญ
    key_fingerprint VARCHAR(64) NOT NULL,  -- SHA-256 hash
    key_version INT DEFAULT 1,
    
    -- ุงูุชูููุช
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    revoked_at TIMESTAMP,
    
    -- ุงูููุชุงุญ ุงูุณุงุจู (ููุชูุงูู)
    previous_key_id UUID REFERENCES chat_user_encryption_keys(id)
);

CREATE INDEX idx_encryption_keys_employee ON chat_user_encryption_keys(employee_id);
CREATE INDEX idx_encryption_keys_fingerprint ON chat_user_encryption_keys(key_fingerprint);

-- ุฌุฏูู ููุงุชูุญ ุงูุฌูุณุงุช ูููุญุงุฏุซุงุช ุงููุจุงุดุฑุฉ
CREATE TABLE chat_session_keys (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID NOT NULL REFERENCES chat_channels(id),
    
    -- ุงูููุชุงุญ ุงููุดูุฑ ููู ูุดุงุฑู
    participant_id UUID NOT NULL REFERENCES employees(id),
    encrypted_session_key TEXT NOT NULL,  -- ูุดูุฑ ุจุงูููุชุงุญ ุงูุนุงู ูููุดุงุฑู
    
    -- ูุนูููุงุช ุงูุฌูุณุฉ
    session_version INT DEFAULT 1,
    key_algorithm VARCHAR(50) DEFAULT 'AES-256-GCM',
    
    created_at TIMESTAMP DEFAULT NOW(),
    expires_at TIMESTAMP,
    
    UNIQUE(channel_id, participant_id, session_version)
);
```

#### 31.11.2 ุญููู ุงูุชุดููุฑ ูู ุงูุฑุณุงุฆู

```sql
-- ุฅุถุงูุฉ ุญููู ุงูุชุดููุฑ ูุฌุฏูู ุงูุฑุณุงุฆู
ALTER TABLE chat_messages ADD COLUMN is_encrypted BOOLEAN DEFAULT FALSE;
ALTER TABLE chat_messages ADD COLUMN encryption_version INT;
ALTER TABLE chat_messages ADD COLUMN encrypted_content TEXT;  -- ุงููุญุชูู ุงููุดูุฑ
ALTER TABLE chat_messages ADD COLUMN content_nonce VARCHAR(32);  -- Nonce ููุชุดููุฑ

-- ููุงุญุธุฉ: ุนูุฏ ุงูุชุดููุฑ:
-- 1. content ูุจูู NULL ุฃู ูุญุชูู ุนูู "[ุฑุณุงูุฉ ูุดูุฑุฉ]"
-- 2. encrypted_content ูุญุชูู ุนูู ุงููุญุชูู ุงููุดูุฑ
-- 3. ูู ุงูุชุดููุฑ ูุชู ุนูู ุฌูุงุฒ ุงููุณุชุฎุฏู ููุท
```

#### 31.11.3 ุณูุฑ ุนูู ุงูุชุดููุฑ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุณูุฑ ุนูู ุงูุชุดููุฑ ูู ุทุฑู ุฅูู ุทุฑู                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ 1. ุฅูุดุงุก ุงูููุงุชูุญ (ูุฑุฉ ูุงุญุฏุฉ):                              โ
โ    โโ ุงููุณุชุฎุฏู ููุดุฆ ุฒูุฌ ููุงุชูุญ (ุนุงู/ุฎุงุต)                   โ
โ    โโ ุงูููุชุงุญ ุงูุนุงู ููุฑูุน ููุฎุงุฏู                            โ
โ    โโ ุงูููุชุงุญ ุงูุฎุงุต ูุจูู ุนูู ุฌูุงุฒ ุงููุณุชุฎุฏู ููุท             โ
โ                                                             โ
โ 2. ุจุฏุก ูุญุงุฏุซุฉ ูุดูุฑุฉ:                                        โ
โ    โโ ุฅูุดุงุก ููุชุงุญ ุฌูุณุฉ ุนุดูุงุฆู (AES-256)                    โ
โ    โโ ุชุดููุฑ ููุชุงุญ ุงูุฌูุณุฉ ุจุงูููุชุงุญ ุงูุนุงู ููู ูุดุงุฑู          โ
โ    โโ ุญูุธ ุงูููุงุชูุญ ุงููุดูุฑุฉ ูู chat_session_keys            โ
โ                                                             โ
โ 3. ุฅุฑุณุงู ุฑุณุงูุฉ:                                             โ
โ    โโ ุชุดููุฑ ุงููุญุชูู ุจููุชุงุญ ุงูุฌูุณุฉ (AES-256-GCM)            โ
โ    โโ ุฅุฑุณุงู ุงููุญุชูู ุงููุดูุฑ ููุฎุงุฏู                          โ
โ    โโ ุงูุฎุงุฏู ูุง ูุณุชุทูุน ูุฑุงุกุฉ ุงููุญุชูู                       โ
โ                                                             โ
โ 4. ุงุณุชูุงู ุฑุณุงูุฉ:                                            โ
โ    โโ ุฌูุจ ููุชุงุญ ุงูุฌูุณุฉ ุงููุดูุฑ                              โ
โ    โโ ูู ุชุดููุฑ ููุชุงุญ ุงูุฌูุณุฉ ุจุงูููุชุงุญ ุงูุฎุงุต                 โ
โ    โโ ูู ุชุดููุฑ ุงูุฑุณุงูุฉ ุจููุชุงุญ ุงูุฌูุณุฉ                       โ
โ                                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 31.11.4 APIs ุงูุชุดููุฑ

```yaml
# ุฅุฏุงุฑุฉ ุงูููุงุชูุญ
POST   /api/v1/chat/encryption/keys              - ุฑูุน ุงูููุชุงุญ ุงูุนุงู
GET    /api/v1/chat/encryption/keys/{user_id}    - ุฌูุจ ุงูููุชุงุญ ุงูุนุงู ููุณุชุฎุฏู
PUT    /api/v1/chat/encryption/keys/rotate       - ุชุฏููุฑ ุงูููุงุชูุญ
DELETE /api/v1/chat/encryption/keys/revoke       - ุฅูุบุงุก ุงูููุชุงุญ

# ููุงุชูุญ ุงูุฌูุณุงุช
POST   /api/v1/chat/channels/{id}/session-key    - ุฅูุดุงุก/ุชุญุฏูุซ ููุชุงุญ ุฌูุณุฉ
GET    /api/v1/chat/channels/{id}/session-key    - ุฌูุจ ููุชุงุญ ุงูุฌูุณุฉ ุงููุดูุฑ
```

---

### 31.12 ุนูุงูุงุช ูุชุตูููุงุช ุงูุฑุณุงุฆู (Message Tags)

#### 31.12.1 ุฌุฏุงูู ุงูุนูุงูุงุช

```sql
-- ุฌุฏูู ุงูุนูุงูุงุช ุงููุชุงุญุฉ
CREATE TABLE chat_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- ูุนูููุงุช ุงูุนูุงูุฉ
    name VARCHAR(50) NOT NULL,
    color VARCHAR(7) DEFAULT '#3B82F6',  -- Hex color
    icon VARCHAR(50),  -- ุงุณู ุงูุฃููููุฉ
    
    -- ุงููุทุงู
    scope ENUM('system', 'company', 'personal') DEFAULT 'company',
    created_by UUID REFERENCES employees(id),
    
    -- ููุนูุงูุงุช ุงูุดุฎุตูุฉ
    owner_id UUID REFERENCES employees(id),
    
    -- ุงูุญุงูุฉ
    is_active BOOLEAN DEFAULT TRUE,
    
    created_at TIMESTAMP DEFAULT NOW()
);

-- ุงูุนูุงูุงุช ุงูุงูุชุฑุงุถูุฉ ูููุธุงู
INSERT INTO chat_tags (name, color, icon, scope) VALUES
    ('ููู', '#EF4444', 'star', 'system'),
    ('ูุชุงุจุนุฉ', '#F59E0B', 'clock', 'system'),
    ('ููุชูู', '#10B981', 'check', 'system'),
    ('ุณุคุงู', '#8B5CF6', 'question', 'system'),
    ('ูุฑุงุฑ', '#3B82F6', 'gavel', 'system'),
    ('ููุฑุฉ', '#EC4899', 'lightbulb', 'system');

-- ุฌุฏูู ุฑุจุท ุงูุนูุงูุงุช ุจุงูุฑุณุงุฆู
CREATE TABLE chat_message_tags (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID NOT NULL REFERENCES chat_messages(id) ON DELETE CASCADE,
    tag_id UUID NOT NULL REFERENCES chat_tags(id),
    
    -- ูู ุฃุถุงู ุงูุนูุงูุฉ
    tagged_by UUID NOT NULL REFERENCES employees(id),
    tagged_at TIMESTAMP DEFAULT NOW(),
    
    -- ููุงุญุธุฉ ุงุฎุชูุงุฑูุฉ
    note VARCHAR(200),
    
    UNIQUE(message_id, tag_id)
);

CREATE INDEX idx_message_tags_message ON chat_message_tags(message_id);
CREATE INDEX idx_message_tags_tag ON chat_message_tags(tag_id);
```

#### 31.12.2 ุงูุจุญุซ ุจุงูุนูุงูุงุช

```sql
-- Function: ุงูุจุญุซ ูู ุงูุฑุณุงุฆู ุจุงูุนูุงูุงุช
CREATE OR REPLACE FUNCTION search_messages_by_tags(
    p_employee_id UUID,
    p_tag_ids UUID[] DEFAULT NULL,
    p_channel_id UUID DEFAULT NULL,
    p_date_from DATE DEFAULT NULL,
    p_date_to DATE DEFAULT NULL,
    p_limit INT DEFAULT 50,
    p_offset INT DEFAULT 0
) RETURNS TABLE (
    message_id UUID,
    channel_id UUID,
    channel_name VARCHAR,
    content TEXT,
    tags JSONB,
    created_at TIMESTAMP
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        m.id AS message_id,
        m.channel_id,
        ch.name AS channel_name,
        m.content,
        (
            SELECT jsonb_agg(jsonb_build_object(
                'id', t.id,
                'name', t.name,
                'color', t.color
            ))
            FROM chat_message_tags mt
            JOIN chat_tags t ON mt.tag_id = t.id
            WHERE mt.message_id = m.id
        ) AS tags,
        m.created_at
    FROM chat_messages m
    JOIN chat_channels ch ON m.channel_id = ch.id
    JOIN chat_channel_members cm ON ch.id = cm.channel_id AND cm.employee_id = p_employee_id
    WHERE m.is_deleted = FALSE
      AND (p_tag_ids IS NULL OR EXISTS (
          SELECT 1 FROM chat_message_tags mt 
          WHERE mt.message_id = m.id AND mt.tag_id = ANY(p_tag_ids)
      ))
      AND (p_channel_id IS NULL OR m.channel_id = p_channel_id)
      AND (p_date_from IS NULL OR m.created_at::DATE >= p_date_from)
      AND (p_date_to IS NULL OR m.created_at::DATE <= p_date_to)
    ORDER BY m.created_at DESC
    LIMIT p_limit OFFSET p_offset;
END;
$$ LANGUAGE plpgsql;
```

#### 31.12.3 ูุงุฌูุฉ ุงูุนูุงูุงุช

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุงูุฑุณุงูุฉ:                                                    โ
โ                                                             โ
โ ูุงุทูุฉ: ูุญุชุงุฌ ุฅูู ุงุชุฎุงุฐ ูุฑุงุฑ ุจุดุฃู ุงูููุฑุฏ ุงูุฌุฏูุฏ            โ
โ 14:30                                                       โ
โ                                                             โ
โ ุงูุนูุงูุงุช: [๐ด ููู] [โ๏ธ ูุฑุงุฑ] [+ ุฅุถุงูุฉ ุนูุงูุฉ]              โ
โ                                                             โ
โ [ุฑุฏ] [ุชุญููู ููููุฉ] [ูุณุฎ] [โฎ]                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ุชุตููุฉ ุจุงูุนูุงูุงุช:                                            โ
โ                                                             โ
โ [๐ด ููู (12)] [โฐ ูุชุงุจุนุฉ (8)] [โ ููุชูู (45)]              โ
โ [โ ุณุคุงู (5)] [โ๏ธ ูุฑุงุฑ (3)] [๐ก ููุฑุฉ (7)]                  โ
โ                                                             โ
โ ุงูุนูุงูุงุช ุงููุฎุตุตุฉ:                                           โ
โ [๐ ูุฑุงุฌุนุฉ (2)] [๐ง ุชููู (15)] [+ ุฅูุดุงุก ุนูุงูุฉ]            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### 31.12.4 APIs ุงูุนูุงูุงุช

```yaml
# ุฅุฏุงุฑุฉ ุงูุนูุงูุงุช
GET    /api/v1/chat/tags                         - ูุงุฆูุฉ ุงูุนูุงูุงุช ุงููุชุงุญุฉ
POST   /api/v1/chat/tags                         - ุฅูุดุงุก ุนูุงูุฉ ุฌุฏูุฏุฉ
PUT    /api/v1/chat/tags/{id}                    - ุชุนุฏูู ุนูุงูุฉ
DELETE /api/v1/chat/tags/{id}                    - ุญุฐู ุนูุงูุฉ

# ุชุทุจูู ุงูุนูุงูุงุช ุนูู ุงูุฑุณุงุฆู
POST   /api/v1/chat/messages/{id}/tags           - ุฅุถุงูุฉ ุนูุงูุฉ ูุฑุณุงูุฉ
DELETE /api/v1/chat/messages/{id}/tags/{tag_id}  - ุฅุฒุงูุฉ ุนูุงูุฉ ูู ุฑุณุงูุฉ
GET    /api/v1/chat/messages/{id}/tags           - ุนูุงูุงุช ุฑุณุงูุฉ ูุนููุฉ

# ุงูุจุญุซ ุจุงูุนูุงูุงุช
GET    /api/v1/chat/search/by-tags               - ุจุญุซ ุจุงูุนูุงูุงุช
       ?tags[]={tag_id}
       &channel_id={id}
       &from={date}
       &to={date}
```

---

### 31.13 ููุฎุต ููุตุฉ ุงูุชูุงุตู ุงูุฏุงุฎูู (ููุชูู)

| ุงููููู | ุงูุนุฏุฏ | ุงูุญุงูุฉ |
|--------|-------|--------|
| **ุงูุฌุฏุงูู** | 12 ุฌุฏูู | โ |
| **Triggers** | 6 triggers | โ |
| **Functions** | 3 functions | โ |
| **Views** | 2 views | โ |
| **APIs** | 35+ ููุทุฉ ููุงูุฉ | โ |

**ุฌููุน ูุชุทูุจุงุช ููู 37 ููุชููุฉ ุจูุณุจุฉ 100%**



---

# ๐ ุงูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ (02)

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ ุนุจุฑ:
1. **APIs ุงูุฏุงุฎููุฉ** - ููุชูุงุตู ูุน ุงูุฃูุธูุฉ ุงูุฃุฎุฑู
2. **ูุธุงู ุงูุฃุญุฏุงุซ** - ููุดุฑ ูุงุณุชูุจุงู ุงูุฃุญุฏุงุซ
3. **ุชุทุจูู ุงูุฌูุงู** - ูููุฑู ุงูููุฏุงููุฉ
4. **ุงูุฅุดุนุงุฑุงุช ุงูููุฑูุฉ** - ููุชูุจููุงุช ูุงูุชุญุฏูุซุงุช

---

## ๐ก APIs ุงููุณุฌูุฉ ูู ูุธุงู ุงููุทูุฑ

ุฌููุน APIs ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุชุงุญุฉ ุนุจุฑ `/api/field/*`:

| ุงููุฌููุนุฉ | Endpoint | ุงููุตู |
|----------|----------|-------|
| ุฃูุงูุฑ ุงูุนูู | `/api/field/work-orders` | ุฅุฏุงุฑุฉ ุฃูุงูุฑ ุงูุนูู |
| ุงููุฑู | `/api/field/teams` | ุฅุฏุงุฑุฉ ุงููุฑู ุงูููุฏุงููุฉ |
| ุงูุฌูุงู | `/api/field/mobile/*` | APIs ุชุทุจูู ุงูุฌูุงู |
| ุงูุฏุฑุฏุดุฉ | `/api/field/chat/*` | ููุตุฉ ุงูุฏุฑุฏุดุฉ ุงูุฏุงุฎููุฉ |
| ุงูููุงูุน | `/api/field/locations/*` | ุชุชุจุน ุงูููุงูุน |

---

## ๐ฏ ุงูุฃุญุฏุงุซ ุงูููุดูุฑุฉ

ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ููุดุฑ ุงูุฃุญุฏุงุซ ุงูุชุงููุฉ:

```
work_order.created          - ุฅูุดุงุก ุฃูุฑ ุนูู ุฌุฏูุฏ
work_order.assigned         - ุฅุณูุงุฏ ุฃูุฑ ุนูู ููุฑูู
work_order.started          - ุจุฏุก ุชูููุฐ ุฃูุฑ ุงูุนูู
work_order.completed        - ุฅููุงู ุฃูุฑ ุงูุนูู
work_order.cancelled        - ุฅูุบุงุก ุฃูุฑ ุงูุนูู
work_order.delayed          - ุชุฃุฎุฑ ุฃูุฑ ุงูุนูู

team.checked_in             - ุชุณุฌูู ุญุถูุฑ ุงููุฑูู
team.checked_out            - ุชุณุฌูู ุงูุตุฑุงู ุงููุฑูู
team.location_updated       - ุชุญุฏูุซ ูููุน ุงููุฑูู

material.issued             - ุตุฑู ููุงุฏ ูููุฑูู
material.returned           - ุฅุฑุฌุงุน ููุงุฏ ูู ุงููุฑูู

inspection.completed        - ุฅููุงู ูุญุต
inspection.failed           - ูุดู ูุญุต
```

---

## ๐ฅ ุงูุฃุญุฏุงุซ ุงููุณุชูุจูุฉ

ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุณุชูุน ููุฃุญุฏุงุซ ุงูุชุงููุฉ:

| ุงูุญุฏุซ | ุงููุตุฏุฑ | ุงูุฅุฌุฑุงุก |
|-------|--------|---------|
| `asset.fault_detected` | ูุธุงู ุงููุฑุงูุจุฉ | ุฅูุดุงุก ุฃูุฑ ุนูู ุทุงุฑุฆ |
| `maintenance.due` | ูุธุงู ุงูุฃุตูู | ุฅูุดุงุก ุฃูุฑ ุนูู ุตูุงูุฉ |
| `customer.disconnection_requested` | ูุธุงู ุงูุนููุงุก | ุฅูุดุงุก ุฃูุฑ ูุตู |
| `customer.reconnection_requested` | ูุธุงู ุงูุนููุงุก | ุฅูุดุงุก ุฃูุฑ ุชูุตูู |
| `meter.reading_required` | ูุธุงู ุงูุนููุงุก | ุฅูุดุงุก ุฃูุฑ ูุฑุงุกุฉ |
| `inventory.material_available` | ูุธุงู ุงููุฎุฒูู | ุชุญุฏูุซ ุญุงูุฉ ุฃูุฑ ุงูุนูู |

---

## ๐ฑ ุชูุงูู ุชุทุจูู ุงูุฌูุงู

### APIs ุชุทุจูู ุงูุฌูุงู (`/api/field/mobile/*`)

```
# === ุงููุตุงุฏูุฉ ===
POST   /api/field/mobile/auth/login         - ุชุณุฌูู ุงูุฏุฎูู
POST   /api/field/mobile/auth/refresh       - ุชุฌุฏูุฏ ุงูุชููู
POST   /api/field/mobile/auth/logout        - ุชุณุฌูู ุงูุฎุฑูุฌ

# === ุงูุญุถูุฑ ===
POST   /api/field/mobile/attendance/check-in    - ุชุณุฌูู ุงูุญุถูุฑ
POST   /api/field/mobile/attendance/check-out   - ุชุณุฌูู ุงูุงูุตุฑุงู
GET    /api/field/mobile/attendance/status      - ุญุงูุฉ ุงูุญุถูุฑ

# === ุงููููุน ===
POST   /api/field/mobile/location/update    - ุชุญุฏูุซ ุงููููุน
GET    /api/field/mobile/location/history   - ุณุฌู ุงูููุงูุน

# === ุงูููุงู ===
GET    /api/field/mobile/tasks              - ูุงุฆูุฉ ููุงูู
GET    /api/field/mobile/tasks/:id          - ุชูุงุตูู ูููุฉ
POST   /api/field/mobile/tasks/:id/start    - ุจุฏุก ุงููููุฉ
POST   /api/field/mobile/tasks/:id/complete - ุฅููุงู ุงููููุฉ
POST   /api/field/mobile/tasks/:id/photos   - ุฑูุน ุตูุฑ
POST   /api/field/mobile/tasks/:id/notes    - ุฅุถุงูุฉ ููุงุญุธุงุช
POST   /api/field/mobile/tasks/:id/signature - ุงูุชูููุน ุงูุฅููุชุฑููู

# === ุงูููุงุฏ ===
GET    /api/field/mobile/materials          - ุงูููุงุฏ ุงููุฎุตุตุฉ ูู
POST   /api/field/mobile/materials/use      - ุชุณุฌูู ุงุณุชุฎุฏุงู ูุงุฏุฉ
POST   /api/field/mobile/materials/return   - ุฅุฑุฌุงุน ูุงุฏุฉ

# === ุงูุฅุดุนุงุฑุงุช ===
GET    /api/field/mobile/notifications      - ูุงุฆูุฉ ุงูุฅุดุนุงุฑุงุช
PUT    /api/field/mobile/notifications/:id/read - ุชุนููู ูููุฑูุก
```

### Push Notifications

```json
{
  "notification_types": [
    {
      "type": "new_task",
      "title": "ูููุฉ ุฌุฏูุฏุฉ",
      "body": "ุชู ุฅุณูุงุฏ ูููุฉ ุฌุฏูุฏุฉ ูู: {task_title}",
      "data": {
        "task_id": "uuid",
        "priority": "high"
      }
    },
    {
      "type": "task_reminder",
      "title": "ุชุฐููุฑ ุจูููุฉ",
      "body": "ูุฏูู ูููุฉ ูุฌุฏููุฉ ุฎูุงู ุณุงุนุฉ: {task_title}"
    },
    {
      "type": "urgent_task",
      "title": "ูููุฉ ุทุงุฑุฆุฉ",
      "body": "ูููุฉ ุทุงุฑุฆุฉ ุชุชุทูุจ ุงูุชุจุงูู ุงูููุฑู",
      "priority": "high"
    }
  ]
}
```

---

## ๐ฌ ุชูุงูู ููุตุฉ ุงูุฏุฑุฏุดุฉ ุงูุฏุงุฎููุฉ

### ุงูุฑุจุท ูุน ูุธุงู ุงููุทูุฑ

ููุตุฉ ุงูุฏุฑุฏุดุฉ ุงูุฏุงุฎููุฉ (ุงููุถุงูุฉ ูู ุงูููู 37) ุชุชูุงูู ูุน ูุธุงู ุงููุทูุฑ ุนุจุฑ:

```
# === WebSocket ===
ws://api/field/chat/connect               - ุงูุงุชุตุงู ุจุงูุฏุฑุฏุดุฉ

# === REST APIs ===
GET    /api/field/chat/conversations      - ูุงุฆูุฉ ุงููุญุงุฏุซุงุช
POST   /api/field/chat/conversations      - ุฅูุดุงุก ูุญุงุฏุซุฉ
GET    /api/field/chat/conversations/:id/messages - ุงูุฑุณุงุฆู
POST   /api/field/chat/messages           - ุฅุฑุณุงู ุฑุณุงูุฉ
PUT    /api/field/chat/messages/:id/read  - ุชุนููู ูููุฑูุก
DELETE /api/field/chat/messages/:id       - ุญุฐู ุฑุณุงูุฉ

# === ุงููุฌููุนุงุช ===
GET    /api/field/chat/groups             - ูุงุฆูุฉ ุงููุฌููุนุงุช
POST   /api/field/chat/groups             - ุฅูุดุงุก ูุฌููุนุฉ
PUT    /api/field/chat/groups/:id         - ุชุนุฏูู ูุฌููุนุฉ
POST   /api/field/chat/groups/:id/members - ุฅุถุงูุฉ ุฃุนุถุงุก

# === ุงูุญุงูุฉ ===
PUT    /api/field/chat/presence           - ุชุญุฏูุซ ุญุงูุฉ ุงูุชูุงุฌุฏ
GET    /api/field/chat/presence/:userId   - ุญุงูุฉ ูุณุชุฎุฏู
```

### ุฃุญุฏุงุซ WebSocket

```json
{
  "events": [
    "message.new",
    "message.read",
    "message.deleted",
    "user.typing",
    "user.online",
    "user.offline",
    "group.member_added",
    "group.member_removed"
  ]
}
```

---

## ๐ Webhooks ุงูุตุงุฏุฑุฉ

ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุฑุณู Webhooks ููุฃูุธูุฉ ุงูุฎุงุฑุฌูุฉ:

| ุงูุญุฏุซ | ุงููุตู | Payload |
|-------|-------|---------|
| `work_order.completed` | ุฅููุงู ุฃูุฑ ุนูู | `{work_order_id, type, result, photos}` |
| `inspection.result` | ูุชูุฌุฉ ูุญุต | `{inspection_id, result, notes}` |
| `team.location` | ูููุน ุงููุฑูู | `{team_id, lat, lng, timestamp}` |

---

## ๐ค ุชูุงูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู

ูุธุงู ุงูุนูููุงุช ุงูููุฏุงููุฉ ูุณุชููุฏ ูู ูุญุฏุฉ AI ูู ูุธุงู ุงููุทูุฑ:

### 1. ุชุญุณูู ุชูุฒูุน ุงูููุงู

```
POST /api/ai/optimize/task-assignment
{
  "tasks": [...],
  "teams": [...],
  "constraints": {
    "max_distance_km": 10,
    "skills_required": true,
    "workload_balance": true
  }
}
```

### 2. ุงูุชูุจุค ุจููุช ุงูุฅูุฌุงุฒ

```
POST /api/ai/predict/task-duration
{
  "task_type": "installation",
  "location": {...},
  "team_id": "uuid"
}
```

### 3. ุชุญููู ุฃุฏุงุก ุงููุฑู

```
GET /api/ai/analysis/team-performance
{
  "team_id": "uuid",
  "period": "monthly"
}
```

---

## ๐ ููุงููุณ ุงูุฃุฏุงุก ุงููุฑุณูุฉ ููุธุงู ุงููุทูุฑ

```sql
-- ุงูููุงููุณ ุงููุฑุณูุฉ ูู ุฏูููุฉ
INSERT INTO performance_metrics (metric_name, metric_type, metric_value, labels)
VALUES
  ('field.active_work_orders', 'gauge', 45, '{"status": "in_progress"}'),
  ('field.completed_today', 'counter', 23, '{}'),
  ('field.avg_completion_time_minutes', 'gauge', 45.5, '{}'),
  ('field.teams_online', 'gauge', 12, '{}'),
  ('field.tasks_delayed', 'gauge', 3, '{}');
```

---

## โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุชูุงูู

```sql
-- ุฅุนุฏุงุฏุงุช ุงูุชูุงูู ูุน ูุธุงู ุงููุทูุฑ
INSERT INTO integration_configs (integration_id, config_key, config_value)
VALUES
  -- ุชุทุจูู ุงูุฌูุงู
  ('field_mobile', 'push_notification_provider', 'firebase'),
  ('field_mobile', 'location_update_interval_seconds', '60'),
  ('field_mobile', 'offline_sync_enabled', 'true'),
  
  -- ุงูุฏุฑุฏุดุฉ
  ('field_chat', 'websocket_enabled', 'true'),
  ('field_chat', 'message_retention_days', '365'),
  ('field_chat', 'e2e_encryption', 'true'),
  
  -- GPS
  ('field_gps', 'tracking_enabled', 'true'),
  ('field_gps', 'geofence_alerts', 'true');
```


---

## ๐๏ธ ุงูุจููุฉ ุงูุชูููุฉ ูููุธุงู

### ูุนูููุงุช ุงููุณุชูุฏุน

| ุงูุนูุตุฑ | ุงููููุฉ |
|--------|--------|
| **ุงุณู ุงููุณุชูุฏุน** | `field-ops-system` |
| **ุงููููุฐ API** | 3004 |
| **ุงููููุฐ Web** | 4204 |
| **ุจุงุฏุฆุฉ ุงูุฌุฏุงูู** | `field_` |
| **ูุณุงุฑ API** | `/api/v1/field-ops` |

### Prisma Schema ุงูุฃุณุงุณู

```prisma
model field_teams {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  stationId   String?  @map("station_id") @db.Uuid
  leaderId    String?  @map("leader_id") @db.Uuid
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  members     field_team_members[]
  tasks       field_tasks[]
  
  @@map("field_teams")
}

model field_team_members {
  id          String   @id @default(uuid()) @db.Uuid
  teamId      String   @map("team_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  role        String   @default("member") @db.VarChar(20)
  joinedAt    DateTime @default(now()) @map("joined_at")
  
  team        field_teams @relation(fields: [teamId], references: [id])
  
  @@unique([teamId, userId])
  @@map("field_team_members")
}

model field_tasks {
  id              String    @id @default(uuid()) @db.Uuid
  taskNumber      String    @unique @map("task_number") @db.VarChar(50)
  type            String    @db.VarChar(50)
  priority        String    @default("medium") @db.VarChar(20)
  status          String    @default("pending") @db.VarChar(20)
  title           String    @db.VarChar(200)
  description     String?   @db.Text
  teamId          String?   @map("team_id") @db.Uuid
  assignedTo      String?   @map("assigned_to") @db.Uuid
  customerId      String?   @map("customer_id") @db.Uuid
  locationId      String?   @map("location_id") @db.Uuid
  latitude        Decimal?  @db.Decimal(10, 8)
  longitude       Decimal?  @db.Decimal(11, 8)
  scheduledDate   DateTime? @map("scheduled_date") @db.Date
  scheduledTime   String?   @map("scheduled_time") @db.VarChar(5)
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  notes           String?   @db.Text
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  team            field_teams? @relation(fields: [teamId], references: [id])
  visits          field_visits[]
  
  @@index([teamId])
  @@index([status])
  @@index([scheduledDate])
  @@map("field_tasks")
}

model field_visits {
  id              String    @id @default(uuid()) @db.Uuid
  taskId          String    @map("task_id") @db.Uuid
  visitNumber     Int       @map("visit_number")
  status          String    @default("pending") @db.VarChar(20)
  checkInAt       DateTime? @map("check_in_at")
  checkOutAt      DateTime? @map("check_out_at")
  checkInLat      Decimal?  @map("check_in_lat") @db.Decimal(10, 8)
  checkInLng      Decimal?  @map("check_in_lng") @db.Decimal(11, 8)
  checkOutLat     Decimal?  @map("check_out_lat") @db.Decimal(10, 8)
  checkOutLng     Decimal?  @map("check_out_lng") @db.Decimal(11, 8)
  notes           String?   @db.Text
  signature       String?   @db.Text
  photos          Json      @default("[]")
  createdAt       DateTime  @default(now()) @map("created_at")
  
  task            field_tasks @relation(fields: [taskId], references: [id])
  
  @@unique([taskId, visitNumber])
  @@map("field_visits")
}

model field_locations {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @db.VarChar(200)
  address     String?  @db.Text
  latitude    Decimal  @db.Decimal(10, 8)
  longitude   Decimal  @db.Decimal(11, 8)
  type        String   @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("field_locations")
}
```

### Environment Variables

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/electricity_management"
JWT_SECRET="field-ops-system-secret-key"
API_PORT=3004
CORE_API_URL="http://localhost:3001/api/v1"
BILLING_API_URL="http://localhost:3007/api/v1"
ASSETS_API_URL="http://localhost:3003/api/v1"
```
